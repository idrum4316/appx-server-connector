/*********************************************************************
 **
 **   server/appx-client-localos.js - Client local OS interface
 **
 **   This module contains code to process local OS requests
 **
 *********************************************************************/
function appxIsLocalReady(){return localos_session&&1==localos_session.ws.readyState}function appxsendfilehandler(e){if(appxIsLocalReady())switch(e.messagepart){case-1:var a=[],s=appx_session.currsendfile.filename
appxClearStatusMsgText(),appxSetStatusText("Saving File..."),appx_session.currsendfile.filedata=[],setTimeout(function(){var e={cmd:"appxmessage",args:hton32(s.length),handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(e))
for(var n=0;n<s.length;n++)a.push(s.charCodeAt(n))
var e={cmd:"appxmessage",args:a,handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(e))
var e={cmd:"appxmessage",args:[3,1],handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(e)),appxClearStatusMsgText(),appxSetStatusText("File Download Complete..."),setTimeout(function(){"File Download Complete..."===$("#appx-status-msg").html()&&appxClearStatusMsgText()},1e3)},1*appx_session.currsendfile.blocksreceived)
break
case 3:appx_session.currsendfile.filename=e.data.filename,appx_session.currsendfile.guid=Math.floor(1e6*Math.random()+1),appx_session.currsendfile.filedatareceived=0,appx_session.currsendfile.blocksreceived=0,appx_session.currsendfile.datalengthneeded=e.data.datalength,appx_session.currsendfile.filename.indexOf("$(")>-1?appx_session.currsendfile.filename=appx_session.parseOption(appx_session.currsendfile.filename):appx_session.currsendfile.filename=appx_session.currsendfile.filename,appx_session.currsendfile.filename.indexOf("/")==-1&&appx_session.currsendfile.filename.indexOf("\\")==-1&&(appx_session.currsendfile.filename=appx_session.parseOption("$(userHome)"+appx_session.fileseparatorchar+appx_session.currsendfile.filename)),appxClearStatusMsgText(),appxSetStatusText("Creating File:  "+appx_session.currsendfile.filename),appx_session.currsendfile.filecreated=!1,CreateFile(appx_session.currsendfile)
break
case 5:appx_session.currsendfile.blocksreceived+=1,appx_session.currsendfile.filedatareceived+=e.data.length,appxClearStatusMsgText(),appxSetStatusText("File Downloading... Received:  "+appx_session.currsendfile.filedatareceived+" Bytes of "+appx_session.currsendfile.datalengthneeded.toString()+" Needed"),AppendFile(e.data)}else if(e.messagepart!=-1){var n={cmd:"appxmessage",args:[0,0],handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(n))}}function appxsetclipboardhandler(e){var a=e.data
appxIsLocalReady()?(console.log("Setting Clipboard Data:  "+a.data),ms={cmd:"setclipboard",args:[a.data],handler:"localos_setclipboard_handler",data:null},localos_session.ws.send(JSON.stringify(ms))):createClipboardDialog(!0,e.data.data)}function appxgetclipboardhandler(e){appxIsLocalReady()?(ms={cmd:"getclipboard",args:["getclipboard"],handler:"localos_exeoscmd_handler",data:null},localos_session.ws.send(JSON.stringify(ms))):createClipboardDialog(!1)}function buildOpenCommand(e){var a=""
return a+=appx_session.globals.os.indexOf("Win")>-1?"powershell -Command \"& {start-process '"+e.replace('/"/g',"").trim()+"'}\"":appx_session.globals.os.indexOf("Mac")>-1?"open "+e:"xdg-open "+e}function buildOpenCommandDos(e){var a=""
return e.indexOf("/H")>-1&&(e=e.replace(/\/h /i,"/b ")),e.indexOf("/W")>-1&&(e=e.replace(/\/w /i,"/WAIT ")),a+=appx_session.globals.os.indexOf("Win")>-1?'start "" '+e:appx_session.globals.os.indexOf("Mac")>-1?"open "+e:"xdg-open "+e}function appxloadurlhandler(e){var a=e.data,s={},n=a.trim(),i=!1,o=null
try{var l=n.toLowerCase().trim().length
if((n.toLowerCase().substring(0,2).indexOf("/w")>-1||n.toLowerCase().substring(l-2,l).indexOf("/w")>-1)&&(n=a.replace("/w","").trim(),i=!0),appx_session.globals.os.indexOf("Win")&&n.substring(0,1).indexOf("@")>-1&&(n=n),n.substring(0,1).indexOf("@")>-1)try{s={cmd:"execoscmd",args:[n.substring(1)],handler:"localos_exeoscmd_handler",data:null},appxIsLocalReady()?localos_session.ws.send(JSON.stringify(s)):alert(appx_session.language.alerts.localCommandOSError+n)}catch(p){console.log("CharView.loadUrl("+n.substring(1)+"): Run Failed"),console.log("Run Failure Exception = "+p),console.log(p.stack)}else if(n.indexOf("$print:")>-1)try{var r=appx_session.parseOption(n.substring(7).trim())
appx_session.globals.os.indexOf("Win")>-1?r.indexOf(".txt")>-1?s={cmd:"execoscmd",args:['"'+appx_session.local_environment.currentworkingdirectory+'\\bin\\winprint.exe" '+r],handler:"localos_exeoscmd_handler",data:null}:(r.indexOf(".cfg")>-1&&(r=r.substring(r.indexOf(".cfg"),r.length),r=r.replace(/\"/g,"'"),r=r.replace(".cfg' ","")),s={cmd:"execoscmd",args:['powershell -Command "& {start-process "'+r+'" -Verb Print}"'],handler:"localos_exeoscmd_handler",data:null}):s={cmd:"execoscmd",args:['"'+appx_session.local_environment.currentworkingdirectory+'/bin/appx_print" '+r],handler:"localos_exeoscmd_handler",data:null},appxIsLocalReady()?localos_session.ws.send(JSON.stringify(s)):alert(appx_session.language.alerts.localPrintOSError+n)}catch(p){console.log("CharView.loadUrl("+n.substring(1)+"): Run Failed"),console.log("Run Failure Exception = "+p),console.log(p.stack)}else if(n.indexOf("$printSetup:")>-1)console.log("FIXME - newInstance() called"),s={cmd:"execoscmd",args:[appx_session.parseOption("$(cacheRoot)")+"\\print-dialog.exe"],handler:"localos_exeoscmd_handler",data:null},appxIsLocalReady()?localos_session.ws.send(JSON.stringify(s)):alert(appx_session.language.alerts.localOSError)
else if(n.indexOf("$display:")>-1)s={cmd:"execoscmd",args:[buildOpenCommand(appx_session.parseOption(n.substring(9)))],handler:"localos_exeoscmd_handler",data:null},appxIsLocalReady()?localos_session.ws.send(JSON.stringify(s)):alert(appx_session.language.alerts.localDisplayOSError+n)
else if(n.indexOf("$beep:")>-1){var t=$('<embed height="50" width="100" src="'+appxClientRoot+'/assets/beep.wav">').appendTo("body").hide()
setTimeout(function(){$(t).remove()},1500)}else if(n.indexOf("$play:")>-1){var d=$("<audio>")
d.attr("src",appx_session.parseOption(n.substring(6))),d.attr("autoplay","autoplay"),d.appendTo("body")}else if(n.indexOf("$setprop:")>-1){var c=n.substring(9,n.length).split("=")
appx_session.setPropEx(c[0].trim(),c[1],!1)}else if(n.indexOf("$newsession:")>-1){for(var g=n.substring(12,n.length).trim().split(" "),x={},f=0;f<g.length;f++){var u=g[f].split("=")
""!=u[0]&&(x[u[0].replace("-","")]=u[1].replace(/"/g,""))}sendappxnewsession(appx_session.host,appx_session.port,appx_session.user,appx_session.password,appx_session.screenrows,appx_session.screencols,x)}else if(n.indexOf("$(pushAndOpen")>-1||n.indexOf("$(pushAndSave")>-1&&"Edge"!=checkBrowser()&&n.indexOf(".pdf")>-1){var h=appx_session.appxCacheUrl+"/getFile/"+n.replace("$(","").replace(")","")
h=encodeURI(h)
window.open(h,"_blank")}else if(n.indexOf("$(pushAndSave")>-1||n.indexOf("$(pushAndOpen")>-1&&"Edge"==checkBrowser()){var h=appx_session.appxCacheUrl+"/getFile/"+n.replace("$(","").replace(")",""),m=null,_=n.substring(n.lastIndexOf("/")),b=new XMLHttpRequest
b.open("GET",h),b.responseType="arraybuffer",b.onload=function(){m=new Blob([b.response])
var e=appx_session.getProp("dataCachePath")+_
saveAs(m,e)},b.send()}else{var v=[]
v[0]="",o&&(v[0]=o),v[1]=n
try{s={cmd:"execoscmd",args:[buildOpenCommandDos(appx_session.parseOption(v[1]))],handler:"localos_exeoscmd_handler",data:null},appxIsLocalReady()?localos_session.ws.send(JSON.stringify(s)):(n.indexOf("http")<0&&(n="http://"+n),window.open(n,"_blank","toolbar=yes, scrollbars=yes, resizable=yes, location=yes, menubar=yes, status=yes, titlebar=yes, channelmode=yes, top=50, left=50, width="+.8*$(window).width()+", height="+.8*$(window).height()))}catch(p){console.log("CharView.loadUrl("+v[0]+" "+n+"): Run Failed"),console.log("Run Failure Exception = "+p),console.log(p.stack)}}}catch(p){console.log("appxloadurlhandler("+n+"): Bad URL, e="+p),console.log(p.stack)}}function appxreceivefilehandler(e){try{var a=e.data
if(a.length>0)if(a.indexOf("$(sendFile)")>-1){var s={cmd:"appxMongoToEngine",args:[],handler:"appxreceivefilehandler",fileName:a.substring(a.lastIndexOf("/")),data:null}
appx_session.ws.send(JSON.stringify(s))}else if(a.indexOf("$(signature)")>-1){var n=$("<div>").addClass("appxsignaturedialog").css({"z-index":2e5}),i=$("<canvas>").addClass("signaturepad")
$(n).append(i),$("body").append(n),$.each($(".appxsignaturedialog"),function(e,a){$(a).dialog({open:function(e,a){$(this).parent().addClass("appx-signature-dialog-parent").position({my:"center",at:"center",of:"#box_0"}),$(this).addClass("appx-signature-dialog"),appx_session.signaturePad=new SignaturePad($(".signaturepad")[0]),setTimeout(function(){var e=Math.max(window.devicePixelRatio||1,1)
$(".signaturepad")[0].width=$(".signaturepad")[0].offsetWidth*e,$(".signaturepad")[0].height=$(".signaturepad")[0].offsetHeight*e,$(".signaturepad")[0].getContext("2d").scale(e,e),appx_session.signaturePad.clear()},0)},close:function(){if(appx_session.signaturePadFail){var e={cmd:"appxmessage",args:[3,0],handler:"appxreceivefilehandler",data:null}
appx_session.ws.send(JSON.stringify(e))}appx_session.signaturePadFail=!0,$(this).dialog("destroy").remove()}}),$(a).dialog("open")}),$(n).append($("<input id='submitsignature' type='button' value='"+appx_session.language.buttons.submit+"'>").click(function(){function e(e){void 0!==HTMLCanvasElement.prototype.toBlob?$(".signaturepad")[0].toBlob(function(a){e(a)}):e($(".signaturepad")[0].msToBlob())}appx_session.signaturePad.isEmpty()||($("#main").block({message:"<h1>Uploading file to temporary storage, please wait...</h1>",baseZ:999999,fadeIn:0}),e(function(e){var a="signature.png"+Date.now()
uploadFileToMongo(e,a,function(){var e={cmd:"appxMongoToEngine",args:[],handler:"appxreceivefilehandler",fileName:a,data:null}
appx_session.ws.send(JSON.stringify(e)),appx_session.signaturePadFail=!1,appx_session.signaturePad.off(),$(".appxsignaturedialog").dialog("close")})}))})),$(n).append($("<input id='clearsignature' type='button' value='"+appx_session.language.buttons.clearSignature+"'>").click(function(){appx_session.signaturePad.clear()})),$(n).append($("<input id='cancelsignature' type='button' value='"+appx_session.language.buttons.cancel+"'>").click(function(){appx_session.signaturePad.off(),$(".appxsignaturedialog").dialog("close")}))}else{appx_session.currrecfile={},appx_session.currrecfile.filename=a
var s={cmd:"openfile",args:[a],mongoHost:appxConnectorHost,uid:appx_session.user,pid:appx_session.pid.trim(),port:appxConnectorMongoPort,httpPath:appxConnectorPathHttp,protocol:appxProtocol,handler:"localopenfile",data:null}
localos_session.ws.send(JSON.stringify(s))}else if(0==$(".appxfiledialog").length){var n=$("<div>").addClass("appxfiledialog").css({"z-index":2e5})
$(n).append($("<input id='fileChooser' class='non-widget' type='file'>")),$(n).append($("<input id='submitfile' type='submit'>").click(function(){$("#main").block({message:"<h1>Uploading file to temporary storage, please wait...</h1>",baseZ:999999,fadeIn:0}),appxReadBlob($(this).attr("id"),function(){var e={cmd:"appxMongoToEngine",args:[],handler:"appxreceivefilehandler",fileName:$("#fileChooser")[0].files[0].name.replace(/ /g,"_"),data:null}
appx_session.ws.send(JSON.stringify(e)),$(".appxfiledialog").dialog("close")})})),$("body").append(n),$.each($(".appxfiledialog"),function(e,a){$(a).dialog({open:function(e,a){$(this).parent().css({"z-index":2e5}),$(this).css({"z-index":2e5})},close:function(){if(0===$("#fileChooser")[0].files.length){var e={cmd:"appxmessage",args:[3,0],handler:"appxreceivefilehandler",data:null}
appx_session.ws.send(JSON.stringify(e))}$(this).dialog("destroy").remove()}}),$(a).dialog("open")})}else $("#fileChooser").val(""),$(".appxfiledialog").dialog("open")}catch(o){console.log(o),console.log(o.stack)
var s={cmd:"appxmessage",args:[3,0],handler:"appxreceivefilehandler",data:null}
appx_session.ws.send(JSON.stringify(s))}}function appxReadBlob(e,a){var s="fileopener",n=!1,i=null
if(e&&(s=e),"DnD"===s?(i=appx_session.dropEvent.dataTransfer.files,appx_session.filesUploadArray=appx_session.dropEvent.dataTransfer.files):i=$("#fileChooser")[0].files,!i.length)return void alert(appx_session.language.alerts.fileError)
i.length>1&&(n=!0)
for(var o=0;o<i.length;o++){var l=i[o]
uploadFileToMongo(new Blob([l]),l.name,a)}}function CreateFile(e){var a={cmd:"createfile",args:[e],handler:"localfilecreate",data:null}
localos_session.ws.send(JSON.stringify(a))}function AppendFile(e){if(e.length>0){var a={}
a.filename=appx_session.currsendfile.filename,a.filedata=e,a.count=++msgCount
var s={cmd:"appendfile",args:[a],handler:"localfileappend",data:null}
localos_session.ws.send(JSON.stringify(s))}}function localos_create_file_handler(e){console.log("Create File")
var a
a=e.hasOwnProperty("errno")?[3,0]:[3,1]
var s={cmd:"appxmessage",args:a,handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(s))}function fileUploadError(e){appxClearStatusMsgText(),alert('"'+e+appx_session.language.alerts.folderSelectedError),$("#main").unblock()}function createClipboardDialog(e,a){var s,n,i,o,l
e?(s=appx_session.language.tooltips.clipboardToText,n=appx_session.language.buttons.copyText,i="copyToClipboardDiv",o=appx_session.language.tooltips.clipboardTo,l="copyToClipboard"):(s=appx_session.language.tooltips.clipboardFromText,n=appx_session.language.buttons.submit,i="copyFromClipboardDiv",o=appx_session.language.tooltips.clipboardFrom,l="copyFromClipboard")
var p=$("<div>").attr("id",i),r=$('<label for="'+i+'">').addClass("clipboard").html(s),t=$('<textarea rows="10" cols="50" id="'+l+'">').addClass(i).val(a),d=$("<button>").attr("data-clipboard-target","#"+l).addClass("btn clipboard").html(n)
if(r.append("<br /><br /><br />").appendTo(p),t.appendTo(p),d.appendTo(p),p.dialog({title:o,position:{of:"#appx_main_container"},minWidth:700,height:300}),p.on("dialogclose",function(a){if(e)c.destroy()
else{var s=t.val(),n={cmd:"appxclipboard",args:[s],handler:"appxsendfilehandler",data:null}
appx_session.ws.send(JSON.stringify(n))}}),e){var c=new Clipboard(".btn")
c.on("success",function(e){e.clearSelection(),p.dialog("destroy").remove()})}else d.on("click",function(e){p.dialog("destroy").remove()})}function localos_append_file_handler(e){}var msgCount=0
