/*********************************************************************
 **
 **   server/appx-client-item.js - Client Item processing
 **
 **   This module contains code to process Appx Item screen elements.
 **
 *********************************************************************/
"use strict"
function appxitembox(a,t,e,s){for(var p=null,_=null,i=(appx_session.screencols*appx_session.screenrows,appx_session.current_show.boxes),o=0;o<i.length;o++){var n=i[o]
t>=n.begin_column&&t<=n.end_column&&a>=n.begin_row&&a<=n.end_row&&(_=n,t+s-1<=n.end_column&&a+e-1<=n.end_row&&(p=n))}return null==p&&(p=_),null!=p&&p.newbox>=0&&(p=i[p.newbox]),p}function appxcreateformatitem(a,t){var e=null,s=$("<input type='text'>")
t&&(s=t)
var p=""
s.addClass("masked"),e||(e=parseItemLongData(a.rawdata))
for(var _=e.itemdata[1][0].replace(/\_/g,"*"),i=0;i<e.itemdata[1][0].length;i++)"X"==e.itemdata[1][0][i]?_=_.replace(_[i],e.itemdata[0][0][i]):p+=e.itemdata[0][0][i]
return s.inputmask(_,{placeholder:" ",insertMode:!1,clearMaskOnLostFocus:!1}),s.val(p),s}function appxitemshandler(a){var t=!1
try{appx_session.items.length=0
for(var e=0,s=null,p=null;a.data.length>0;){if(s=null,p=null,_);var _=a.data.shift(),i=$("<div>")
switch(_.uline=appxIsUline(_),appxSetModifiableCapable(_,!1),_.maxLen=_.size_rows*_.size_cols,_.type){case ELEM_ALP_CONTIG:case ELEM_ALP_NON_CONTIG:case ELEM_ALP_SUBSTR:case ELEM_ALP_CMPRS:var o=_.digits_right,n=_.digits_left
o<0&&(o+=256),n<0&&(n+=256),_.maxLen=256*n+o
break
case ELEM_ALP_JUL_DATE:case ELEM_ALP_GREG_DATE:case ELEM_BIN_JUL_DATE:case ELEM_BIN_GREG_DATE:case ELEM_PD_JUL_DATE:case ELEM_PD_GREG_DATE:case ELEM_UNIVERSAL_DATE:p||(p=parseItemLongData(_.rawdata)),_.data=p.itemdata[0][0]}if(_.widget=new Widget(0,"",_.widget),s=_.widget.wWidgetType,s!=WIDGET_TYPE_HTML_VIEWER&&s!=WIDGET_TYPE_HTML_EDITOR&&0==appxIsModifiable(_)&&(_.data=sanitizeText(_.data,null)),_.type==ELEM_LOG&&null==s&&(s=WIDGET_TYPE_CHECK_BOX,_.widget.wWidgetType=WIDGET_TYPE_CHECK_BOX),0!=appxIsModifiable(_)||0!=appxIsModifiableCapable(_)||0!=appxIsStatus(_)||null!=s){if(appxIsModifiable(_)?(_.data=_.data.replace(/\xB6/g,"\r\n").replace(/ *$/gm,""),null==s&&2==(2&_.special)&&(s=WIDGET_TYPE_LISTBOX,_.widget.wWidgetType=WIDGET_TYPE_LISTBOX),null==s&&(s=WIDGET_TYPE_RAW_TEXT,_.widget.wWidgetType=WIDGET_TYPE_RAW_TEXT)):(_.data=_.data.replace(/\xB6/g,"<br/>").replace(/ *$/gm,""),null==s?(s=WIDGET_TYPE_LABEL,_.widget.wWidgetType=WIDGET_TYPE_LABEL):s!=WIDGET_TYPE_FILE_CHOOSER&&s!=WIDGET_TYPE_DATE_CHOOSER&&s!=WIDGET_TYPE_LISTBOX||(_.widget.wLabel=null,_.widget.wWidgetType=WIDGET_TYPE_RAW_TEXT,_.widget.wWidgetOriginalType=s,s=WIDGET_TYPE_RAW_TEXT)),"function"!=typeof appx_session.createWidgetTag[s]){var T=appx_session.createWidgetTag["default"](_.widget,i)
i=T.tag,_.widget=T.widget,s=_.widget.wWidgetType}else s===WIDGET_TYPE_DATE_CHOOSER?(T=appx_session.createWidgetTag[s](_.widget,i,_,p),i=T.tag,p=T.longdata):i=appx_session.createWidgetTag[s](_.widget,i,_)
if(null!==_.widget.wPositionX?(i.data("row",_.widget.wPositionY),i.data("col",_.widget.wPositionX)):(i.data("row",_.pos_row),i.data("col",_.pos_col)),null!==_.widget.wDragAndDrop&&i.addClass("Drop"),i.data("parent_type",WIDGET_PRNT_TYPE_ITEM),i.addClass("item_with_widget"),48==(48&_.special)?i.data("unicode",!0):i.data("unicode",!1),appxIsModifiable(_))i.addClass("input"),i.on("input change",{wx:_.widget},function(a){$(this).addClass("dirty"),appxSetStatusStateText(APPX_STATE_DIRTY),a.data.wx&&(" "!=$(this).val().slice(-1)||$(this).is("input[type=checkbox]"))&&appx_session.valueTimerStart(a.data.wx.wCommandValueAdjusted,$(this))}),i.hasClass("appx-listbox")&&i.on("keypress",{wx:_.widget},function(a){$(this).addClass("dirty"),appxSetStatusStateText(APPX_STATE_DIRTY),a.data.wx&&" "!=$(this).val().slice(-1)&&appx_session.valueTimerStart(a.data.wx.wCommandValueAdjusted,$(this))}),appxIsMasked(_)&&i.on("input keyup",{wx:_.widget},function(a){$(this).addClass("dirty"),appxSetStatusStateText(APPX_STATE_DIRTY),a.data.wx&&" "!=$(this).val().slice(-1)&&appx_session.valueTimerStart(a.data.wx.wCommandValueAdjusted,$(this))}),i.addClass("appx-modifiable"),appxIsToken(_)?s==WIDGET_TYPE_RAW_TEXT&&i.attr("maxlength",_.size_cols):_.maxLen&&i.attr("maxlength",_.maxLen)
else{if(s==WIDGET_TYPE_NONE||s==WIDGET_TYPE_RAW_TEXT||s==WIDGET_TYPE_LABEL){if(i=$("<div>"),null!==_.widget.wSepBefore&&_.widget.wSepBefore===!0&&i.addClass("sepBefore"),null!==_.widget.wSepAfter&&_.widget.wSepAfter===!0&&i.addClass("sepAfter"),s!=WIDGET_TYPE_LABEL&&i.addClass("appx-raw-text"),null!=_.widget&&_.widget.wWidgetOriginalType==WIDGET_TYPE_LISTBOX&&i.addClass("appx-listbox-originally"),_.pos_row<=appx_session.screenrows-3)if(_.size_rows>1||s!=WIDGET_TYPE_LABEL){var d=$("<div>")
_.size_rows>1?d.css("white-space","pre-wrap"):d.css("white-space","pre"),d.html(_.data).appendTo(i)}else _.type==ELEM_LOG&&(_.data="1"==_.data?"Y":"0"==_.data?"N":""),i.html(_.data)
null!==_.widget.wPositionX?(i.data("row",_.widget.wPositionY),i.data("col",_.widget.wPositionX)):(i.data("row",_.pos_row),i.data("col",_.pos_col)),null!==_.widget.wDragAndDrop&&i.addClass("Drop")}appxIsModifiableCapable(_)&&i.addClass("appx-not-modifiable")}if(appxIsUppercase(_)&&i.css("text-transform","uppercase"),appxIsModifiable(_)||s==WIDGET_TYPE_BUTTON?i.prop("disabled",!1):i.prop("disabled",!0),appxIsNullOk(_)?i.addClass("appx-nullok"):(p||(p=parseItemLongData(_.rawdata)),p&&""==p.itemdata[0][0]&&i.addClass("appx-nullok")),appxIsMasked(_)&&appxcreateformatitem(_,i),s==WIDGET_TYPE_LABEL?i.addClass("label").addClass("notranslate"):i.addClass("appxitem").addClass("notranslate").addClass("appxfield").data("row",_.pos_row).data("col",_.pos_col),s!=WIDGET_TYPE_BUTTON&&i.attr("id",addClientId("appxitem_"+_.pos_col+"_"+_.pos_row,_.widget?_.widget.wClientId:null)),i.on("focus",function(){appx_session.valueTimerStop()
var a=getClientId($(this).attr("id")).split("_")
logca("item focus: "+a[1]+"."+a[2]),appxPutCursor(a[1],a[2]),!appx_session.lastOption||"333"!==appx_session.lastOption&&333!==appx_session.lastOption||$(this).is("input[type=checkbox]")?appx_session.getProp("autoSelect")&&$(this).select():this.selectionStart=this.selectionEnd=appx_session.keyPauseLastPosition}),null===_.widget.wCommandLostFocus&&appxAttachBlur(i,"block"),appxwidgetdimensions(_,i),appxwidgetshandlerprops(_,i),appxIsToken(_)&&appxIsModifiable(_)&&(s==WIDGET_TYPE_LISTBOX||null==s)){var l=appx_session.server.replace(/\./g,"_")+"_"+appx_session.port+"_"+_.token_cacheid+"_"+_.token_app+"_"+_.token_ap_ver+"_"+_.token_cache_sig
appx_session.token_groups[_.token_group]=l,appx_session.token_cache[l]||(appx_session.token_cache.length++,appx_session.token_cache.keys.push(l),appx_session.token_cache[l]={cacheid:l,data:""},appxtokengetitem(l)||sendappxtoken(_.token_group)),i.addClass(l)}_.size_rows>1?i.css({overflow:"auto"}):null!=_.widget&&_.widget.wWidgetType==WIDGET_TYPE_SLIDER||(_.size_rows>1?i.css({overflow:"hidden","white-space":"pre-wrap"}):i.css({overflow:"hidden","white-space":"pre"})),_.uline&&i&&i.addClass("appx-uline"),_.pos_row<=appx_session.screenrows-3&&appx_session.items.push([_,i,256*_.pos_row+_.pos_col]),appxIsStatus(_)&&(appxIsStatusDb(_)&&appxSetStatusDbText(_.data),appxIsStatusAp(_)&&appxSetStatusApText(_.data),appxIsStatusVer(_)&&appxSetStatusVerText(_.data),appxIsStatusUser(_)&&appxSetStatusUserText(_.data),appxIsStatusKeymap(_)&&appxSetStatusKeymapText(_.data),appxIsStatusMode(_)&&appxSetStatusModeText(_.data),appxIsStatusEmbld(_)&&appxSetStatusEmbldText(_.data),appxIsStatusProgress(_)&&appxSetStatusProgressText(_.data),appxIsStatusMode(_)&&(t=!0)),e++}else{_.type==ELEM_LOG&&s!=WIDGET_TYPE_CHECK_BOX&&(_.data="1"==_.data?"Y":"0"==_.data?"N":"")
var r=new RowTextStruct
r.type=ROWTEXT_TYPE_ITEM,r.uline=_.uline,r.boxid=-1,r.isTitle=_.widget.wInvert,r.pos_row=_.pos_row,r.pos_col=_.pos_col,r.size_rows=_.size_rows,r.size_cols=_.size_cols,r.string=_.data,r.wordWrap=appxIsWordWrap(_),appx_session.rowtext.unshift(r),appx_session.items.push([_,null,256*_.pos_row+_.pos_col,r])}}null!==_.widget.wPositionX?(i.data("row",_.widget.wPositionY),i.data("col",_.widget.wPositionX)):(i.data("row",_.pos_row),i.data("col",_.pos_col)),48==(48&_.special)?i.data("unicode",!0):i.data("unicode",!1)}catch(E){console.log("appxitemshandler: "+E),console.log(E.stack)}0==t&&appxSetStatusModeText("")}function appxIsMasked(a){return 0!=(a.options&FLD_OPT_MASK)}function appxIsUline(a){return 0!=(a.special&FLD_SPEC_ULINE)}function appxIsModifiable(a){return(a.special&FLD_SPEC_MOD)==FLD_SPEC_MOD}function appxIsModifiableCapable(a){return(a.special&FLD_SPEC_MOD_ABLE)==FLD_SPEC_MOD_ABLE}function appxSetModifiableCapable(a,t){1==t?a.special|=FLD_SPEC_MOD_ABLE:a.special&=~FLD_SPEC_MOD_ABLE}function appxIsDLUonTabOut(a){return appxIsModifiable(a)&&appxIsScannable(a)&&0!=(a.special&FLD_SPEC_DLU_TABOUT)}function appxIsScannable(a){return appxIsModifiable(a)&&0!=(a.options&FLD_OPT_SCAN)}function appxIsStatus(a){return 0!=(a.options&FLD_OPT_STAT_BITS)}function appxIsStatusDb(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_DB}function appxIsStatusAp(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_AP}function appxIsStatusVer(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_VER}function appxIsStatusUser(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_USER}function appxIsStatusKeymap(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_KEYMAP}function appxIsStatusMsg(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_MSG}function appxIsStatusMode(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_MODE}function appxIsStatusEmbld(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_EMBLD}function appxIsStatusProgress(a){return(a.options&FLD_OPT_STAT_BITS)==FLD_OPT_STAT_PROGRESS}function appxIsDate(a){return a.type==ELEM_ALP_JUL_DATE||a.type==ELEM_ALP_GREG_DATE||a.type==ELEM_BIN_JUL_DATE||a.type==ELEM_BIN_GREG_DATE||a.type==ELEM_PD_JUL_DATE||a.type==ELEM_PD_GREG_DATE||a.type==ELEM_UNIVERSAL_DATE}function appxIsToken(a){return(a.special&FLD_SPEC_TOKEN)==FLD_SPEC_TOKEN}function appxIsWordWrap(a){return(a.special&FLD_SPEC_WORD_WRAP)==FLD_SPEC_WORD_WRAP}function appxIsUppercase(a){return 0!=(a.options&FLD_OPT_UCASE)}function appxIsNullOk(a){return 0!=(a.options&FLD_OPT_NULLOK)}function parseItemDateData(a){try{for(var t=a.itemdata[1][0].replace(/\_/g,"*"),e=0;e<a.itemdata[1][0].length;e++)"X"==a.itemdata[1][0][e]&&(t=t.replace(t[e],a.itemdata[0][0][e]))
for(var s="",p="",_="",i="",o=!0,e=0;2*e<a.itemdata[2][0].length;e++)if(i=a.itemdata[2][0].substring(2*e,2*e+2),"--"!=i)switch(e){case 0:s+=i,p+="yy"
break
case 1:s+=i,0==p.length&&(p+="y")
break
case 2:s+=i,p+="mm"
break
case 3:s+=i,p+="dd"
break
case 4:p.length>0&&(s+=" "),s+=i,_+="HH"
break
case 5:_.length>0&&(s+=":",_+=":"),s+=i,_+="mm"
break
case 6:_.length>0&&(s+=":",_+=":"),s+=i,_+="ss"
break
case 7:_.length>0&&(s+=".",_+="."),s+=i+"0",_+="l"}""==p&&(o=!1)
var n='{"value":"'+s+'","datemsk":"'+p+'","timemsk":"'+_+'"}',T=$("<input class='appxdatevalue appxitem' type='text' style='width: 100%; height: 100%'>"),d=$("<input class='appxdatepicker' type='hidden'>").val(n)
T.inputmask(t,{insertMode:!1}),T.val(a.itemdata[0])}catch(l){console.log("parseItemDateData: "+l),console.log(l.stack)}return{data:a.itemdata[0][0],hasDate:o,df:d,dv:T}}function parseItemLongData(a){var t=[]
try{t.push(91),t.push(34)
for(var e=0;e<a.length;e++)2==a[e]||1==a[e]?(2==a[e]&&(t.push(34),t.push(44),t.push(34)),1==a[e]&&(t.push(34),t.push(93),t.push(44),t.push(91),t.push(34))):0===a[e]?t.push(32):34===a[e]?(t.push(92),t.push(a[e])):t.push(a[e])
return t.push(34),t.push(93),JSON.parse('{"itemdata": ['+ab2str(t).replace(/\n/g,"\\\\n").replace(/\r/g,"\\\\r")+"]}")}catch(s){return console.log("parseItemLongData: "+s),console.log("parseItemLongData: data="+t),console.log(s.stack),t=[91,34,34,93],JSON.parse('{"itemdata": ['+ab2str(t)+"]}")}}var FLD_OPT_NULLOK=1,FLD_OPT_UCASE=2,FLD_OPT_MASK=4,FLD_OPT_SCAN=8,FLD_OPT_STAT_BITS=240,FLD_OPT_STAT_DB=16,FLD_OPT_STAT_AP=32,FLD_OPT_STAT_VER=48,FLD_OPT_STAT_USER=64,FLD_OPT_STAT_DATE=80,FLD_OPT_STAT_KEYMAP=96,FLD_OPT_STAT_MSG=112,FLD_OPT_STAT_MODE=128,FLD_OPT_STAT_EMBLD=144,FLD_OPT_STAT_PROGRESS=160,FLD_SPEC_TOKEN=2,FLD_SPEC_WORD_WRAP=4,FLD_SPEC_MOD_ABLE=8,FLD_SPEC_ULINE=8,FLD_SPEC_DLU_TABOUT=64,FLD_SPEC_MOD=128,ELEM_NONE=0,ELEM_ALP_CONTIG=1,ELEM_ALP_NON_CONTIG=2,ELEM_ALP_JUL_DATE=3,ELEM_ALP_GREG_DATE=4,ELEM_BIN=5,ELEM_BIN_JUL_DATE=6,ELEM_BIN_GREG_DATE=7,ELEM_PD_FIX=8,ELEM_PD_JUL_DATE=9,ELEM_PD_GREG_DATE=10,ELEM_LOG=11,ELEM_PD_VAR=12,ELEM_ALP_SUBSTR=13,ELEM_ALP_CMPRS=14,ELEM_UNIVERSAL_DATE=15
