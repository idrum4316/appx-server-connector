/*********************************************************************
 **
 **   server/appx-client-keys.js - Client Keyboard/Keymap processing
 **
 **   This module contains code to process Appx key events.
 **
 *********************************************************************/
function isNumericKey(e){return e.which>=48&&e.which<=57||e.which>=96&&e.which<=105}function enterAltCtrlTextBreak(e){return!(null==e||10!=e.which&&13!=e.which||"textarea"!=e.target.type||!(1==appx_session.getProp("textReverseEnterKey")&&!(e.altKey||e.ctrlKey||e.shiftKey)||0==appx_session.getProp("textReverseEnterKey")&&(e.altKey||e.ctrlKey||e.shiftKey)))}function fixKeyEvent(e){if("number"==typeof e)e={altKey:!1,ctrlKey:!1,"target.type":"",which:e}
else if(e||(e=window.event),!e)return null
return e}function fireServerInterrupt(){appx_session.serverInterrupt=!0,appx_session.ws.send(JSON.stringify({cmd:"appxmessage",args:[0,0,0,0,95,0,0,0],handler:"fireServerInterrupt",data:null}))}function sendkey(e){if(appxIsLocked())return e.preventDefault(),void e.stopPropagation()
var t=!0
if("keyup"==e.type){if(keyInitial=!0,18!=e.which)return}else if(e.altKey){if(!keyInitial)return
keyInitial=!1}if($("preferences")&&$(e.target).length>0&&$(e.target).attr("id")&&$(e.target).attr("id").indexOf("map")!==-1){switch($(e.target).val(e.which),$(e.target).attr("id")){case"mapEndKey":appx_session.setProp("mapEndKey",e.which)
break
case"mapOptionKey":appx_session.setProp("mapOptionKey",e.which)
break
case"mapTabKey":appx_session.setProp("mapTabKey",e.which)
break
default:console.log("Invalid: "+$(e.target).attr("id"))}e.preventDefault(),e.stopPropagation()}if(1===$("#appx_prefs").length&&"none"!==$("#appx_prefs").css("display")&&(e.which<48||e.which>57)&&!(e.which>=65&&e.which<=90)&&9!==e.which||void 0!==$("#jqgrid-options-dialog").css("display"))return void("none"!==$("#jqgrid-options-dialog").css("display")&&e.which==appx_session.getProp("mapEndKey")&&$(".ui-dialog-content").dialog("close"))
appxstarttimeout(),appx_session.valueTimerStart()
try{if(void 0!==e.currentTarget&&void 0!==e.currentTarget.activeElement&&$(e.currentTarget.activeElement.offsetParent).parents(".searchFilter").length>0||$("#cke_clone").length>0||void 0!==e.currentTarget&&$(e.currentTarget.activeElement).hasClass("ui-pg-input"))return
if(e=fixKeyEvent(e)){var a=OPT_NULL
if(35==e.which&&e.ctrlKey&&0==e.altKey&&0==e.shiftKey&&(fireServerInterrupt(),t=!1),appx_session.objFocus)return 10!=e.which&&13!=e.which||appxFireObjectEvent(),!0
optionTriggered>0&&(e.which==appx_session.getProp("mapOptionKey")||isNumericKey(e)||(optionTriggered=0,digits=[]))
var s=!0,i=appxGetCursorPos(),r=!1,o=1,n=$(e.target).parent()
if((38===e.which||40===e.which)&&n.hasClass("appx-scroll-act")){r=!0
var c=$(e.target).attr("id"),_=38===e.which
parseInt(c.substring(c.lastIndexOf("_")+1))!==i.row&&(o=n.height()/21)
var p
$(".appx-scroll").each(function(){$(this).css("z-index")==n.css("z-index")&&(p=$(this))})
var T=p.position().top/21,d=Math.floor(p.height()/21)+T
_?i.row-o<T&&(s=!1,appxwidgetcallback(OPT_SCROLL_DOWN)):i.row+o>d&&(s=!1,appxwidgetcallback(OPT_SCROLL_UP))}if(e.which>=37&&e.which<=40){if(e.target&&$(e.target).hasClass("appxitem")&&!r){var l="appxitem_"+i.col+"_"+i.row
l==$(e.target).attr("id")&&(s=!1)}s&&(appx_session.showCursor=!0)}if(e.which>=65&&e.which<=90&&e.altKey){var h=$(".appx-shortcut-"+e.which)
h.length>0&&h.is("button")&&(h.click(),t=!1)}else(e.altKey||18==e.which)&&(e.preventDefault(),1==$("body").hasClass("showaccesskeys")?$("body").attr("class",""):$("body").attr("class","showaccesskeys"))
if(t){switch(e.which){case 9:break
case 10:case 13:enterAltCtrlTextBreak(e)||($(".default").length>0?($(".default").click(),t=!1):void 0===e.currentTarget||!e.currentTarget.activeElement||null!=e.currentTarget.activeElement.offsetParent&&"ui-search-input"==e.currentTarget.activeElement.offsetParent.className||(a=OPT_ENTER))
break
case appx_session.getProp("mapEndKey"):t=!1,appx_session.activeDatepicker?appx_session.activeDatepicker.datepicker("hide"):a=e.ctrlKey?OPT_CAN:OPT_END
break
case 33:a=OPT_SCROLL_PREV
break
case 34:a=OPT_SCROLL_NXT
break
case 37:s&&(appx_session.keyLeft=!0,t=appxPutCursor(i.col-1,i.row),appx_session.keyLeft=!1)
break
case 38:s&&(t=appxPutCursor(i.col,i.row-o))
break
case 39:s&&(t=appxPutCursor(i.col+1,i.row))
break
case 40:s&&(t=appxPutCursor(i.col,i.row+o))
break
case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:e.ctrlKey?49==e.which||97==e.which?a=OPT_DIR_PROC_1:50!=e.which&&98!=e.which||(a=OPT_DIR_PROC_2):optionTriggered>0&&(digits.push(parseInt(e.key)),0==--optionTriggered&&(a=parseInt(digits.join("")),digits=[]),t=!1)
break
case 77:e.ctrlKey&&(a=OPT_SHOW_MSG)
break
case 112:a=OPT_HELP_ITM
break
case 113:appxSnapshotScanCursor(),a=OPT_SCAN
break
case 114:a=e.ctrlKey?OPT_SET_ATR:OPT_SLCT_KEY
break
case 115:a=OPT_PREV_IMG
break
case 116:e.ctrlKey||(a=OPT_NXT_REC)
break
case 119:t=!1,a=e.ctrlKey?OPT_CAN:OPT_END
break
case 120:a=OPT_ADD_MODE,t=!1
break
case 121:t=!1,a=e.ctrlKey?OPT_ACK_DEL:OPT_DEL_MODE
break
case 122:t=!1,a=OPT_INQ_MODE
break
case 123:t=!1,a=OPT_CHG_MODE
break
case appx_session.getProp("mapOptionKey"):0===$("#mapOptionKey").length&&(optionTriggered++,optionTriggered>3&&(optionTriggered=0),t=!1)
break
case 20102:appx_session.showoptnums=!appx_session.showoptnums,a=OPT_SHOW_OPT_NUMS}a==OPT_NULL||appx_state_last!==APPX_STATE_READY&&appx_state_last!==APPX_STATE_DIRTY||(t=!1,appxwidgetcallback(a))}}return t||(e.preventDefault(),e.stopPropagation()),t}catch(O){console.log("sendkey: "+O),console.log(O.stack)}}function SoftKey(e,t,a){this.id=e,this.text=t,this.keycode=a}function createsoftkeys(){var e=$("#appx-softkeys-container").hover({},function(){return stick||($(e).hide("slide",{},500),$("#softkeys_showhide").show("fade",{},500)),!1}),t=[{id:"f1",text:appx_session.language.buttons.help,keycode:112},{id:"f2",text:appx_session.language.buttons.scan,keycode:113},{id:"f3",text:appx_session.language.buttons.select,keycode:114},{id:"f4",text:appx_session.language.buttons.prev,keycode:115},{id:"f5",text:appx_session.language.buttons.next,keycode:116},{id:"f6",text:"F6",keycode:117},{id:"f7",text:"F7",keycode:118},{id:"f8",text:appx_session.language.buttons.end,keycode:119},{id:"f9",text:appx_session.language.buttons.add,keycode:120},{id:"f10",text:appx_session.language.buttons["delete"],keycode:121},{id:"f11",text:appx_session.language.buttons.inquire,keycode:122},{id:"f12",text:appx_session.language.buttons.change,keycode:123},{id:"enter",text:appx_session.language.buttons.enter,keycode:13},{id:"showopt",text:appx_session.language.buttons.showOptions,keycode:20102}],a=$('<button type="button">')
$(a).html("&lt;&lt; Stay Open"),$(a).attr("id","button_stick_softkeys"),$(a).click(function(){return stick=!0,!1}),$(e).append(a)
for(var s=0;s<t.length;s++){var a=$('<button type="button">')
$(a).text(t[s].text),$(a).attr("id","button_"+t[s].keycode),$(a).addClass("softkey"),$(a).click(function(){var e=this.id.replace("button_","")
return sendkey(parseInt(e)),!1}),$(e).append(a)}var a=$('<button type="button">')
$(a).html("&lt;&lt; Hide"),$(a).attr("id","button_close_softkeys"),$(a).click(function(){return stick=!1,$(e).hide("slide",{},500),$("#softkeys_showhide").show("fade",{},500),!1}),$(e).append(a)
var a=$('<button type="button">').hide()
$(a).addClass("rotate"),$(a).text("Show/Hide Soft Keys"),$(a).attr("id","softkeys_showhide"),$(a).hover(function(){return $(e).show("slide",{},500),$(this).hide("fade",{},500),!1},{}),$("body").append(a),$(e).hide()}function createappxdefaulttools(){if("true"!=appxStaticTools){var e=$("#appx-defaulttools-container").hover({},function(){return dtstick||($(e).hide("slide",{direction:"right"},500),$("#defaulttools_showhide").show("fade",{},500)),!1}),t=$('<button type="button">')
$(t).html("&lt;&lt; Stay Open"),$(t).attr("id","button_stick_defaulttools"),$(t).click(function(){return dtstick=!0,!1}),$(e).append(t)
var t=$('<button type="button">')
$(t).html("&lt;&lt; Hide"),$(t).attr("id","button_close_defaulttools"),$(t).click(function(){return dtstick=!1,$(e).hide("slide",{direction:"right"},500),$("#defaulttools_showhide").show("fade",{},500),!1}),$(e).append(t)
var t=$('<button type="button">').hide()
$(t).addClass("rotate"),$(t).text("Show/Hide Tools"),$(t).attr("id","defaulttools_showhide"),$(t).hover(function(){return $(e).show("slide",{direction:"right"},500),$(this).hide("fade",{},500),!1},{}),$("body").append(t),$(e).hide()}}var stick=!1,dtstick=!1,digits=[],keyInitial=!0,optionTriggered=0
"onhelp"in window&&(window.onhelp=function(){return!1}),createappxdefaulttools(),createsoftkeys()
var OPT_BASE=256,OPT_SCAN=OPT_BASE+1,OPT_SLCT_KEY=OPT_BASE+3,OPT_PREV_IMG=OPT_BASE+4,OPT_NXT_REC=OPT_BASE+5,OPT_ADD_MODE=OPT_BASE+9,OPT_DEL_MODE=OPT_BASE+10,OPT_INQ_MODE=OPT_BASE+11,OPT_CHG_MODE=OPT_BASE+12,OPT_REDSPL_TXT=OPT_BASE+13,OPT_KEY_ENTRY=OPT_BASE+14,OPT_SET_ATR=OPT_BASE+15,OPT_DIR_PROC_1=OPT_BASE+16,OPT_DIR_PROC_2=OPT_BASE+17,OPT_END=OPT_BASE+18,OPT_HELP_ITM=OPT_BASE+20,OPT_CAN=OPT_BASE+22,OPT_SHOW_MSG=OPT_BASE+23,OPT_HELP_OPT=OPT_BASE+24,OPT_ENTER=OPT_BASE+48,OPT_ACK_DEL=OPT_BASE+49,OPT_SCROLL_FIRST=OPT_BASE+64,OPT_SCROLL_LAST=OPT_BASE+65,OPT_SCROLL_PREV=OPT_BASE+66,OPT_SCROLL_NXT=OPT_BASE+67,OPT_SCROLL_UP=OPT_BASE+68,OPT_SCROLL_DOWN=OPT_BASE+69,OPT_TAB_IN=OPT_BASE+75,OPT_TAB_OUT=OPT_BASE+76,OPT_VALUE_CHANGED=OPT_BASE+77,OPT_DROP=OPT_BASE+79,OPT_DLU_ON_TABOUT=OPT_BASE+80,OPT_DLU_AND_TABOUT=OPT_BASE+81,OPT_SYS_BASE=2e4,OPT_WHATS_THIS=OPT_SYS_BASE+33,OPT_SHOW_OPT_NUMS=OPT_SYS_BASE+102,OPT_NULL=65535,TMNET_FEATURE2_UNICODE_ENGINE=256,TMNET_FEATURE2_CUSTOMIZABLE_TABLE_HEADERS=512,TMNET_FEATURE2_APPX64_BIT=4096,TMNET_FEATURE2_LARGE_WORK_FIELD=8192
