/*********************************************************************
 **
 **   server/appx-client-menu.js - Client Menu/Toolbar processing
 **
 **   This module contains code to process Appx Menus and Toolbars.
 **
 *********************************************************************/
function MenuTree(){this.fileMenu=null,this.userMenu=[],this.optnMenu=null,this.helpMenu=null}function MenuNode(e,n){this.label=e,this.widget=n,this.children=[]}function MenuItem(e,n){this.label=e,this.widget=n}function mGroup(e,n,t){this.menuGroup=e,this.label=n,this.widget=t,this.children=[]}function mChild(e,n,t){this.menuLabel=e,this.label=n,this.widget=t}function initializeMenu(){$("#appx-softkeys-container .toolbaritem").remove(),$("#appx-defaulttools-container .toolbaritem").remove(),appx_session.currentmenu={},appx_session.currentmenu.groupsprocessed=[],appx_session.currentmenu.groups={},appx_session.currentmenu.groupsprocessed.push("top_menu"),appx_session.menucache={},appx_session.menucache.currentmenuitems=appx_session.currentmenuitems,appx_session.menucache.currentmenu=appx_session.currentmenu,appx_session.currentmenuitems={},appx_session.currentmenuitems.all=[],appx_session.currentmenuitems.toolbar=[[],[],[]],appx_session.currentmenuitems.dropdown=[[],[],[]],appx_session.currentmenuitems.popup=[[],[],[]],appx_session.currentmenu.block={},appx_session.currentmenu.header=[]}function appxmenuhandler(e){appx_session.currentmenu.block=e,appx_session.currentmenu.header.push(new Widget(null,null,appx_session.currentmenu.block.data.headerdata)),appxmenushandler(e)}function appxmenushandler(e){var n=e.data,t=n.type[0],i=new Widget(null,null,null)
i.widgetData=e.data.headerdata
var r=i.parseDataIntoPairs()
if($.each(r,function(e,n){r[n.key]=n.value}),r.USE)switch(r.USE.trim()){case"T":appx_session.currentmenuitems.toolbar[t]=appx_session.menucache.currentmenuitems.toolbar[t],appx_session.currentmenuitems.dropdown[t]=appx_session.menucache.currentmenuitems.dropdown[t],appx_session.currentmenuitems.popup[t]=appx_session.menucache.currentmenuitems.popup[t]}else if(n.items.length>0)for(;n.items.length>0;){var a=n.items.shift()
a.widget=new Widget(null,null,a.data),appx_session.currentmenuitems.all.push(a.widget),1==a.widget.wUsageToolbar&&appx_session.currentmenuitems.toolbar[t].push(a.widget),1==a.widget.wUsagePopup&&appx_session.currentmenuitems.popup[t].push(a.widget),1==a.widget.wUsageMenu&&appx_session.currentmenuitems.dropdown[t].push(a.widget)}}function placeMenuItems(e,n,t){for(var i in n){var r=!1
for(var a in e)if(e[a].hasOwnProperty("children")&&e[a].children.hasOwnProperty(i)){e[a].children[i].children=n[i].children,t&&delete n[i],r=!0
break}r||(e[i]=n[i])}return e}function fixMenuLabelsAndGroups(e){function n(t,i,r){if(found=!1,children=t.hasOwnProperty("children"),t.hasOwnProperty(i)||children&&t.children.hasOwnProperty(i))return children?t.children[i].hasOwnProperty("children")?(t.children[i].children[r]={},t.children[i].children[r].command=e[a].wCommand,t.children[i].children[r].widget=e[a]):(t.children[i].children={},t.children[i].children[r]={},t.children[i].children[r].command=e[a].wCommand,t.children[i].children[r].widget=e[a]):t[i].hasOwnProperty("children")?(t[i].children[r]={},t[i].children[r].command=e[a].wCommand,t[i].children[r].widget=e[a]):(t[i].children={},t[i].children[r]={},t[i].children[r].command=e[a].wCommand,t[i].children[r].widget=e[a]),!0
for(var l in t)"widget"!=l&&(found=n(t[l],i,r))
return found}function t(e){for(var n in e)children=e[n].hasOwnProperty("children"),widget=e[n].hasOwnProperty("widget"),widget&&e[n].widget.wVisible===!1?delete e[n]:children&&t(e[n].children)}try{for(var i={},r={},a=0;a<e.length;a++){var l=e[a].wLabel
if(e[a].wGroupName&&""!=e[a].wGroupName){var s=e[a].wGroupName,o=!1,d=!1
o=n(i,s,l),o||(d=n(r,s,l)),o||d||(r[s]={},r[s].autoCreate=!0,r[s].children={},r[s].children[l]={},r[s].children[l].command=e[a].wCommand,r[s].children[l].widget=e[a])}else i[l]={},i[l].autoCreate=!0,i[l].command=e[a].wCommand,i[l].widget=e[a]}r=placeMenuItems(r,r,!0),i=placeMenuItems(i,r,!1),t(i)
for(var p in i)if(i[p].autoCreate===!0&&(!i[p].hasOwnProperty("children")||jQuery.isEmptyObject(i[p].children))&&null!=i[p].widget){var u=i[p].widget.wMenuUse
i.hasOwnProperty(u)||(i[u]={},i[u].children={}),i[u].children[p]=i[p],delete i[p]}}catch(c){console.log(c),console.log(c.stack)}return i}function buildMenuHTMLtree(e,n){if(null==e||!e.hasOwnProperty("children")||void 0!==e.widget&&null!==e.widget.wVisible&&e.widget.wVisible===!1)return""
var t=" class='appx-menu-item'"
e.widget&&e.widget.wEnabled===!1&&(t=" class='appx-menu-item appx-nav-disabled'")
var i=null==e.widget||e.hasOwnProperty("children")?"":" onclick='appxwidgetcallback("+e.widget.wCommand+")'"
if(n)var r="<li"+i+t+">"+(null==e.widget?e.label:e.widget.wLabel)+"<ul>"
else{var r
if(null!=e.widget){var a=e.widget.wShortcut,l=e.widget.wLabel,s=l.replace(a,"<span class='accesskeyunderline'>"+a+"</span>")
r=null!=a?"<li"+i+t+"> <a href='#' accesskey='"+a+"' class='hasSub'>"+s+"</a><ul>":"<li"+i+t+"> <a href='#' class='hasSub'>"+l+"</a><ul>"}else r="<li"+i+m+"> <a href='#' class='hasSub'>"+e.label+"</a><ul>"}for(var o in e.children){var d=e.children[o]
if(d.hasOwnProperty("children"))r+=buildMenuHTMLtree(d,!1)
else{var i=null,p=null,u=!1,c=!1,w=!0,m="appx-menu-item",h=""
if(d.widget){appxWidgetCheckSelected(d.widget),1==d.widget.wSelected&&(m="appx-menu-item appx-menu-item-selected"),d.widget.wEnabled===!1&&(h="appx-nav-disabled")
var w=null==d.widget.wVisible||d.widget.wVisible
i=" onclick='appxwidgetcallback("+d.widget.wCommand+")'",p=d.widget.wLabel,u=null!=d.widget.wSepBefore,c=null!=d.widget.wSepAfter,i=0==d.widget.wEnabled?"":i}else p=d.wLabel
if(w){var g=$("<li"+i+">"),f=$("<a href='#'>")
f.text(p),g.addClass(h),f.addClass(m),""!==h&&f.css({color:"#aaa"}),d.widget&&appxwidgetshandlerprops(d.widget,f),$(g).append(f),u&&$(g).addClass("sepbefore"),c&&$(g).addClass("sepafter"),d.widget.wIconEnabled&&($(f).addClass(AppxResource.load(d.widget.wIconEnabled)),$(f).addClass("appx-hasbg")),r+=$(g)[0].outerHTML}}}return r+="</ul></li>"}function buildMenuHTML(e){var n=$("#appx-main-nav"),t="",i=["File","Options","Help"]
null==topMenu&&(topMenu=$("<ul>").attr("id","topMenu").appendTo(n))
for(var r in e){var a=!0
e[r].hasOwnProperty("widget")||(e[r].label=r)
for(var l=0;l<i.length;l++)i[l]==r&&(a=!1)
a&&("Process"===r||"Application"===r||"System"===r?i.splice(1,0,r):i.splice(i.length-2,0,r))}for(var l=0;l<i.length;l++)t+=buildMenuHTMLtree(e[i[l]],!0)
$(topMenu).append(t)}function popupMenuCallback(e){return function(){appxwidgetcallback2(e)}}function popupMenuChildren(e,n){for(var t in e){var i=e[t],r=null
if(i.widget&&i.widget.wSepBefore===!0&&(n[t+"sepB"]={name:"-----------------------------"}),n[t]={name:t},i.widget&&i.widget.wSepAfter===!0&&(n[t+"sepA"]={name:"-----------------------------"}),i.widget&&i.widget.wIconEnabled&&(r=AppxResource.load(i.widget.wIconEnabled)),e[t].hasOwnProperty("command")){var a=e[t].command.toString()
n[t].callback=popupMenuCallback(a),r&&(n[t].icon=r)}e[t].hasOwnProperty("children")&&(n[t].items={},popupMenuChildren(e[t].children,n[t].items))}}function buildPopupMenuHTML(e){appx_session.currentmenuitems.popupItems={}
var n=appx_session.currentmenuitems.popupItems
if(e.hasOwnProperty(null)){var t={}
t[null]=e[null]
for(var i in e)null!==i&&(t[i]=e[i])
e=t}for(var i in e)e[i].hasOwnProperty("children")&&popupMenuChildren(e[i].children,n)}function createDropDownMenu(){$("ul#topMenu").empty()
for(var e=[],n=["Process","Application","System"],t=2;t>=0;t--){for(var i=appx_session.currentmenuitems.dropdown[t],r=0;r<i.length;r++)i[r].wMenuUse=n[t]
e=e.concat(i)}e.length>0&&buildMenuHTML(fixMenuLabelsAndGroups(e))}function createPopupMenu(){for(var e=[],n=2;n>=0;n--)e=e.concat(appx_session.currentmenuitems.popup[n])
e.length>0&&buildPopupMenuHTML(fixMenuLabelsAndGroups(e))}function createToolbarMenu(){for(var e=[],n=2;n>=0;n--)for(var t=(appx_session.currentmenuitems.toolbar[n],0);t<appx_session.currentmenuitems.toolbar[n].length;t++){var i=appx_session.currentmenuitems.toolbar[n][t]
i.aOrder=t,i.wIconEnabled&&e.push(i)}e.sort(function(e,n){return e.wGroupName<n.wGroupName?-1:e.wGroupName>n.wGroupName?1:e.aOrder-n.aOrder})
var r={over255:[],under256:[]}
for($("#toolbar").empty();e.length>0;){var a={}
a.widget=e.shift()
var l=null==a.widget.wVisible||a.widget.wVisible
if(l){var s=$("<div>")
a.widget.wSepBefore&&a.widget.wSepAfter?s.addClass("appx-sep-before appx-sep-after"):a.widget.wSepBefore?s.addClass("appx-sep-before"):a.widget.wSepAfter&&s.addClass("appx-sep-after"),a.widget.wShortLabel&&$(s).html('<span class="appx-toolbar-label">'+a.widget.wShortLabel.trim()+"</span>")
var o=AppxResource.load(a.widget.wIconEnabled)
$(s).addClass("appxitem"),$(s).addClass("toolbaritem"),$(s).addClass(o)
var d=null==a.widget.wEnabled||a.widget.wEnabled
if(0==d?$(s).addClass("tbdisabled"):$(s).click(function(){appxwidgetcallback(this.id)}),null!==a.widget.wColorBg&&$(s).css("background-color",a.widget.wColorBg),$(s).attr("id",addClientId(a.widget.wCommand,a.widget.wClientId)),a.widget.wTooltip?($(s).prop("title",a.widget.wTooltip),$(s).tooltip({content:function(){return"function"==typeof this.title?this.title():""}})):a.widget.wLabel&&($(s).prop("title",a.widget.wLabel),$(s).tooltip({content:function(){return"function"==typeof this.title?this.title():""}})),a.widget.wCommand>255){256==a.widget.wcommand&&console.log("Creating delete")
var p=$(s).clone()
$(p).attr("id",addClientId("sk_"+a.widget.wCommand,a.widget.wClientId)),$(p).css({"background-color":"transparent"}),$(p).click(function(){var e=getClientId(this.id).replace("sk_","")
appxwidgetcallback(e)}),r.over255.push(p)}else r.under256.push(s)}}for(var t=0;t<r.over255.length;t++)$("#toolbar").append(r.over255[t])
for(var t=0;t<r.under256.length;t++)$("#toolbar").append(r.under256[t])}var menugroups=[],menulabels=[],menuitems=[],menu={},menu2={},topMenu=null
