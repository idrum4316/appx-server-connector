/*********************************************************************
 **
 **   server/appx-client-resource.js - Client Resource processing
 **
 **   This module contains code to process client resources.
 **
 *********************************************************************/
function AppxResource(){}AppxResource.cache={},AppxResource.sendHold=[],AppxResource.handler=function(e){AppxResource.sendHeld()
var s=(JSON.stringify(e),ab2str(e.data.cacheid).trim()),a=appx_session.pendingResources[s]
a?delete appx_session.pendingResources[s]:a=ab2str(e.data.cacheid).trim(),appx_session.pendingResources.length--
var p=cleanClassName(appx_session.server+"_"+appx_session.port+"_"+ab2str(e.data.ap).trim()+"_"+ab2str(e.data.ver).trim()+"_"+a.trim())
try{if(e.data.len>0){var n=e.data.data
if(1==e.data.loctype){for(var t=e.data.data.length-1;t>=0&&0==e.data.data[t];)e.data.data[t]=32,t--
var r=ab2str(e.data.data).trim()
r.indexOf("/getResource/")!=-1&&(r=appx_session.appxCacheUrl+r),AppxResource.cache[p]=r}else{var r=window.URL.createObjectURL(new Blob([n]))
8==a.length&&(AppxResource.cache[p]=r)}}else if(10==e.data.state)var r=""
else var r=""+appxClientRoot+"/images/missing.png"}catch(o){if(console.log("image exception 1 = "+o),console.log(o.stack),10==e.data.state)var r=""
else var r=""+appxClientRoot+"/images/missing.png"}if(0===Object.getOwnPropertyNames(CKEDITOR.instances).length&&0===appx_session.pendingResources.length&&appxApplyStylesEditor(),10==e.data.state)0==appx_session.pendingResources.length&&0===appx_session.pendingTables&&(appxSetStatusStateText(APPX_STATE_READY),screenflipped||appxshowscreen())
else try{img=new Image,img.src=r,appx_session.image_cache.hasOwnProperty(p)&&(appx_session.image_cache[p].url=r,img.onload=applyimage(p)),0==Math.abs(appx_session.current_show.curraction[0]&M_WAIT)&&0==appx_session.pendingResources.length&&sendappxshow(OPT_NULL,[])}catch(o){console.log("appx-client-resource.js AppxResource.handler() failed to load "+p+" image:"+o),console.log(o.stack),applyimage(null)}},AppxResource.load=function(e){var s=!0,a=e.split("."),p=a[3].split(","),n=appx_session.image_cache,t=parseInt("0x"+p[0]),r=cleanClassName(appx_session.server+"_"+appx_session.port+"_"+a[0].replace("#","")+"_"+a[1]+"_"+a[2]),o=r+a[5].split(",")[0]
return n[r]&&n[r].cacheid===o?r:(n[r]?s=!1:(n.length++,n.keys.push(r)),n[r]={cacheid:o,url:"",ctx:t,blob:null,wIcon:e},AppxResource.cache[r]&&s?(n[r].url=AppxResource.cache[r],r):(AppxResource.send(e),r))},AppxResource.sendHeld=function(e){if(AppxResource.sendHold.length>0){var s=AppxResource.sendHold.shift()
appx_session.ws.send(JSON.stringify(s))}},AppxResource.send=function(e){if(!(e.indexOf("BV8P5XTB")>-1)){var s=e.split(",")
if(3==s.length){var a=e,p=s[0].split("."),n=s[2].split(".")
p[2].length>8&&(a=p[0]+"."+p[1]+"."+n[0]+"."+p[3]+","+s[1]+","+s[2]),appx_session.pendingResources[n[0]]=p[2],appx_session.pendingResources.length++
var t={cmd:"appxresource",args:a,handler:"appxresourcehandler",data:null}
AppxResource.sendHold.push(t)}}}
