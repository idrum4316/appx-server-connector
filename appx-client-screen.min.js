/*********************************************************************
 **
 **   server/appx-client-screen.js - Client Screen processing
 **
 **   This module contains code to process client resources.
 **
 *********************************************************************/
"use strict"
function getInputElement(e){return $(e).hasClass("appxdatefield")&&$(e).find(".appxdatevalue")&&(e=$(e).find(".appxdatevalue")),e}function setInputFocus(e){$(e).hasClass("appxdatefield")&&$(e).find(".appxdatevalue")&&(e=$(e).find(".appxdatevalue")),e.focus()}function appxmsgshandler(e){appx_session.msgs=[]
for(;e.data.length>0;){var a=e.data.shift()
if(a.txtlen>0&&a.txtval.indexOf("Building Scan List")<0){var s=$("<span>").html(a.txtval)
switch(s.addClass("status-msg"),a.severity){case 0:s.addClass("status-msg-info"),appxloadurlhandler({data:"$messagebeep:"})
break
case 1:s.addClass("status-msg-warning"),appxloadurlhandler({data:"$warningbeep:"})
break
case 2:s.addClass("status-msg-error"),appxloadurlhandler({data:"$errorbeep:"})
break
case 3:s.addClass("status-msg-cancel"),appxloadurlhandler({data:"$cancelbeep:"})}appx_session.msgs.push(s)}}}function applymessages(){for(var e=$("<div>"),a=0;a<appx_session.msgs.length;a++){var s=appx_session.msgs[a]
a>0&&e.append("<br>"),e.append(s)}$("#appx-status-msg").html(e)}function appxFindBoxIdx(e,a,s,t,n){for(var o=0,p=appx_session.current_show.boxes,r=0;r<p.length;r++){var i=p[r]
a>=i.begin_column&&a<=i.end_column&&e>=i.begin_row&&e<=i.end_row&&e+s-1<=i.end_row&&a+t-1<=i.end_column&&(1==n||0==appxIsScroll(i)&&0==appxIsScrollReg(i))&&(o=r)}return o}function appxfindbox(e,a,s,t,n){for(var o=null,p=appx_session.current_show.boxes,r=0;r<p.length;r++){var i=p[r]
a>=i.begin_column&&a<=i.end_column&&e>=i.begin_row&&e<=i.end_row&&e+s-1<=i.end_row&&a+t-1<=i.end_column&&(1==n||0==appxIsScroll(i)&&0==appxIsScrollReg(i))&&(o=i)}return o}function applyimage(e){if(null!=e){var a=appx_session.image_cache[e].url,s=appx_session.image_cache[e].ctx
switch(s){case 4:case 5:$("#screenBuf ."+e+"_imgRO").attr("srcRO",a)
break
case 7:$("#screenBuf ."+e).css({"background-image":"url('"+a+"')"})
break
default:var t="#screenBuf ."
0===$("#screenBuf").children().length&&(t="#appx_main_container ."),$(t+e+"_pic").css({"background-image":"url('"+a+"')"}),$(t+e+"_ico").css({"background-image":"url('"+a+"')"}),$(t+e+"_img").attr("src",a),a.indexOf("./images/missing.png")!=-1&&$("."+e+"_img").addClass("appx-image-missing"),$(t+"context-menu-icon-"+e).css({"background-image":"url('"+a+"')","background-repeat":"no-repeat","background-size":"auto 90%","margin-left":"10px"}),$("#topMenu ."+e).css({"background-image":"url('"+a+"')"}),$("#appx-toolbar ."+e).css({"background-image":"url('"+a+"')"})}}0==appx_session.pendingResources.length&&0===appx_session.pendingTables?(appxSetStatusStateText(APPX_STATE_READY),screenflipped||appxshowscreen()):appxSetStatusStateText(APPX_STATE_IMAGES)}function applystyles(){try{if(appx_session.applyStylesCount++,appx_session.image_cache)for(var e=0;e<appx_session.image_cache.keys.length;e++){var a=appx_session.image_cache.keys[e]
applyimage(a)}if(appx_session.applyStylesCount>1)return
appxApplyStylesCheckbox(),appxApplyStylesColorPicker(),appxApplyStylesDate(),0===appx_session.pendingResources.length&&appxApplyStylesEditor(),appxApplyStylesHtmlViewer(),appxApplyStylesTable(),appxApplyStylesTitleButtons(),appxApplyStylesSlider(),appxApplyStylesSignature()}catch(s){console.log("applystyles: "+s),console.log(s.stack)}}function appxApplyStylesSignature(){try{$(".signature").click(function(){appx_session.signaturePadID=$(this).attr("id")
var e=$("<div>").addClass("appxsignaturedialog").css({"z-index":2e5}),a=$("<canvas>").addClass("signaturepad")
$(e).append(a),$("body").append(e),$.each($(".appxsignaturedialog"),function(e,a){$(a).dialog({open:function(e,a){$(this).parent().addClass("appx-signature-dialog-parent").position({my:"center",at:"center",of:"#box_0"}),$(this).addClass("appx-signature-dialog"),appx_session.signaturePad=new SignaturePad($(".signaturepad")[0]),setTimeout(function(){var e=Math.max(window.devicePixelRatio||1,1)
$(".signaturepad")[0].width=$(".signaturepad")[0].offsetWidth*e,$(".signaturepad")[0].height=$(".signaturepad")[0].offsetHeight*e,$(".signaturepad")[0].getContext("2d").scale(e,e),appx_session.signaturePad.clear()},0)},close:function(){appx_session.signaturePadID=null,this.remove()}}),$(a).dialog("open")}),$(e).append($("<input id='submitsignature' type='button' value='"+appx_session.language.buttons.submit+"'>").click(function(){function e(e){void 0!==HTMLCanvasElement.prototype.toBlob?$(".signaturepad")[0].toBlob(function(a){appx_session.sigBlob=a,e(a)}):e($(".signaturepad")[0].msToBlob())}appx_session.signaturePad.isEmpty()||($("#main").block({message:"<h1>Uploading file to temporary storage, please wait...</h1>",baseZ:999999,fadeIn:0}),e(function(e){var a="signature.png"+Date.now()
uploadFileToMongo(e,a,function(){$("#"+appx_session.signaturePadID).val("$(sendFile)\\"+a),$("#"+appx_session.signaturePadID).addClass("appxitem dirty"),appx_session.signaturePad.off(),$(".appxsignaturedialog").dialog("close")})}))})),$(e).append($("<input id='clearsignature' type='button' value='"+appx_session.language.buttons.clearSignature+"'>").click(function(){appx_session.signaturePad.clear()})),$(e).append($("<input id='cancelsignature' type='button' value='"+appx_session.language.buttons.cancel+"'>").click(function(){appx_session.signaturePad.off(),$(".appxsignaturedialog").dialog("close")}))})}catch(e){console.log("Signature Pad Error: "+e),console.log(e.stack)}}function appxApplyStylesTitleButtons(){$.each($("#screenBuf .appx-title-button-help, #appx-toolbar .appx-title-button-help"),function(e,a){0===$(a).parents(".appx-active-box").length&&$(a).prop("disabled",!0),$(a).click(function(e){$(".appx-active-box").addClass("appx-help-cursor"),e.preventDefault(),appx_session.processhelp=!0,$.each($(".appx-active-box .button"),function(e,a){$(a).addClass("appx-help-cursor")}),$.each($(".appx-active-box .appxfield"),function(e,a){$(a).addClass("appx-help-cursor"),$(a).click(function(e){var a=$(this).data("col"),s=$(this).data("row")
a&&s&&(appxPutCursor(a,s),appx_session.processhelp=!1,appxwidgetcallback(OPT_HELP_ITM))})})})}),$.each($("#screenBuf .appx-title-button-ok"),function(e,a){0===$(a).parents(".appx-active-box").length&&$(a).prop("disabled",!0),$(a).click(function(e){e.preventDefault(),appxwidgetcallback(OPT_ENTER)})}),$.each($("#screenBuf .appx-title-button-close"),function(e,a){0===$(a).parents(".appx-active-box").length&&$(a).prop("disabled",!0),$(a).click(function(e){e.preventDefault(),appxwidgetcallback(OPT_END)})})}function appxApplyStylesCheckbox(){try{var e=checkBrowser()
$.each($(".checkbox-label input[type=checkbox]"),function(a,s){var t=$(s).parent()
if($(s).attr("disabled"))"Edge"==e||"IE"==e||$(s).addClass("disabled").removeAttr("disabled").keypress(function(e){e.preventDefault()}).click(function(e){e.preventDefault()}),$(s).parent().hasClass("checkbox-label")&&$(s).parent().keypress(function(e){e.preventDefault()}).click(function(e){e.preventDefault()})
else{var n=$(s)
switch(n.attr("value")){case"Y":case"1":n.data("checked",2),n.prop("indeterminate",!1),n.prop("checked",!0),n.val("Y")
break
case"N":case"0":n.data("checked",0),n.prop("indeterminate",!1),n.prop("checked",!1),n.val("N")
break
default:n.data("checked",1),n.prop("indeterminate",!0),n.prop("checked",!1),n.val(" ")}$(s).data("checked",$(s).checked).click(function(e){var a=$(this),s=$(this).parent()
switch(0==a.data("checked")&&0==s.hasClass("appx-nullok")&&a.data("checked",1),a.data("checked")){case 0:a.data("checked",1),a.prop("indeterminate",!0),a.val(" "),a.change()
break
case 1:a.data("checked",2),a.prop("indeterminate",!1),a.prop("checked",!0),a.val("Y")
break
default:a.data("checked",0),a.prop("indeterminate",!1),a.prop("checked",!1),a.val("N")}s.data("checked",a.data("checked")),s.prop("indeterminate",a.prop("indeterminate")),s.prop("checked",a.prop("checked")),s.val(a.val()),s.addClass("dirty"),1==a.prop("indeterminate")&&a.change()}),t.keypress(function(e){var a=$(this).children("input[type=checkbox]"),s=a.val(),t=$(this)
110==e.keyCode||78==e.keyCode?(a.data("checked",0),a.prop("indeterminate",!1),a.prop("checked",!1),a.val("N")):121!=e.keyCode&&89!=e.keyCode||(a.data("checked",2),a.prop("indeterminate",!1),a.prop("checked",!0),a.val("Y")),t.data("checked",a.data("checked")),t.prop("indeterminate",a.prop("indeterminate")),t.prop("checked",a.prop("checked")),t.val(a.val()),t.addClass("dirty"),a.val()!==s&&a.change()})}})}catch(a){console.log("appxApplyStylesCheckbox: "+a),console.log(a.stack)}}function appxApplyStylesColorPicker(){try{$.each($("#screenBuf .appxcolorpicker"),function(e,a){$(a).parent().width($(a).parent().width()+2*appx_session.colWidthPx-2),$(a).colpick({layout:"hex",submit:!0,colorScheme:"light",onChange:function(e,a,s,t,n){$(t).css("border-color","#"+a),n||$(t).val(a)},onSubmit:function(e,a,s,t,n){$(t).parent().find("input").css({"border-color":"#"+a,"background-color":"#"+a}),n||$(t).parent().find("input").val(a),$(t).colpickHide()}}).keyup(function(){$(this).colpickSetColor(this.value)}),$(a).parent().find("img").colpick({layout:"hex",submit:!0,colorScheme:"light",onChange:function(e,a,s,t,n){$(t).parent().find("input").css("border-color","#"+a),n||$(t).parent().find("input").val(a)},onSubmit:function(e,a,s,t,n){$(t).parent().find("input").css({"border-color":"#"+a,"background-color":"#"+a}),n||$(t).parent().find("input").val(a),$(t).colpickHide()}})})}catch(e){console.log("appxApplyStylesColorPicker: "+e),console.log(e.stack)}}function appxApplyStylesDate(){try{$.each($("#screenBuf .appxdatefield"),function(e,a){$(a).width($(a).width()+2.5*appx_session.colWidthPx)
var s=$(a).find(".appxdatevalue").first()
s.css({"font-size":appx_session.basefontsize+"px"})
var t=$(a).find(".appxdatepicker").first(),n=JSON.parse(t.val()),o={beforeShow:function(e,a){appx_session.activeDatepicker=$(this)},buttonImage:""+appxClientRoot+"/images/calendar.gif",buttonImageOnly:!0,changeMonth:!0,changeYear:!0,buttonText:"",dateFormat:n.datemsk,onClose:function(e,a){var s=APPX.DateFormatter2(e,a.settings.dateFormat,a.settings.timeFormat),t=$(this).closest(".appxitem").attr("id").split("_")
sendappxdate(parseInt(t[2]),parseInt(t[1]),s)},showButtonPanel:!0,showOn:"button",timeFormat:n.timemsk,yearRange:"1000:3000"}
t.datepicker(o),t.val(n.value),$(a).find("img").css({position:"absolute",right:"2px",top:"2px","z-index":1e5}).click(function(){appx_session.activeDatepicker=$(this)})})}catch(e){console.log("appxApplyStylesDate: "+e),console.log(e.stack)}}function appxApplyStyleEditor(e,a){try{var s=[]
if(a){if($(":data(editorConfig)").each(function(){$(this).data().editorConfig===e&&(s=$(this))}),0===s.length)return}else s[0]=e
for(var t=0;t<s.length;t++){var n=$(s[t])
if(n.attr("id").indexOf("stale")!==-1)return
n.removeClass("ckeditor")
var o=n.css("left"),p=n.css("top"),r=n.css("width"),i=n.css("height")
if(o=parseInt(o.substring(0,o.length-2)),p=parseInt(p.substring(0,p.length-2)),r=parseInt(r.substring(0,r.length-2)),i=parseInt(i.substring(0,i.length-2)),i<=5*appx_session.rowHeightPx||"no"==n.attr("decoration")){var l={}
l.customConfig=AppxResource.cache[n.data("editorConfig")],void 0===l.customConfig&&(l.customConfig="../custom/appx-ckeditor-config.js"),l.wordcount={showParagraphs:!1,showWordCount:!1,showCharCount:!0,countSpacesAsChars:!0,countHTML:!0,countLineBreaks:!0,maxWordCount:-1,maxCharCount:n.attr("maxlength"),maxParagraphs:-1,pasteWarningDuration:0},l.width=r,l.height=i,l.removePlugins=["toolbar","clipboard","pastetext","pastetools","tableselection","widget","uploadwidget","uploadimage","pastefromword","pastefromgdocs"],"disabled"==n.attr("disabled")&&(l.removePlugins.push("elementspath"),l.removePlugins.push("wordcount"),l.resize_enabled=!1)
var c=CKEDITOR.replace(n.attr("id"),l)
n.attr("name",c.name)
var d=t
c.on("instanceReady",function(){this.ui.contentsElement.clientHeight=i,$("#cke_"+$(s[d]).attr("id")).find("iframe").attr("title",""),$("#cke_"+$(s[d]).attr("id")).css({position:"absolute",top:p+"px",left:o+"px","z-index":$(s[d]).css("z-index")})
var e=$("#cke_"+$(s[d]).attr("id")+" .cke_bottom")
e&&e.css({display:"none"}),this.resize(r,i,!0)}),c.on("paste",function(e){validateInputText(e.data.dataValue,n.data("unicode"))}),c.on("notificationHide",function(e){var a=document.querySelector("div.ui-tooltip")
null!=a&&a.remove()}),c.on("key",function(e){var a=e.data.domEvent.$
if(a.which>=37&&a.which<=40)e.data.domEvent.stopPropagation()
else if(10!=a.which&&13!=a.which||null!=e.editor.element.$.getAttribute("disabled")){var s=sendkey(a)
0==s&&e.cancel()}else e.data.domEvent.stopPropagation()}),c.resetDirty(),n.addClass("button_cke")
var u=$("<button>")
u.attr("id","CKE_Button"),u.val("a"),u.text("a"),u.click(function(){var e=n,a=i,s=r
s<600&&(s=600),a=5*a>(appx_session.screenrows-3)*appx_session.rowHeightPx?(appx_session.screenrows-3)*appx_session.rowHeightPx:5*a
var t={}
t.customConfig=AppxResource.cache[e.data("editorConfig")],void 0===t.customConfig&&(t.customConfig="../custom/appx-ckeditor-config.js"),t.wordcount={showParagraphs:!1,showWordCount:!1,showCharCount:!0,countSpacesAsChars:!0,countHTML:!0,countLineBreaks:!0,maxWordCount:-1,maxCharCount:e.attr("maxlength"),maxParagraphs:-1,pasteWarningDuration:0},t.width=s,t.baseFloatZIndex=1000001
var o=e.clone(),p=$("<div>")
p.hide().appendTo(e.parent()),o.hide().appendTo(p),o.css("height",a+"px"),o.attr("id","clone_"+e.attr("id"))
var l=CKEDITOR.replace(o.attr("id"),t)
o.attr("name",l.name),l.on("instanceReady",function(){this.setData(c.getData()),$("#cke_"+o.attr("id")).find("iframe").attr("title",""),$("#cke_"+o.attr("id")).css({position:"absolute","z-index":o.css("z-index")}),setTimeout(function(){l.resize(s,a,!1)},0)}),l.on("paste",function(a){validateInputText(a.data.dataValue,e.data("unicode"))}),l.resetDirty(),e.hide(),p.dialog({title:"HTML EDITOR",position:{of:"#appx_main_container"},minWidth:s+30,height:a+130,modal:!0,closeOnEscape:!1,buttons:{Ok:function(){e.val(l.getData()),c.setData(l.getData()),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){o.remove(),e.show(),l.destroy()},open:function(){$(this).dialog("widget").on("keydown",function(e){e.stopPropagation()})}})}),u.css({position:"absolute",top:p+"px",left:o+r+5+"px"}),n.hasClass("button_cke")&&n.hasClass("appx-modifiable")&&u.appendTo(n.parent())}else{var l={},x={}
l.customConfig=AppxResource.cache[n.data("editorConfig")],void 0===l.customConfig&&(l.customConfig="../custom/appx-ckeditor-config.js"),l.wordcount={showParagraphs:!1,showWordCount:!1,showCharCount:!0,countSpacesAsChars:!0,countHTML:!0,countLineBreaks:!0,maxWordCount:-1,maxCharCount:n.attr("maxlength"),maxParagraphs:-1,pasteWarningDuration:0},l.width=r,l.height=i,"disabled"==n.attr("disabled")&&(l.removePlugins=["toolbar","elementspath","wordcount","clipboard","pastetext","pastetools","tableselection","widget","uploadwidget","uploadimage","pastefromword","pastefromgdocs"],l.resize_enabled=!1),x=CKEDITOR.replace(n.attr("id"),l),n.attr("name",x.name)
var d=t
x.on("instanceReady",function(){this.ui.contentsElement.clientHeight=i,$("#cke_"+$(s[d]).attr("id")).find("iframe").attr("title",""),$("#cke_"+$(s[d]).attr("id")).css({position:"absolute",top:p+"px",left:o+"px","z-index":$(s[d]).css("z-index")}),this.resize(r,i,!1)}),x.on("paste",function(e){validateInputText(e.data.dataValue,n.data("unicode"))}),x.on("notificationHide",function(e){var a=document.querySelector("div.ui-tooltip")
null!=a&&a.remove()}),x.on("key",function(e){var a=e.data.domEvent.$
if(a.which>=37&&a.which<=40)e.data.domEvent.stopPropagation()
else if(10!=a.which&&13!=a.which||null!=e.editor.element.$.getAttribute("disabled")){var s=sendkey(a)
0==s&&e.cancel()}else e.data.domEvent.stopPropagation()}),x.resetDirty()}}}catch(g){console.log("appxApplyStyleEditor: "+g),console.log(g.stack)}}function appxApplyStylesEditor(){try{for(name in CKEDITOR.instances)CKEDITOR.instances[name].destroy(!0)
for(var e in appx_session.image_cache)10==appx_session.image_cache[e].ctx&&appxApplyStyleEditor(e,!0)
$.each($("#screenBuf .ckeditor"),function(e,a){CKEDITOR.instances.hasOwnProperty(a.id)||appxApplyStyleEditor(a,!1)})}catch(a){console.log("appxApplyStylesEditor: "+a),console.log(a.stack)}}function appxApplyStylesHtmlViewer(){try{$.each($("#screenBuf .appx-html-viewer a"),function(e,a){var s=$(a).attr("href")
isNaN(s)||$(a).attr({href:"#"}).click(function(e){return e.preventDefault(),appxwidgetcallback(parseInt(s)),!1})})}catch(e){console.log("appxApplyStylesHtmlViewer: "+e),console.log(e.stack)}}function appxApplyStylesTable(){try{$.each($("#screenBuf .appxtablewidget"),function(e,a){var s=AppxTable.getAppxTable($(a).data("tableHashKey"))
1==s._prefsDataReceived?createGridMongo({},$(a).attr("id")):setTimeout(function(){1==s._prefsDataReceived?createGridMongo({},$(a).attr("id")):setTimeout(function(){1==s._prefsDataReceived?createGridMongo({},$(a).attr("id")):setTimeout(function(){1==s._prefsDataReceived?createGridMongo({},$(a).attr("id")):setTimeout(function(){createGridMongo({},$(a).attr("id"))},250)},250)},250)},250)})}catch(e){console.log("appxApplyStylesTable: "+e),console.log(e.stack)}}function appxApplyStylesSlider(){try{$.each($("#screenBuf .slider"),function(e,a){function s(e){var a
return null!=$(".slider").attr("data-tickMajor")&&(a=parseInt($(".slider").attr("data-tickMajor"))),e=a?e%a?0:1:0}var t,n,o,p,r,i,l,c=1,d=1,u="ltr",x={},g=!1,h="horizontal"
if(o=parseInt($(a).attr("data-min")),p=parseInt($(a).attr("data-max")),x.min=[o],x.max=[p],"vertical"===$(a).attr("data-orientation")?h="vertical":$(a).closest(".appx--box").css("top","10px"),null!=$(a).attr("data-tickMajor")&&(t=parseInt($(a).attr("data-tickMajor")),d=t),null!=$(a).attr("data-tickMinor")&&(n=parseInt($(a).attr("data-tickMinor")),d=n),null!=$(a).attr("data-invert")&&"true"==$(a).attr("data-invert")&&(u="rtl"),null!=$(a).attr("data-tickSnap")&&"true"==$(a).attr("data-tickSnap"))g=!0,r=0,n?(c=n,l=p/n+1):t&&(c=t,l=p/t+1)
else if(null!=$(a).attr("data-tickShow")&&"true"==$(a).attr("data-tickShow")&&(n||t))if(g=!0,n){l=p/n+1,r=n/p*100
for(var e=1;e<=p/r;e++){var _=n*e
i=(r*e).toString()+"%",x[i]=[_]}}else if(t){l=p/t+1,r=t/p*100
for(var e=1;e<=p/r;e++){var _=t*e
i=(r*e).toString()+"%",x[i]=[_]}}if(g?noUiSlider.create(a,{start:[parseInt($(a).attr("data-value"))],step:c,range:x,direction:u,orientation:h,pips:{mode:"count",values:l,density:d,filter:s,stepped:!0}}):noUiSlider.create(a,{start:[parseInt($(a).attr("data-value"))],step:c,range:x,direction:u,orientation:h}),null!=$(a).attr("data-modifiable")&&"true"!=$(a).attr("data-modifiable")&&$(a).attr("disabled",!0),"vertical"===$(a).attr("data-orientation")){var w=$(a).closest(".noUiSlider").height()-13
$(a).height(w)}a.noUiSlider.on("change",function(e,s){var t=$(a).closest(".noUiSlider")
parseInt($(a).attr("data-value"))!==parseInt(a.noUiSlider.get())&&t.addClass("dirty"),t.val(parseInt(e[0]))}),null!=$(a).attr("data-tickLabels")&&"false"==$(a).attr("data-tickLabels")&&$("div").remove(".noUi-value")})}catch(e){console.log("appxApplyStylesSlider: "+e),console.log(e.stack)}}function appxattributeshandler(e){}function appxextraattributeshandler(e){}function attachMouseListener(e){e.mousedown(function(e){appx_session.mouseX=e.pageX-parseInt($("#appx_main_container").position().left),appx_session.mouseY=e.pageY-parseInt($("#appx_main_container").position().top)})}function appxscreenhandler(e){var a=""
if(null==$_screenBuf){var s=$("#appx_main_container").empty()
$_screenBuf=s.clone(),$_screenBuf.attr("id","screenBuf"),$_screenBuf.appendTo(s.parent()),$_screenBuf.css("visibility","hidden"),attachMouseListener(s.parent())}$_screenBuf.html("<div id='appx_main_background' style='float:left;width:70%;'>"+a+"</div>"),initializeMenu()}function appxscreenhandlerdata(e){for(var a=[],s="",t=0;e.length>0;){var n=e.shift()
if(logactivity("mask:  "+n),n>255){a=new Array(n)
for(var o=e.shift(),p=0;p<a.length;p++)a[p]=o
e=e.slice(a.length,e.length)}else e=e.slice(1,e.length),t=e.shift()+1,a=e.slice(0,t),s+=ab4str(a),e=e.slice(t,e.length)}return s}function appxMergeBoxes(e,a){for(var s=e.begin_row-a.begin_row,t=e.begin_column-a.begin_column,n=s*appx_session.rowHeightPx,o=t*appx_session.colWidthPx;e.items.length;){var p=e.items.shift(),r=p[0],i=p[1]
r.pos_row+=s,r.pos_col+=t,i&&i.css({top:parseInt(i.css("top"))+n+"px",left:parseInt(i.css("left"))+o+"px"}),a.items.push(p)}for(;e.widgets.length;){var l=e.widgets.shift(),c=l[0],i=l[1]
c.wPositionY+=s,c.wPositionX+=t,i&&i.css({top:parseInt(i.css("top"))+n+"px",left:parseInt(i.css("left"))+o+"px"}),a.widgets.push(l)}for(;e.rowtext.length;){var d=e.rowtext.shift()
d.pos_row+=s,d.pos_col+=t,a.rowtext.push(d)}}function appxHandleEmBox(){for(var e=0;e<appx_session.current_show.boxes.length;e++){var a=appx_session.current_show.boxes[e]
if(appxIsEmBuild(a))return $("#appx_status_date").html(a.widget.wLabel),!0}return!1}function appxshowboxes(){try{var e=null,a=null,s=null,t=0,n=null,o=appxGetCellSize(),p=appxGetCursorPos(),r=!1,i=0,l=null
appx_session.topbox=null,appx_session.tablist=null
for(var c=0;c<appx_session.current_show.boxes.length;c++){inProgressBox=null
var d=appx_session.current_show.boxes[c]
appxIsInProgress(d)&&(inProgressBox=d),0==d.begin_row&&0==d.end_row||(d.end_row>appx_session.screenrows-3&&(d.end_row=appx_session.screenrows-3),d.end_column>appx_session.screencols&&(d.end_column=appx_session.screencols),null!=e&&appxIsScrollReg(d)&&appxIsScrollAct(d)&&appxIsScroll(e)&&1==d.begin_row&&1==d.begin_column&&d.begin_row==e.begin_row&&d.end_row==e.end_row&&d.begin_column==e.begin_column&&d.end_column==e.end_column&&(d.newbox=c-1,d.bit_mask&=~SCROLL_REG,d.bit_mask&=~SCROLL_ACT,e.bit_mask&=~SCROLL,appxMergeBoxes(d,e),s=null,a=null,e=null),appxIsScrollReg(d)?(s=null,a=null,e=null):(s=a,a=e,e=d),null!=s&&s.begin_column==a.begin_column&&a.begin_column==e.begin_column&&s.end_column==a.end_column&&a.end_column==e.end_column&&e.end_row>=a.begin_row-1&&s.end_row>=e.begin_row-1&&appxIsScroll(e)&&(s.begin_column===a.begin_column&&s.end_column==a.end_column&&s.begin_column===a.begin_column&&s.end_column==a.end_column&&s.data_length<a.data_length?(s.newbox=c-2,a.scrollrow=e.begin_row-(a.begin_row-1)):(s.end_row=a.end_row,a.newbox=c-2,appxMergeBoxes(a,s),s.scrollrow=e.begin_row-(s.begin_row-1))),null!=a&&a.begin_column<=e.begin_column&&a.data.indexOf("SWBC=")===-1&&a.end_column>=e.end_column&&a.begin_row-1<=e.end_row&&a.end_row>=e.begin_row-1&&(appxIsScroll(e)?a.scrollrow=e.begin_row-(a.begin_row-1):0==Math.abs(e.bit_mask&BORD_AROUND)&&null==e.widget.wIconWallpaper&&null==e.widget.wColorBgWallpaper&&null==e.widget.wBorder&&null==e.widget.wLabel&&null==e.widget.wBorder&&(a.end_row<e.end_row&&(a.end_row=e.end_row),e.newbox=c-1,l=null===s?e.newbox:e.newbox-1,appxMergeBoxes(e,a),e=a,a=s)),appxIsScroll(d)||appxIsScrollReg(d)||(i=null!==l?l:c))}appx_session.current_show.boxes[i]&&appx_session.current_show.boxes[i].hasOwnProperty("newbox")&&(i=appx_session.current_show.boxes[i].newbox),appx_session.topboxid=i
for(var u=0,x=0,c=0;c<appx_session.current_show.boxes.length;c++){var d=appx_session.current_show.boxes[c]
if((1074003968!=d.bit_mask||null!=d.items[0]||null!=d.widgets[0]||null!=d.rowtext[0]||0!=Math.abs(d.bit_mask&BORD_AROUND)||null!=d.widget.wIconWallpaper||null!=d.widget.wColorBgWallpaper||null!=d.widget.wBorder||null!=d.widget.wLabel)&&!(appxIsEmBuild(d)||0==d.begin_row&&0==d.end_row||appxIsInProgress(d)||d.newbox>=0)){if(appxIsScroll(d)&&(u=t),x=appxIsScrollReg(d)?1e3*(u+1):1e3*(t+1),d.layer=x,!appxIsScroll(d)&&!appxIsScrollReg(d)&&d.rowtext&&d.rowtext.length>0){for(var g="",h=0;h<d.rowtext.length;h++){var _=d.rowtext[h]
1==_.pos_row&&(g+=_.string.trim()+" ",_.isTitle&&(_.string=""))}g.length>0&&null==d.widget.wLabel&&(d.widget.wLabel=g)}var w=(d.end_column-d.begin_column)*o.w+3*o.w+2,f=(d.end_row-(d.begin_row-1))*o.h+1*o.h
if(appxIsScroll(d)?f-=1*o.h-4:f+=1*o.h,f>=document.documentElement.clientHeight&&d.data.indexOf("SBN=0")>-1&&"Firefox"===checkBrowser()&&(f+=appx_session.rowHeightPx),0==c)var b=f
var m=d.begin_row*o.h-o.h,v=d.begin_column*o.w-o.w
if(d.widget&&d.widget.wPositionX&&d.widget.wPositionY&&(m=d.widget.wPositionY*o.h-o.h,v=d.widget.wPositionX*o.w-o.w),!appxIsScroll(d)&&!appxIsScrollReg(d)){var y=($("#appx_main_container").height()-f)/2
if((0===c||y>appx_session.centerVerticalOffset)&&(appx_session.centerVerticalOffset=y),0==d.widget.specialHorizontalLocation&&(v=0),0==d.widget.specialVerticalLocation&&(m=0,c>0)){var S=d.end_row-d.begin_row,C=appx_session.current_show.boxes[c-1].end_row-appx_session.current_show.boxes[c-1].begin_row
S<=C&&(m=(b-f)/2)}}var T=$("#appx_main_container").width(),k=(T-w)/2
if(k<0&&(k=0),(0===c||k<appx_session.centerHorizontalOffset)&&appx_session.getProp("centerAppx")){var I=appx_session.centerHorizontalOffset
appx_session.centerHorizontalOffset=k
for(var h=0;h<c;h++){var P=appx_session.current_show.boxes[h],O=$("#box_"+P.widget.wBoxNumber.toString())
if(O.length){var A=O.position().left-I
A<0&&(A=0),O.css({left:A+appx_session.centerHorizontalOffset+"px"})}}}k>appx_session.centerHorizontalOffset&&!appxIsScroll(d)&&!appxIsScrollReg(d)&&0==d.widget.specialHorizontalLocation?k-=appx_session.centerHorizontalOffset:k=0,appxIsScroll(d)&&(v+=3,w-=6),appxIsScrollReg(d)&&(v+=3,w-=6)
var E=null
if(d.widget.wLabel&&""!=d.widget.wLabel){var R=2,B=R,D=R,L=w-4*R+"px",M=o.h+"px"
"true"==appxFillWindow&&d.end_column-d.begin_column+1==appx_session.screencols&&(L="100%",B="0px",D="0px")
var E=$("<div>").css({border:"0px","box-sizing":"border-box",display:"table",height:M,left:D,overflow:"hidden",position:"absolute",top:B,width:L,"z-index":x+1})
E.addClass("appx-title"),E.attr("id","box_2_"+d.widget.wBoxNumber.toString()),E.data("row",d.widget.wPositionY),E.data("col",d.widget.wPositionX),d.widget.isBox=!1,appxwidgetshandlerpropsex(d.widget,E,!0)}v=v+k+appx_session.centerHorizontalOffset+"px","true"==appxFillWindow&&1==d.begin_row&&1==d.begin_column&&d.end_row==appx_session.screenrows-3&&d.end_column==appx_session.screencols&&(w="100%")
var N=$("<div>").css({"box-sizing":"border-box",height:f,left:v,overflow:"hidden",position:"absolute",top:m,width:w,"z-index":x})
if(E&&N.append(E),N.addClass("appxbox"),N.attr("id","box_"+d.widget.wBoxNumber.toString()),N.data("row",d.widget.wPositionY),N.data("col",d.widget.wPositionX),N.attr("data-role","content"),1==d.begin_row&&1==d.begin_column&&d.end_row==appx_session.screenrows-3&&d.end_column==appx_session.screencols&&N.addClass("appxbox-full"),d.widget.isBox=!0,appxwidgetshandlerprops(d.widget,N),$_screenBuf.append(N),p.row>=d.begin_row&&p.row<=d.end_row&&p.col>=d.begin_column&&p.col<=d.end_column&&(null==_boxcur||_boxcur.end_row-_boxcur.begin_row>=d.end_row-d.begin_row||_boxcur.end_column-_boxcur.begin_column>=d.end_column-d.begin_column)&&0==Math.abs(d.bit_mask&SCROLL)&&(_boxcur=d,n=N),!(d.end_column-d.begin_column+1>=appx_session.screencols&&d.end_row-d.begin_row+1>=appx_session.screenrows-3))if(appxIsScroll(d))N.addClass("appx-scroll"),N.css("top",m+o.h)
else if(appxIsScrollReg(d)){for(var U,W=N.siblings(".appx-scroll"),h=0;h<W.length;h++)$(W[h]).zIndex()===N.zIndex()&&(U=$(W[h]))
if(U)var z=parseInt(U.css("top").substring(0,U.css("top").indexOf("px"))),F=parseInt(U.css("left").substring(0,U.css("left").indexOf("px"))),H=parseInt(v.substring(0,v.indexOf("px"))),G=Math.abs(z-(m+o.h)),Y=H-F,X=U.width()
appxIsScrollAct(d)?(N.addClass("appx-scroll-act"),N.removeClass("appxbox"),r=!0):r?(r=!1,N.removeClass("appxbox"),N.addClass("appx-scroll-act-next")):(N.addClass("appx-scroll-reg"),N.removeClass("appxbox")),N.appendTo(U),N.data("col",d.begin_column),N.data("row",d.begin_row),N.click(function(){appxScrollClick($(this).parent())}),N.css({top:G,left:Y,width:X}),N.height(f-2*o.h)}else d.widget.wBorder||N.addClass("appx-border-bevel-raised")
if(d.widget.wMovable&&(N.data({wMovableCommand:d.widget.wMovableCommand}),N.draggable({cancel:".appx-modifiable, .ui-pg-input, .ui-pg-selbox",stop:function(){var e=Math.floor(($(this).offset().top-$("#appx_main_container").offset().top)/appx_session.rowHeightPx)+1,a=Math.floor(($(this).offset().left-$("#appx_main_container").offset().left-appx_session.centerHorizontalOffset)/appx_session.colWidthPx)+1
appxPutCursor(a,e),$(this).data("wMovableCommand")&&appxwidgetcallback($(this).data("wMovableCommand"))}})),$("a").each(function(){$(this).attr("tabindex",-1)}),$("button").each(function(){$(this).attr("tabindex",-1)}),appxIsScroll(d)||appxIsScrollReg(d))var J=appxFindBoxIdx(d.begin_row,d.begin_column,d.end_row-d.begin_row+1,d.end_column-d.begin_column+1,!1)
else{J=c
for(var V=!0,h=c+1;h<appx_session.current_show.boxes.length;h++)appx_session.current_show.boxes[h].hasOwnProperty("newbox")||appxIsScroll(appx_session.current_show.boxes[h])||appxIsScrollReg(appx_session.current_show.boxes[h])||(V=!1)
V&&(i=c)}appxshowrowtextforbox(d),appxshowitemsforbox(d,i==J,N),appxshowwidgetsforbox(d,i==J),appxIsScroll(d)||appxIsScrollReg(d)||(i!=c?N.addClass("appx-not-modifiable"):N.addClass("appx-active-box")),t++}}if(inProgressBox&&!blocked)try{blocked=!0
var K=inProgressBox.widget.wlabel
K||(K="In Progress"),$("#main").block({message:K+"...",overlayCSS:{backgroundColor:null,opacity:null,cursor:"wait"},centerY:!1,css:{"z-index":1e4},blockMsgClass:"appx-in-progress-msg"})}catch(j){}}catch(q){console.log("appxshowboxes: "+q),console.log(q.stack)}}function appxshowcursor(e){try{var a=appxGetCellSize(),s=appxGetCursorPos()
if(!e){var t=!1,n=appxfindbox(s.row,s.col,1,1,!0)
if(!n)return
var o=$("#appxCursor"),p=null
0==o.length&&(o=$("<div>"),o.attr("id","appxCursor"),o.css({"background-color":"rgba(0,0,0,.5)",height:a.h,position:"absolute",width:a.w,"z-index":"100000"}),$("#appx_main_container").append(o))
var r=s.col*a.w+appx_session.centerHorizontalOffset
appxIsScrollReg(n)&&(r-=3)
var i=s.row*a.h
o.css({left:r+"px",top:i+"px"}),$(".appx-scroll-act-new").removeClass("appx-scroll-act-new"),appxIsScrollReg(n)&&!appxIsScrollAct(n)&&$("#box_"+n.widget.wBoxNumber.toString()).addClass("appx-scroll-act-new")
for(var l=0;l<n.items.length;l++){var c=n.items[l]
if(null!=c[1]){var d=c[1][0]
if(c[0].hasOwnProperty("pos_row")){null==p&&appxIsModifiable(c[0])&&(p=c)
var u=0
appx_session.keyLeft&&(u=1)
var x={row:s.row-n.begin_row+1,col:s.col-n.begin_column+1}
if(appxIsScrollReg(n)&&appxIsScrollAct(n)&&(x={row:s.row,col:s.col}),appxIsModifiable(c[0])&&x.row>=c[0].pos_row&&x.row<=c[0].pos_row+c[0].size_rows-1&&u+x.col>=c[0].pos_col&&x.col<=c[0].pos_col+c[0].size_cols-1){t=!0,setInputFocus(d)
break}}}}return o.css("visibility",t||appxIsLocked()||"true"!=appx_session.getProp("drawBlockCursor")&&!appx_session.showCursor?"hidden":"visible"),t}var g=$("#appxitem_"+s.col+"_"+s.row)
0!==g.length&&g.hasClass("appx-modifiable")||(g=$(".appx-modifiable").first()),void 0!==g[0]&&setInputFocus(g[0])}catch(h){console.log("appxshowcursor: "+h),console.log(h.stack)}}function appxnestwidgets(){var e={}
try{for(var a=0;a<appx_session.current_show.boxes.length;a++){var s=appx_session.current_show.boxes[a]
s.widget=new Widget(0,"",s.data),s.widget&&(e[s.widget.wBoxNumber]=a)}}catch(t){console.log("appxidboxes: "+t),console.log(t.stack)}try{for(var a=0;a<appx_session.items.length;a++){var n=appx_session.items[a][0],s=appxitembox(n.pos_row,n.pos_col,n.size_rows,n.size_cols),o=appx_session.items[a][1]
if(appxIsScroll(s)||appxIsScrollReg(s)){if(o){var p=(s.begin_row-n.pos_row)*appx_session.rowHeightPx
o.css({top:p+"px"})}}else{n.init_pos_row=n.pos_row,n.init_pos_col=n.pos_col,n.pos_row-=s.begin_row-1,n.pos_col-=s.begin_column-1
var r=n.pos_row*appx_session.rowHeightPx,i=n.pos_col*appx_session.colWidthPx
o&&o.css({top:r+"px",left:i+"px"})}s&&s.items.push(appx_session.items[a])}appx_session.items=[]
for(var a=0;a<appx_session.widgets.length;a++){var l=appx_session.widgets[a],c=l[0],d=l[0].boxid,u=e[d],s=appx_session.current_show.boxes[u]
if(!appxIsFullscreen(s)&&appxIsScroll(s)){var o=l[1],x=s,s=appxitembox(x.begin_row+c.wPositionY-1,x.begin_column+c.wPositionX-1,c.wSizeH,c.wSizeW),g=s.begin_row-x.begin_row+1,h=s.begin_column-x.begin_column+1
o.css({top:parseInt(o.css("top"))-g*appx_session.rowHeightPx+"px",left:parseInt(o.css("left"))-h*appx_session.colWidthPx+"px"}),o.data("row")&&o.data("row",o.data("row")+(x.begin_row-1)),o.data("col")&&o.data("col",o.data("col")+(x.begin_column-1))}s?s.widgets.push(appx_session.widgets[a]):console.log("appxnestwidgets() failed to find box for widget")}appx_session.widgets=[]
for(var a=0;a<appx_session.rowtext.length;a++){var _=1,w=appx_session.rowtext[a]
if(w.type==ROWTEXT_TYPE_ITEM)s=appxitembox(w.pos_row,w.pos_col,w.size_rows,w.size_cols)
else{var f=w.boxid,b=e[f]
if(b>=0){var s=appx_session.current_show.boxes[b]
if(!appxIsFullscreen(s)&&appxIsScroll(s)){var x=s
s=appxitembox(x.begin_row+w.pos_row-1,x.begin_column+w.pos_col-1,w.size_rows,w.size_cols),_=x.begin_row}}}appxIsScroll(s)||appxIsScrollReg(s)?(w.pos_row-=s.begin_row-_,w.pos_col-=s.begin_column-1):w.type==ROWTEXT_TYPE_ITEM&&(w.pos_row-=s.begin_row-1,w.pos_col-=s.begin_column-1),s.rowtext.push(w)}appx_session.rowtext=[]}catch(t){console.log("appxnestwidgets: "+t),console.log(t.stack)}}function appxshowhandler(e){try{if(null==e||null==e.data)return
appx_session.current_show=e.data
var a=appx_session.current_show
a.curraction[0]
if($("#appx_main_container *").each(function(){var e=$(this).attr("id")+"-stale"
$(this).attr("id",e)}),appxnestwidgets(),appxHandleEmBox()?appx_session.buildingEm=!0:$("#appx_status_date").html(""),appx_session.buildingEm||(appxshowboxes(),appxprepscreen(),setTimeout(function(){appxSetTabIndexes()},0)),AppxResource.sendHeld(),screenflipped=!1,(0==appx_session.pendingResources.length&&0===appx_session.pendingTables||0==Math.abs(a.curraction[0]&M_WAIT))&&appxshowscreen(),0!=Math.abs(a.curraction[0]&M_SAVE)&&(appx_session.dirtySinceSave=!1),0==Math.abs(a.curraction[0]&M_WAIT)&&0==appx_session.pendingResources.length)sendappxshow(OPT_NULL,[])
else{$(document).tooltip(),blocked=!1
try{$("#main").unblock()}catch(s){}appxstarttimeout(),appxSetStatusStateText(0==appx_session.pendingResources.length&&0===appx_session.pendingTables?APPX_STATE_READY:APPX_STATE_IMAGES)}1==appx_session.processhelp&&(appx_session.processhelp=!1,setTimeout(function(){appxwidgetcallback(appx_session.processhelpoption),appx_session.processhelpoption=null},0)),!appx_session.buildingEm||0!==$("#appx_status_date").text().length&&$("#appx_status_date")||(appx_session.buildingEm=!1,appx_session.pendingTables=0)}catch(t){console.log("appxshowhandler: "+t),console.log(t.stack)}}function appxshowrowtextforbox(e){for(var a=0,s=0,t=0,n=0,o=25,p=e.rowtext.length-1;p>-1;p--){var r=e.rowtext[p],i=e.widget.wBoxNumber
if(1!=r.pos_row||"Standard Toolbars"!=r.string.trim())if(r.string&&r.string.length>1&&"="==r.string[0]&&e.scrollrow&&e.scrollrow==r.pos_row+1)s=r.pos_row
else if(s>0&&s==r.pos_row+1&&(t=r.pos_row,r.pos_row++),s>0&&t>0&&s==r.pos_row+2&&(n=r.pos_row,r.pos_row++),r.pos_row>0){if(1==r.pos_row&&e.widget&&e.widget.wLabel&&e.widget.wLabel.trim()==r.string.trim())continue
a++
var l=0,c=0,d=0,u=0,x=appx_session.colWidthPx,g=appx_session.rowHeightPx
e&&appxIsScrollReg(e)&&(l=1,c=1),l=(r.pos_col-l)*x,c=(r.pos_row-c)*g,d=r.size_cols*x+5,u=r.size_rows*g
var h=$("<div>")
r.size_rows>1?r.wordWrap?h.addClass("rowtextwrap"):h.addClass("appx-alpha-field"):h.addClass("rowtext"),r.type==ROWTEXT_TYPE_ITEM&&h.addClass("rowtextitem"),r.uline&&h.addClass("appx-uline"),r.string.length>1&&"="==r.string[0]&&h.addClass("ColHdgSep"),h.attr("id","rowtext_"+a.toString()),h.html(r.string.replace(/[\xb6\x0d\x0a]/g," ")),h.css({margin:"0",padding:"0"}),h.css({position:"absolute",left:l,top:c,height:u,width:d,"z-index":e.layer+o*-1})
for(var _=0;_<e.items.length;_++){var w=e.items[_]
if(4===w.length&&w[3]===r){e.items[_][1]=h
break}}if(null!=e){var f=$("#screenBuf #box_"+i)
f.length&&f.append(h)}}}}function appxshowitemsforbox(e,a,s){for(var t=e.items.length-1;t>=0;t--){var n=e.items[t][0],o=null
if(t>0&&(o=e.items[t-1][0]),null!=e.items[t][1]){var p=0
appxIsScrollReg(e)||(p=e.begin_row)
var r=e.items[t][1],i=$_screenBuf
a&&appxSetTabElement(n,r),appxIsModifiableCapable(n)&&appxIsScrollReg(e)&&r.removeClass("appx-not-modifiable")
var l=e.widget.wBoxNumber
appxwidgetdimensions(n,r,e)
var c=$("#screenBuf #box_"+l)
if(c.length?i=c:console.log("no box..."),appxIsScrollReg(e)&&(appxIsModifiable(n)||r.click(function(){appxScrollClick($(this).parent())})),(r.is("select")||r.hasClass("appx-listbox-originally"))&&navigator.userAgent.indexOf("Mobile")===-1){var d=parseInt(r.css("width")),u=parseInt(r.css("left")),x=u+d,g=parseInt(r.css("top")),h=null
t-1>=0&&(h=e.items[t-1][1])
var _=parseInt(i.css("width"))-4,w=_<x
if(h||w){appxwidgetdimensions(o,h,e)
var f=_,b=!0
if(w||(f=parseInt(h.css("left")),b=g===parseInt(h.css("top"))),b&&x>f){var m=r.attr("data-padWidth"),v=x-m,y=4*appx_session.colWidthPx
if(v<f){var S=w?5:1,C=f-S-u
C>y?r.width(C+"px"):r.width(y.toString()+"px")}}}}var T=!1
if(n.type==ROWTEXT_TYPE_ITEM){var k=$("<div>"),I=$("<div>")
null!=n.widget.wSepBefore&&n.widget.wSepBefore===!0&&(T=!0,k.addClass("sepBefore"),i.append(k),r.removeClass("sepBefore")),null!=n.widget.wSepAfter&&n.widget.wSepAfter===!0&&(T=!0,I.addClass("sepAfter"),i.append(I),r.removeClass("sepAfter"))
var P={}
$.each(r[0].attributes,function(e,a){P[a.nodeName]=a.nodeValue})
for(var O in P)if("style"==O){var A=10
null===n.widget.wLayer&&void 0===n.widget.wLayer||(A=n.widget.wLayer),n.widget.wSepBefore===!0&&(k.attr(O,P[O]),k.css({height:parseInt(s.css("height"))+"px"}),k.css({left:parseInt(r.css("left"))-4+"px"}),k.css({width:"1px"}),k.css({top:"0px"}),k.css({"z-index":e.layer+A*-1})),n.widget.wSepAfter===!0&&(I.attr(O,P[O]),I.css({height:parseInt(s.css("height"))+"px"}),I.css({left:parseInt(r.css("left"))+parseInt(r.css("width"))-2+"px"}),I.css({width:"1px"}),I.css({top:"0px"}),I.css({"z-index":e.layer+A*-1}))
break}}if(e.items[t].length<4){if(void 0===n.widget||null==n.widget||void 0===n.widget.wWidgetType||null==n.widget.wWidgetType||n.widget.wWidgetType!=WIDGET_TYPE_CHECK_BOX&&n.widget.wWidgetType!=WIDGET_TYPE_NONE&&n.widget.wWidgetType!=WIDGET_TYPE_RAW_TEXT&&n.widget.wWidgetType!=WIDGET_TYPE_LABEL||n.widget.wSepBefore!==!0&&n.widget.wSepAfter!==!0||0!=T)i.append(r)
else{var k=$("<div>"),I=$("<div>")
n.widget.wSepBefore===!0&&(k.addClass("sepBefore"),r.removeClass("sepBefore"),i.append(k)),n.widget.wSepAfter===!0&&(I.addClass("sepAfter"),r.removeClass("sepAfter"),i.append(I)),i.append(r)
var P={}
$.each(r[0].attributes,function(e,a){P[a.nodeName]=a.nodeValue})
for(var O in P)if("style"==O){var A=10
null===n.widget.wLayer&&void 0===n.widget.wLayer||(A=n.widget.wLayer),n.widget.wSepBefore===!0&&(k.attr(O,P[O]),k.css({height:parseInt(s.css("height"))+"px"}),k.css({left:parseInt(r.css("left"))-4+"px"}),k.css({width:"1px"}),k.css({top:"0px"}),k.css("z-index",e.layer+A*-1)),n.widget.wSepAfter===!0&&(I.attr(O,P[O]),I.css({height:parseInt(s.css("height"))+"px"}),I.css({left:parseInt(r.css("left"))+parseInt(r.css("width"))-2+"px"}),I.css({width:"1px"}),I.css({top:"0px"}),I.css({"z-index":e.layer+A*-1}))
break}}var A=10
null===n.widget.wLayer&&void 0===n.widget.wLayer||(A=n.widget.wLayer),r.css("z-index",e.layer+A*-1)}if(appxIsScannable(n)){var E=appxGetCellSize(),R=1,B=n.pos_col*E.w,u=parseInt(r.css("left")),D=B-u,L=u+parseInt(r.css("width"))+R,M=L+9,N=parseInt(r.css("top"))+4,U=!0
if(o){var f=o.pos_col*E.w-D
n.pos_row*E.h
n.pos_row==o.pos_row&&(L>=f||M>=f)&&(U=!1)}if(U){var W=n.widget.wPositionX,z=n.widget.wPositionY
null===W&&(W=r.data().col,z=r.data().row),$("<img>").attr("src",""+appxClientRoot+"/images/scanicon.png").data({col:W,row:z}).css({left:L,position:"absolute",top:N,"z-index":r.css("z-index")}).mousedown(function(){appx_session.scan=!0,appxPutCursor($(this).data().col,$(this).data().row),appxSnapshotScanCursor(),appxwidgetcallback(OPT_SCAN)}).appendTo(i)}}}}}function appxshowscreen(){if(!screenflipped){if(screenflipped=!0,!appx_session.buildingEm){var e=$("#appx_main_container")
e.attr("id","screenBuf"),$_screenBuf.attr("id","appx_main_container"),$_screenBuf.enhanceWithin&&$_screenBuf.enhanceWithin(),$_screenBuf.css("visibility","visible"),e.css("visibility","hidden"),e.empty(),$_screenBuf=e,appxshowcursor(!0),callValidateText()}setTimeout(function(){appxSetLocked(!1)},0)}}function appxprepscreen(){if(createDropDownMenu(),createPopupMenu(),createToolbarMenu(),applymessages(),$(".temp").each(function(){this.remove()}),$.contextMenu("destroy"),$("*").unbind("contextmenu"),!$.isEmptyObject(appx_session.currentmenuitems.popupItems)){for(var e in appx_session.currentmenuitems.popupItems)if(void 0!==appx_session.currentmenuitems.popupItems[e].icon){var a=appx_session.currentmenuitems.popupItems[e].icon,s=appx_session.image_cache[a].wIcon.substring(1,appx_session.image_cache[a].wIcon.lastIndexOf(",")).replace(",","."),t=appx_session.appxResourceUrl+s,n=$("<style>")
n.attr("type","text/css"),n.html(".context-menu-icon-"+a+" { background-image: url("+t+"); background-repeat: no-repeat; background-size: contain;}"),n.addClass("temp"),n.appendTo($("head")[0])}$.contextMenu({selector:".context-selector",zIndex:2e4,items:appx_session.currentmenuitems.popupItems}),$(":input").contextmenu(!1)}if(applystyles(),appx_session.token_cache)for(var o=0;o<appx_session.token_cache.keys.length;o++){var e=appx_session.token_cache.keys[o]
if(""!=e){if(!appxtokengetitem(e))continue
applyToken(e)}}if(1==appx_session.getProp("showScrollbar")){var p=0
$.each($("#screenBuf .appx-scroll"),function(e,a){p++
var s=($(a).css("z-index"),$("<div id='appx-group-vcr-"+p+"'>").addClass("appx-vcr-group")),t=$("<div id='appx-scroll-vcr-"+p+"'>").addClass("appx-vcr").css({left:parseInt($(a).css("width"))-16+"px",height:$(a).css("height")})
1==appx_session.getProp("dockingScrollbar")&&(s.addClass("appx-vcr-hide"),t.hover(function(){$("#appx-group-vcr-"+p).removeClass("appx-vcr-hide")},function(){$("#appx-group-vcr-"+p).addClass("appx-vcr-hide")}))
var n=Math.max(parseInt($(a).css("height"))-96,16)-0
s.html(""),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-up3").click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_SCROLL_FIRST),!1})),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-up2").click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_SCROLL_PREV),!1})),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-up1").click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_SCROLL_DOWN),!1})),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-scan").css({height:n+"px"}).click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_KEY_ENTRY),!1})),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-down1").click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_SCROLL_UP),!1})),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-down2").click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_SCROLL_NXT),!1})),s.append($("<button type='button'>").addClass("appx-vcr-btn").addClass("appx-vcr-down3").click(function(e){return e.preventDefault(),appxwidgetcallback(OPT_SCROLL_LAST),!1})),t.html(s),$(this).append(t)})}}function clearBoxRowText(e){var a=parseInt(e.css("left").substring(0,e.css("left").length-2)),s=parseInt(e.css("width").substring(0,e.css("width").length-2))+a,t=parseInt(e.css("top").substring(0,e.css("top").length-2)),n=parseInt(e.css("height").substring(0,e.css("height").length-2))+t
$(".rowtext").not(".wait").each(function(){var e=parseInt($(this).css("left").substring(0,$(this).css("left").length-2)),o=parseInt($(this).css("width").substring(0,$(this).css("width").length-2))+e,p=parseInt($(this).css("top").substring(0,$(this).css("top").length-2)),r=parseInt($(this).css("height").substring(0,$(this).css("height").length-2))+p
e<s&&o>a&&p<n&&r>t&&$(this).remove()})}function appxshowwidgetsforbox(e,a){for(;e.widgets.length>0;){var s=e.widgets.shift(),t=s[1],n=s[0],o=e.widget.wBoxNumber
parseInt(n.wWidgetType)==WIDGET_TYPE_ROWTEXT&&"="==n.wLabel[5]||(parseInt(n.wWidgetType)!=WIDGET_TYPE_BOX&&clearBoxRowText(t),$("#screenBuf #box_"+o).append(t),s[0].wMovable&&(t.data({wMovableCommand:s[0].wMovableCommand}),t.draggable({cancel:!1,stop:function(){var e=Math.floor(($(this).offset().top-$("#appx_main_container").offset().top)/appx_session.rowHeightPx),a=Math.floor(($(this).offset().left-$("#appx_main_container").offset().left)/appx_session.colWidthPx)
appxPutCursor(a,e),$(this).data("wMovableCommand")&&appxwidgetcallback($(this).data("wMovableCommand"))}})),a&&parseInt(s[0].wWidgetType)==WIDGET_TYPE_BUTTON?appxSetTabElement(n,t):(t.is("fieldset")||t.attr("tabindex",-1),parseInt(s[0].wWidgetType)!=WIDGET_TYPE_BUTTON||t.parent().hasClass("appx-scroll-act")||(t.prop("disabled",!0),$(t[0].firstChild).hasClass("appx-icon-trailing-text")&&$(t[0].firstChild).addClass("appx-icon-trailing-text-disabled"),t.css({color:""})),t.removeClass("default")))}}function appxSetTabElement(e,a){try{if(e&&a){var s=function(e){if(!e||0!=e.wEnabled){appx_session.tablist||(appx_session.tablist=[])
var s=appx_session.tablist,t=e?parseInt(e.wTabGroup):0,n="grp-"+(e?e.wTabSubGroupId||"0":"0")
isNaN(t)&&(t=0),"grp-0"==n&&e.wWidgetType==WIDGET_TYPE_BUTTON&&(n="grp-dfltButtons")
var o={grp:n,tag:a}
s[t]=s[t]||[],s[t][n]||(s[t][n]=[]),s[t][n].push(o)}}
e.hasOwnProperty("wWidgetType")?parseInt(e.wWidgetType)==WIDGET_TYPE_BUTTON&&s(e):e.hasOwnProperty("widget")&&e.widget&&appxIsModifiable(e)&&(a.prop("disabled")||s(e.widget))}}catch(t){console.log("appxSetTabElement: "+t),console.log(t.stack)}}function appxSetTabFocus(e,a,s){try{var t=parseInt(e.attr("tabindex"))%100,n=appx_session.tablist,o=n[t]
if(o.hasClass("appxdatefield")&&o.find(".appxdatevalue")&&(o=o.find(".appxdatevalue")),a&&o.blur(),t=a?--t:++t,t<0?t=n.length-1:t>=n.length&&(t=0),o=n[t],o.is("button")&&s&&$("button.default").length>0)o=$("button.default")
else if(o.is("button")&&s)return
setInputFocus(o)}catch(p){console.log("appxSetTabFocus: "+p),console.log(p.stack)}}function appxSetTabIndexes(){try{if(appx_session.tablist){for(var e=[],a=function(a,s){"none"!==a.css("display")&&(e.push(a),a.attr("tabindex",s+(e.length-1)),a.on("keydown",function(e){var a=this
if(e.which==appx_session.getProp("mapTabKey"))appxSetTabFocus($(a),e.shiftKey)
else if(13==e.which&&$(a).is("button"))$(a).trigger("click")
else if(!appxIsLocked())return!0
return e.preventDefault(),e.stopPropagation(),!1}),a.is("button")||a.on("keyup",function(e){try{if(!e.altKey&&!e.ctrlKey&&!e.metaKey){var a=e.which
if(a>46&&(a<91||a>93)&&(a<112||a>125)){var s=$(this).attr("maxlength"),t=appx_session.getProp("autoTabOut"),n=getInputElement(this)
if(s&&t){var o=!1,p=getCursorPosition($(n))
p>-1?s<=p&&(o=!0):$(n).hasClass("appxdatevalue")?s<=$(n).val().replace(/_/g," ").trim().length&&(o=!0):s<=$(n).val().trim().length&&(o=!0),o&&appxSetTabFocus($(this),!1,!0)}}}}catch(r){alert(appx_session.language.alerts.keypressError+r),console.log(r.stack)}return!0}))},s=function(e,a){var s=e.tag.position(),t=a.tag.position()
return s.top=parseInt(e.tag.css("top")),s.left=parseInt(e.tag.css("left")),t.top=parseInt(a.tag.css("top")),t.left=parseInt(a.tag.css("left")),s.top<t.top?-1:s.top>t.top?1:s.left<t.left?-1:s.left>t.left?1:0},t=appx_session.tablist,n=[],o=[],p=0;p<t.length;p++){var r=0
if(t[p]){for(var i in t[p])t[p][i].sort(function(e,a){return!e.tag.is("button")&&a.tag.is("button")?1:e.tag.is("button")&&!a.tag.is("button")?-1:s(e,a)}),t[p][i].sort(s),n[r++]=t[p][i][0]
for(var i in t[p])for(var l in t[p])if(i!==l&&"grp-dfltButtons"!==l&&s(t[p][i][0],t[p][l][0])>0&&("grp-0"==l||l.includes("split"))&&"grp-dfltButtons"!==i&&s(t[p][i][0],t[p][l][t[p][l].length-1])<0){for(var c=t[p][l].length,d=0,u=l+"-split",x=0;x<t[p][l].length;x++)if(s(t[p][i][0],t[p][l][x])<0){d=x
break}t[p][u]=t[p][l].splice(d,c-d)
for(var x=0;x<t[p][u].length;x++)t[p][u][x].grp=u
n[n.length]=t[p][u][0]}n.sort(s)
for(var i in t[p]){var g=[],h=[]
if("grp-dfltButtons"===i&&n.length>1){var _=n[0]
"grp-dfltButtons"===_.grp&&(_=n[1])
for(var x=0;x<t[p][i].length;x++)s(_,t[p][i][x])<1?g.push(t[p][i][x]):h.push(t[p][i][x])
t[p][i]=g.concat(h),t[p][i].tabGrp=2e3,o.push(t[p][i].tabGrp)}else for(var x=0;x<n.length;x++)if(n[x]==t[p][i][0]){t[p][i].tabGrp=100*x,o.push(t[p][i].tabGrp)
break}}o.sort(numberSort)
for(var x=0;x<o.length;x++)for(var i in t[p])if(t[p][i].tabGrp===o[x])for(var w=0;w<t[p][i].length;w++)a(t[p][i][w].tag,t[p][i].tabGrp)}}appx_session.tablist=e}}catch(f){console.log("appxSetTabIndexes: "+f),console.log(f.stack)}}function sendappxshow(e,a){appx_session.buildingEm||clearAndReset(),appx_session.showCursor=!1,appxSetStatusStateText(APPX_STATE_BUSY)
try{if(appx_session.buildingEm||$(".appxtablewidget").each(function(){var e=$(this).attr("id")
AppxTable.updateTableFromGrid(e)
for(var a=AppxTable.getSelections(e),s=[],t=0;t<a.length;t++)s.push(a[t].substring(1))
$(this).data("selkeys",s)}),appxIsLocked()&&null!=e&&e!=OPT_NULL&&null==appx_session.processhelpoption)return
appx_session.applyStylesCount=0,appx_session.currenttabledata=[],appxSetLocked(!0),appxstoptimeout(),appx_session.override=!1
var s=[],t=appx_session.current_show
if(null!=t){var n=t.rawdata[4]
null!=e&&e>=0&&(t.rawdata[35]=1)
var o=new DataView(new Uint8Array(t.rawdata).buffer),p=appxGetCursorPos()
if(o.setUint32(12,p.row),o.setUint32(16,p.col),null!=e?o.setUint32(28,parseInt(e)):o.setUint32(28,OPT_NULL),n!=M_SHOW&&n!=M_COMPARE||(o.setUint32(32,parseInt("8")),o.setUint32(28,OPT_NULL)),o.setInt32(44,0),o.setInt32(48,0),o.setUint32(52,0),t.altuseroption&&appx_session.scan){var r=0,i=0
r=o.getUint32(12),i=new DataView(new Uint8Array(t.altcursorrow).buffer).getUint32(0),o.setUint32(12,i),o.setUint32(44,r),r=o.getUint32(16),i=new DataView(new Uint8Array(t.altcursorcol).buffer).getUint32(0),o.setUint32(16,i),o.setUint32(48,r),r=o.getUint32(28),i=new DataView(new Uint8Array(t.altuseroption).buffer).getUint32(0),o.setUint32(28,i),o.setUint32(52,r),t.altuseroption=null,t.altcursorrow=null,t.altcursorcol=null}else if(t.altuseroption){var r=0,i=0
r=o.getUint32(12),i=new DataView(new Uint8Array(t.altcursorrow).buffer).getUint32(0),o.setUint32(12,i),o.setUint32(44,r),r=o.getUint32(16),i=new DataView(new Uint8Array(t.altcursorcol).buffer).getUint32(0),o.setUint32(16,i),o.setUint32(48,r),t.altuseroption=null,t.altcursorrow=null,t.altcursorcol=null}for(var s=[],l=0;l<new Uint8Array(o.buffer).length;l++)s[l]=o.getUint8(l)}var c={cmd:"appxmessage",args:[0,0,0,2,12,0,0,0],handler:"appxshowhandler",data:null}
if(appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:[0,54,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,209,0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:s,handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),0!=Math.abs(n&M_COMPARE)&&appx_session.dirtySinceSave?(c={cmd:"appxmessage",args:[1],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))):(c={cmd:"appxmessage",args:[0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))),appx_session.override)c={cmd:"appxmessage",args:[0,0,0,2,86,0,0,0,0,0,0,1,11,27,0,3,84,82,75],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
else if(a.length>0){c={cmd:"appxmessage",args:[0,0,0,2,86,0,0,0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
for(var d=[],u=0;u<a.length;u++){var x=""
if($(a[u]).find(".appxdatevalue").val())x=$(a[u]).find(".appxdatevalue").val()
else if($(a[u]).closest(".appxitem").find("input").val())x=$(a[u]).closest(".appxitem").find("input").val()
else if($(a[u]).hasClass("masked")&&""===$(a[u]).val())x=$(a[u]).data()._inputmask_opts.alias.replace(/\*/g," ")
else if($(a[u]).val())if($(a[u]).hasClass("appxfilewrapper")&&$(a[u]).hasClass("DULC")||$(a[u]).hasClass("DnD")){var g,o=$(a[u]).val()
if(g=appx_session.filesUploadArray.length,g>1||$(a[u]).hasClass("DnD")){var h=x="$(sendFile)\\c:\\directory\\",_="folder"
$(a[u]).hasClass("DnD")&&1==g&&(_="file",h=x="$(sendFile)\\")
for(var l=0;l<g;l++){var w=appx_session.filesUploadArray[l].name.replace(/ /g,"_"),f="$(sendFile)\\[["+l+"]]"+w
1==g&&(f="$(sendFile)\\"+w)
var b,m
b=$(a[u]).data("row"),m=$(a[u]).data("col"),appx_session.dndData.push({row:b,col:m,parentType:$(a[u]).data("parent_type"),path:h+w,name:f,ext:w.substring(w.lastIndexOf(".")+1).toLowerCase(),mtype:_,size:appx_session.filesUploadArray[l].size.toString(),props:[]})}}else x=o.indexOf("\\")>-1||o.indexOf("/")>-1?o.indexOf("\\")>-1?"$(sendFile)"+o.substring(o.lastIndexOf("\\")):"$(sendFile)"+o.substring(o.lastIndexOf("/")):"$(sendFile)\\"+o}else x=$(a[u]).val()
else $(a[u]).closest(".appxitem").val()?x=$(a[u]).closest(".appxitem").val():$(a[u]).find(".appx-data").html()?x=$(a[u]).find(".appx-data").html():$(a[u]).hasClass("togglebutton")&&(x=$(a[u]).hasClass("down")?"Y":"N")
"uppercase"==$(a[u]).css("text-transform")&&(x=x.toUpperCase()),x=x.replace("‘","'"),x=x.replace("’","'"),x=x.replace("“",'"'),x=x.replace("”",'"')
var v=$(a[u]).closest(".appxitem").attr("id")
if(""!=v&&v||(v=$(a[u]).closest(".appxitem").closest("div").attr("id")),void 0!==v){var y=parseInt($("#"+v).data("row"))
d.push(y)
var S=parseInt($("#"+v).data("col"))
d.push(S)}else{var y=parseInt($(a[u]).closest(".appxwidget").closest("div").data("row"))
d.push(y)
var S=parseInt($(a[u]).closest(".appxwidget").closest("div").data("col"))
d.push(S)}var C=toUTF8Array(x)
if((appx_session.server_extended_feature_mask&TMNET_FEATURE2_LARGE_WORK_FIELD)==TMNET_FEATURE2_LARGE_WORK_FIELD)Array.prototype.push.apply(d,hton32(C.length))
else{var T=C.length%256,k=(C.length-T)/256
d.push(k),d.push(T)}for(l=0;l<C.length;l++)d.push(C[l])}clearClientIds(),$(a[0]).hasClass("DnD")?(c={cmd:"appxmessage",args:[0,0,0,0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))):(c={cmd:"appxmessage",args:hton32(a.length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:d,handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)))}else c={cmd:"appxmessage",args:[0,0,0,2,86,0,0,0,0,0,0,0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
c={cmd:"appxmessage",args:[0,0,0,4,90,0,0,0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
var I=0
a=$(".appxtablewidget")
for(var d=[],u=0;u<a.length;u++){var P=$(a[u]).data()
if(P.selkeys)for(var O=0;O<P.selkeys.length;O++){var x=""
x=P.selkeys[O]
var y=hton32(parseInt(P.row))
Array.prototype.push.apply(d,y)
var S=hton32(parseInt(P.col))
Array.prototype.push.apply(d,S)
var A=hton32(I+1)
Array.prototype.push.apply(d,A),d.push(6),d.push(x.length/2)
for(var E=0;E<x.length;E+=2)d.push(parseInt(x.substring(E,E+2),16))
I++}}var R=hton32(I)
c={cmd:"appxmessage",args:R,handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),a.length>0&&(c={cmd:"appxmessage",args:d,handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))),c={cmd:"appxmessage",args:[0,0,0,4,92,0,0,0],handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
var B=appx_session.dndData.length
c={cmd:"appxmessage",args:hton32(B),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
for(var D=($("meta[name=appx-character-encoding]").attr("content"),0);D<B;D++){var L=appx_session.dndData[D]
c={cmd:"appxmessage",args:hton32(L.row),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton32(L.col),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton32(L.parentType),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton16(toUTF8Array(L.path).length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:toUTF8Array(L.path),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton16(toUTF8Array(L.name).length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:toUTF8Array(L.name),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton16(toUTF8Array(L.ext).length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:toUTF8Array(L.ext),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton16(toUTF8Array(L.mtype).length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:toUTF8Array(L.mtype),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton32(L.size),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
var M=L.props.length
c={cmd:"appxmessage",args:hton16(M),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))
for(var N=0;N<M;N++){var U=L.props[N]
c={cmd:"appxmessage",args:hton16(toUTF8Array(U.name).length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:toUTF8Array(U.name),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:hton16(toUTF8Array(U.value).length),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c)),c={cmd:"appxmessage",args:toUTF8Array(U.value),handler:"appxshowhandler",data:null},appx_session.ws.send(JSON.stringify(c))}}appx_session.dndData=[]}catch(W){console.log("sendappxshow: "+W),console.log(W.stack)}}function appxIsLocked(){return appx_session.locked}function appxSetLocked(e){if(appx_session.locked=e,!e)for(;appx_session.runOnUnlock.length;)appx_session.runOnUnlock.shift().call()}function appxGetCellSize(){return{w:appx_session.colWidthPx,h:appx_session.rowHeightPx}}function appxFixCursorCol(e){return e<1&&(e=1),e>appx_session.screencols&&(e=appx_session.screencols),e>255&&(e=255),e}function appxFixCursorRow(e){return e<1&&(e=1),e>appx_session.screenrows-3&&(e=appx_session.screenrows-3),e>255&&(e=255),e}function appxGetCursorPos(){var e=appxFixCursorCol(ab2int32(appx_session.current_show.cursorcol)),a=appxFixCursorRow(ab2int32(appx_session.current_show.cursorrow))
return{col:e,row:a}}function appxIsInProgress(e){return 0!=Math.abs(e.bit_mask&IN_PROGRESS)&&(null==e.widget||203!=e.widget.wWidgetType)}function appxIsEmBuild(e){return 0!=Math.abs(e.bit_mask&IN_PROGRESS)&&null!=e.widget&&203==e.widget.wWidgetType}function appxIsFullscreen(e){try{return e.end_column-e.begin_column+1>=appx_session.screencols&&e.end_row-e.begin_row+1>=appx_session.screenrows-3}catch(a){console.log("screen.appxIsFullscreen: "+a),console.log(a.stack)}}function appxIsScroll(e){return 0!=Math.abs(e.bit_mask&SCROLL)}function appxIsScrollAct(e){return 0!=Math.abs(e.bit_mask&SCROLL_ACT)}function appxIsScrollReg(e){return 0!=Math.abs(e.bit_mask&SCROLL_REG)}function appxSnapshotScanCursor(){appx_session.scan_cursorrow=appx_session.current_show.cursorrow,appx_session.scan_cursorcol=appx_session.current_show.cursorcol}function appxGetScanCursorPos(){var e=appxFixCursorCol(ab2int32(appx_session.scan_cursorcol)),a=appxFixCursorRow(ab2int32(appx_session.scan_cursorrow))
return{col:e,row:a}}function appxClearScanCursor(){appx_session.scan_cursorrow=-1,appx_session.scan_cursorcol=-1}function appxPutCursor(e,a){try{var s=!1
if(!appxIsLocked()){var t=appxGetCursorPos()
t.col==e&&t.row==a||(appx_session.current_show.cursorcol=[0,0,0,appxFixCursorCol(e)],appx_session.current_show.cursorrow=[0,0,0,appxFixCursorRow(a)],s=appxshowcursor(!1))}return s}catch(n){console.log("appxPutCursor: "+n),console.log(n.stack)}}function appxPutTabOut(){try{if(!appxIsLocked()){var e=appxGetCursorPos()
appx_session.current_show.altcursorcol=[0,0,0,appxFixCursorCol(e.col)],appx_session.current_show.altcursorrow=[0,0,0,appxFixCursorRow(e.row)],appx_session.current_show.altuseroption=[0,0,1,76]}}catch(a){console.log("appxPutTabOut: "+a),console.log(a.stack)}}function appxScrollClick(e){var a=e.data("col"),s=e.data("row")
a&&s&&(appxPutCursor(a,s),appxwidgetcallback(OPT_ENTER))}function appxSetStatusPIDText(e){$("#appx_status_pid").html(e)}function appxSetStatusDbText(e){$("#appx_status_db").html(e)}function appxSetStatusApText(e){$("#appx_status_ap").html(e)}function appxSetStatusVerText(e){$("#appx_status_ver").html(e)}function appxSetStatusUserText(e){$("#appx_status_user").html(e)}function appxSetStatusKeymapText(e){$("#appx_status_keymap").html(e)}function appxSetStatusMsgText(e){appxSetStatusText(e)}function appxSetStatusModeText(e){$("#appx_status_mode").html(e)}function appxSetStatusStateText(e){if(e!=appx_state_last){appx_state_last=e
var a=$("<span>")
switch(e){case APPX_STATE_BUSY:$("*").addClass("wait"),a.html("busy").addClass("appx-state-busy")
break
case APPX_STATE_READY:$("*").removeClass("wait"),a.html("ready").addClass("appx-state-ready")
break
case APPX_STATE_DIRTY:a.html("ready+").addClass("appx-state-dirty"),appx_session.dirtySinceSave=!0
break
case APPX_STATE_IMAGES:a.html("images").addClass("appx-state-images")
break
case APPX_STATE_EMS:a.html("compile").addClass("appx-state-ems")}$("#appx_status_stat").html(a)}}function appxSetStatusEmbldText(e){$("#appx_status_embld").html(e)}function appxSetStatusProgressText(e){$("#appx_status_progress").html(e)}function appxClearStatusMsgText(){$("#appx-status-msg").html(""),$("#appx-status-msg").css("background-color","white")}function appxSetStatusText(e,a){e=e.trim()
var s=$("#appx-status-msg"),t=$("<span>").html(e)
switch(t.addClass("status-msg"),a){case 0:t.addClass("status-msg-info"),appxloadurlhandler({data:"$messagebeep:"})
break
case 1:t.addClass("status-msg-warning"),appxloadurlhandler({data:"$warningbeep:"})
break
case 2:t.addClass("status-msg-error"),appxloadurlhandler({data:"$errorbeep:"})
break
case 3:t.addClass("status-msg-cancel"),appxloadurlhandler({data:"$cancelbeep:"})}void 0!=e&&""!=e&&(s.text().length>0&&s.append("<br/>"),s.append(t))}function appxstarttimeout(){appxstoptimeout()
var e=appx_session.current_show
!e||null==e.timeout||e.timeout<=0||e.timeout>6e4||(appx_session.interactT=setTimeout(function(){appxwidgetcallback(e.useroption?ab2int32(e.useroption):OPT_DIR_PROC_1)},1e3*e.timeout))}function appxstoptimeout(){appx_session.interactT&&clearTimeout(appx_session.interactT),appx_session.interactT=null}function appxstartblurtimeout(){appxstopblurtimeout(),appx_session.interactTblur=setTimeout(function(){appxwidgetcallback(OPT_TAB_OUT)},1e3)}function appxstopblurtimeout(){appx_session.interactTblur&&clearTimeout(appx_session.interactTblur),appx_session.interactTblur=null}function RowTextStruct(){this.type=ROWTEXT_TYPE_NONE,this.boxid=0,this.pos_row=0,this.pos_col=0,this.size_rows=0,this.size_cols=0,this.string=null,this.uline=!1}function showPopup(e){if(e)var a="<h1>About APPX</h1>Server Connector Version: "+appx_session.getProp("serverConnectorVersionStr")+"</br>Local Connector Version: "+appx_session.getProp("localConnectorVersionStr")+"</br>Browser Client APPX Directory Version: "+appx_session.getProp("clientServerVersionStr")+"</br>Browser Client Web Directory Version: "+appx_session.getProp("clientPublicVersionStr")
else var a="<h1>Functionality Not Currently Enabled</h1><p>Functionality for this option has not been enabled in this release of APPX.</p>"
var s=($("<div id='appx_popup'>").css({background:"rgba(50, 50, 50, 0.7)",width:"100%",height:"100%","min-height":"220px","z-index":"10000000",display:"none",position:"absolute",top:"0px",left:"0px","font-family":"verdana","font-size":"11px"}).appendTo("body"),$("<div style='border: 10px solid #333;'>").css({width:"550px",height:"220px",background:"#fff"}).appendTo("#appx_popup").position({my:"center",at:"center",of:window}).draggable()),t=$("<div>").css({margin:"0px 10px",width:"550px",height:"220px"}),n=$("<div>").css({background:"#333","text-align":"right",padding:"5px",color:"#F5F539","font-weight":"bold","padding-bottom":"10px"}).append($("<span>close(X)</span>").click(function(){$("#appx_popup").hide(),$("#appx_popup").remove(),"true"===appxLocalRequired&&(localos_session=new LOCALOS)}))
$(s).prepend($("<div>").append(n)),$(t).append($("<div>").append(a)),$(t).appendTo(s),$("#appx_popup").show()}var screenflipped=!1,blocked=!1,inProgressBox=null,_boxcur=null,$_screenBuf=null,M_SHOW=2,M_WAIT=8,M_COMPARE=32,M_SAVE=64,SCROLL=65536,SCROLL_REG=131072,SCROLL_ACT=262144,IN_PROGRESS=524288,BORD_AROUND=2147483648,APPX_STATE_BUSY=0,APPX_STATE_READY=1,APPX_STATE_DIRTY=2,APPX_STATE_IMAGES=3,APPX_STATE_EMS=4,appx_state_last=-1,ROWTEXT_TYPE_NONE=0,ROWTEXT_TYPE_ITEM=1,ROWTEXT_TYPE_WIDGET=2
