/*********************************************************************
 **
 **   server/appx-client-table.js - Everthing needed for table processing
 **
 **   This module contains code used to process a table object.
 **
 *********************************************************************/
var AppxTablePrefs=function(){function t(){}return t}(),AppxTableTransient=function(){function t(){}return t}(),AppxTable=function(){function t(t){this._pulledFromSrv=!1,this._tableHashKey=t,this._init(),this._prefsSrvSnap=JSON.stringify(this._prefsData)}return t.prototype._init=function(){this._prefsData=new AppxTablePrefs,this._transData=new AppxTableTransient,this._transData.pendingXHR=0},t.pad=function(t,e){var a=" ".repeat(e)
return(""+t+a).substring(0,e)},t.dlog=function(e,a){var i=t.pad
a?console.log(i(a._appxElemId,20)+" - "+i(e,40)+" - pendingTables="+i(appx_session.pendingTables,2)+", pendingXHRs="+i(a._transData.pendingXHR,2)+", tableLoaded="+i(a._transData.tableLoaded,5)+", changed="+i(a._transData.changed,5)+", screenflipped="+i(screenflipped,5)+", scrollPosition="+i(a._transData.scrollPosition,6)+", lastPage="+i(a._transData.lastPage,4)+", reuse="+i(a._transData.reuse,5)):console.log(e)},t._addButtonsToFooter=function(e,a){void 0!==e._widgetData.tableShowCsvOption&&e._widgetData.tableShowCsvOption!==!0||$("#newtablewidget_"+a).jqGrid("navButtonAdd","#"+e._pagerElemId,{caption:"",buttonicon:"ui-icon-document",onClickButton:function(){e._tableToCsv()},position:"last",title:appx_session.language.tooltips.tableCsv,cursor:"pointer",id:"table_csv_button"}),t._haveOptionsToShow(e)&&$("#newtablewidget_"+a).jqGrid("navButtonAdd","#"+e._pagerElemId,{caption:"",buttonicon:"ui-icon-gear",onClickButton:function(){t._showOptions(e)},position:"last",title:appx_session.language.tooltips.tableOptions,cursor:"pointer",id:e._optionElemId}),e._adjustGridIconColors()},t._haveOptionsToShow=function(t){return void 0===t._widgetData.tableShowPageOption||t._widgetData.tableShowPageOption===!0||(void 0===t._widgetData.tableShowTableRefresh||t._widgetData.tableShowTableRefresh===!0||(void 0===t._widgetData.tableShowColChooser||t._widgetData.tableShowColChooser===!0||(void 0===t._widgetData.tableShowLayoutSave||t._widgetData.tableShowLayoutSave===!0)))},t._showOptions=function(t){var e=$("#"+t._appxElemId),a=($("#"+t._gridElemId),30),i=73,o=$("<div id='jqgrid-options-dialog' title='"+appx_session.language.tooltips.tableOptions+"'>")
o.appendTo(e),void 0!==t._widgetData.tableShowPageOption&&t._widgetData.tableShowPageOption!==!0||(a+=i,$("<button id='table-paging' class='table-buttons' title='"+appx_session.language.tooltips.tablePaging+"'>").click(function(){t._scrollSwitch()}).append($("<span class='table-buttons-span ui-icon ui-icon-newwin'>")).appendTo(o)),void 0!==t._widgetData.tableShowTableRefresh&&t._widgetData.tableShowTableRefresh!==!0||(a+=i,$("<button id='table-reset' class='table-buttons' title='"+appx_session.language.tooltips.tableReset+"'>").click(function(){t._resetToDefaults()}).append($("<span class='table-buttons-span ui-icon ui-icon-arrowreturn-1-s'>")).appendTo(o)),void 0!==t._widgetData.tableShowColChooser&&t._widgetData.tableShowColChooser!==!0||(a+=i,$("<button id='table-column-chooser' class='table-buttons' title='"+appx_session.language.tooltips.tableColumns+"'>").click(function(){$("#"+t._gridElemId).jqGrid("columnChooser")}).append($("<span class='table-buttons-span ui-icon ui-icon-grid'>")).appendTo(o)),void 0!==t._widgetData.tableShowLayoutSave&&t._widgetData.tableShowLayoutSave!==!0||(a+=i,$("<button id='table-save' class='table-buttons' title='"+appx_session.language.tooltips.tableSave+"'>").click(function(){t._pushTablePref(),$("#table-buttons-message-span").text(appx_session.language.tooltips.tableSaved)}).append($("<span class='table-buttons-span ui-icon ui-icon-disk'>")).appendTo(o)),o.dialog({open:function(e,i){var o=$("<div id='table-buttons-message-div'>").append("<span id='table-buttons-message-span'>")
$(".ui-dialog-buttonpane").append(o),t._adjustGridIconColors(),$(this).parent().css({"z-index":19999,width:Math.max(174,a)+"px"}),$(this).css({"z-index":19999,width:"98%"}),$(".ui-dialog :button").blur()},close:function(){$(this).dialog("destroy").remove(),$("#"+t._optionElemId).blur()},buttons:{Finished:function(){$(this).dialog("close")}}})},t._getAppxSession=function(){return appx_session},t._computeTableHashKey=function(t){var e="pcb"+t.wPcbId+"fik"+t.wFrameImageKey+"sig"+t.wHashSig+"r"+t.wPositionY+"c"+t.wPositionX+"h"+t.wSizeH+"w"+t.wSizeW
return e},t._computeTableID=function(t){var e=t.wHashSig+"_"+t.wFrameImageKey+"_"+t.wPositionY+"_"+t.wPositionX
return e},t._getPropVirtualScroll=function(){return t._getAppxSession().getProp("gridVirtualScroll")===!0?1:0},t.getAppxTable=function(e){if(this._initialized===!1){this._initialized=!0
var a=$("<th    id='el1' class='ui-th-column ui-th-ltr ui-state-default' style='width: 40px'>"),i=$("<tr    id='el2' class='ui-jqgrid-labels ui-sortable'>").append(a),o=$("<thead id='el3'>").append(i),s=$("<table id='el4' class='ui-jqgrid-htable ui-common-table'>").append(o),r=$("<div   id='el5' class='ui-jqgrid-hbox'>").append(s),l=$("<div   id='el6' class='ui-jqgrid-hdiv ui-state-default ui-corner-top'>").append(r),n=$("<div   id='el7' class='ui-jqgrid-view'>").append(l),d=$("<div   id='el8' class='ui-jqgrid ui-widget ui-widget-content ui-corner-all' style='visibility: hidden'>").append(n)
$("#main").append(d),t._colAddedWidthPx=0+parseInt($(a).css("border-left-width"))+parseInt($(a).css("border-right-width"))+parseInt($(a).css("padding-left"))+parseInt($(a).css("padding-right")),$(d).remove()}var p=t._getAppxSession(),c=p.appxTableList[e]
return void 0===c&&(c=new t(e),p.appxTableList[e]=c),c},t.updateTableFromWidget=function(e){var a=e.widgetExtraData,i=t._computeTableHashKey(e),o=t._computeTableID(e),s=t.getAppxTable(i)
if(s._widgetData=e,appx_session.pendingTables++,a.widget_extra_reuse===!0)s._transData.reuse=!0,s._transData.changed=!1
else{var r=a.widget_extra_data
s._transData.changed=!1,JSON.stringify(r.selectedKeys)!==JSON.stringify(s._transData.selectedKeys)?s._transData.changed=!0:r.rowCount!=s._tableData.rowCount&&(s._transData.changed=!0),s._tableData=r,s._transData.reuse=!1,s._transData.selectedKeys=void 0,s._tableData.colMap=[]
for(var l=0;l<s._tableData.colModel.length;l++)s._tableData.colMap.push(l)
s._tableID=o,s._pulledFromSrv||(s._pullTablePref(),s._pulledFromSrv=!0)}return i},t.updateTableFromGrid=function(e){var a=$("#"+e)
t.getAppxTable($(a).data("tableHashKey"))._updateTableFromGrid(a)},t.getSelections=function(e){var a=$("#"+e)
return t.getAppxTable($(a).data("tableHashKey"))._getSelections()},t.createGridMongo=function(e){setTimeout(function(){var a=$("#"+e)
t.getAppxTable($(a).data("tableHashKey"))._createGridMongo(a)},0)},t.prototype._reloadGrid=function(){var t=this,e=$("#"+t._appxElemId),a=$("#"+t._gridElemId),i=$("#"+t._pagerElemId)
$.jgrid.gridUnload("#"+t._gridElemId),i.remove(),a.remove(),t._createGridMongo(e)},t.prototype._resetToDefaults=function(){var t=this
t._init(),t._reloadGrid()},t.prototype._scrollSwitch=function(){var t=this
t._toggleVirtualScroll(),t._reloadGrid()},t.prototype._pullTablePref=function(){var e=this,a=($("#"+e._appxElemId),t._getAppxSession()),i=t._getAppxSession().appxDataCacheUrl.replace(/getGridData$/,"getUserPrefs"),o=new XMLHttpRequest
o.open("POST",i),o.setRequestHeader("Content-type","application/json"),o.onreadystatechange=function(){if(4===o.readyState&&200===o.status){var t=JSON.parse(o.responseText).prefData
e._prefsSrvSnap=t,e._adjustGridIconColors(),"{}"!==t&&(e._prefsData=JSON.parse(t))}}
var s={prefType:a.user+"_"+a.host+"_tablePrefs",prefKey:e._tableID}
o.send(JSON.stringify(s))},t.prototype._adjustGridIconColors=function(){var t=this
"{}"===t._prefsSrvSnap?($("#"+t._optionElemId).removeClass("jqgrid-options-highlight"),$("#table-save").removeClass("jqgrid-options-highlight")):($("#"+t._optionElemId).addClass("jqgrid-options-highlight"),$("#table-save").addClass("jqgrid-options-highlight"))},t.prototype._pushTablePref=function(){var e=this,a=$("#"+e._appxElemId),i=t._getAppxSession()
e._updateTableFromGrid(a)
var o=t._getAppxSession().appxDataCacheUrl.replace(/getGridData$/,"setUserPrefs"),s=new XMLHttpRequest
s.open("POST",o),s.setRequestHeader("Content-type","application/json"),s.onreadystatechange=function(){4===s.readyState&&200===s.status},e._prefsSrvSnap=JSON.stringify(e._prefsData),e._adjustGridIconColors()
var r={prefType:i.user+"_"+i.host+"_tablePrefs",prefKey:e._tableID,prefData:e._prefsSrvSnap}
s.send(JSON.stringify(r))},t.prototype._tableToCsv=function(){var t=this,e=$("#"+t._gridElemId),a=e.getGridParam("postData")
a.colModel=e.getGridParam("colModel"),void 0!==a.filters&&a.filters.length>0&&(a._search="true")
var i=e.getGridParam("url").replace(/getGridData$/,"getGridCsv"),o=new XMLHttpRequest
o.open("POST",i),o.setRequestHeader("Content-type","application/json"),o.onreadystatechange=function(){if(4===o.readyState&&200===o.status){var t=JSON.parse(o.responseText)
appxUtil_downloadUrl(appx_session.appxCacheUrl+t.url)}},o.send(JSON.stringify(a))},t.prototype._clearSelections=function(){var t=this
t.selectedKeys=void 0,t._transData.lastPage=1,t._transData.scrollPosition=0},t.prototype._getSelections=function(){return this.selectedKeys},t.prototype._getPostData=function(){var t,e=this
if("BlankTable"!=e._tableData.datalookupid&&(t={collection:e._tableData.collection,datalookupid:e._tableData.datalookupid,collist:e._tableData.collist,lastSortName:e._prefsData.lastSortName||[],lastSortOrder:e._prefsData.lastSortOrder||[],search:!1},e._prefsData.filters&&(t.filters=e._prefsData.filters,t.search=!0)),e._transData.tableLoaded===!1&&JSON.stringify(e._prefsData.lastSortName)!==JSON.stringify(["initialSort"])){var a=e.selectedKeys
a&&a.length>0&&(t.findId2=a[0])}return t},t.prototype._updateTableFromGrid=function(t){var e=this,a=$("#"+e._gridElemId),i=[],o=a.jqGrid("getGridParam","colModel")
if(o){for(var s=0;s<o.length;s++)"rn"!==o[s].name&&"cb"!==o[s].name&&i.push($.extend(!0,{},o[s]))
if(e._prefsData.colModel=i,e._transData.scrollPosition=$(t).find(".ui-jqgrid-bdiv").scrollTop(),e._transData.lastPage=Math.floor(e._transData.scrollPosition/1050+1),e._prefsData.lastSortName=[a.jqGrid("getGridParam","sortname")],e._prefsData.lastSortOrder=[a.jqGrid("getGridParam","sortorder")],e._prefsData.colMap=a.jqGrid("getGridParam","remapColumns"),JSON.stringify(e._prefsData.lastSortName)===JSON.stringify(["initialSort"])&&(e._prefsData.lastSortName=void 0),JSON.stringify(e._prefsData.lastSortOrder)===JSON.stringify(["asc"])&&(e._prefsData.lastSortOrder=void 0),void 0!==e._prefsData.colMap&&0!==e._prefsData.colMap.length&&JSON.stringify(e._prefsData.colMap)!==JSON.stringify(e._tableData.colMap)||(e._prefsData.colMap=void 0),e._prefsData.colModel&&e._prefsData.colModel.length===e._tableData.colModel.length){var r=e._prefsData.colModel,l=e._tableData.colModel,n=void 0,d=l.length,p=!1
for(n=0;n<d&&p===!1;n++){var c=Object.getOwnPropertyNames(l[n]),_=void 0,g=c.length
for(_=0;_<g&&p===!1;_++){var u=c[_]
JSON.stringify(r[n][u])!==JSON.stringify(l[n][u])&&(p=!0)}}p===!1&&(e._prefsData.colModel=void 0)}}},t.prototype._getPage=function(){var t=1
return this._transData.reuse===!0||void 0!=this._prefsData.filters?this._transData.lastPage&&(t=this._transData.lastPage):this._tableData.selectedRows&&this._tableData.selectedRows.length>0&&(t=parseInt(""+(1+(this._tableData.selectedRows[0]-1)/50))),t},t.prototype._getScrollPosition=function(){var t=0
if(this._transData.reuse===!0||this._transData.changed!==!0&&void 0==this._prefsData.filters)this._transData.scrollPosition&&(t=this._transData.scrollPosition)
else if(this._tableData.selectedRows&&this._tableData.selectedRows.length>0){var e=$("#"+this._gridElemId),a=e.closest(".ui-jqgrid-bdiv").height(),i=void 0===t||0===t?21:$("#"+e.jqGrid("getGridParam","selrow")).height()
t=(this._tableData.selectedRows[0]-1)*i,t-=(a-i)/2,t<0&&(t=0)}return t<0?0:t},t.prototype._createGridMongo=function(e){var a=this,i=$(e).attr("id")
a._transData.tableLoaded=!1,a._appxElemId=i,a._gridElemId=t._ELEM_TABLE_PREFIX+"_"+i,a._pagerElemId=t._ELEM_PAGER_PREFIX+"_"+i,a._optionElemId=t._ELEM_OPTION_PREFIX+"_"+i,a._gviewElemId="gview_"+a._gridElemId
var o=$("#"+a._appxElemId).css("font-size"),s=parseInt(1.76*parseInt(o)+.5+"px"),r=$(e).width(),l=$(e).height(),n=a._widgetData.tableShowFooterBar===!0?28:0,d=20,p=r-2,c=l-4-n+d,_=Math.floor(Math.log(a._tableData.rowCount)*Math.LOG10E+1),g=1==a._widgetData.tableShowRowNumbers?30+10*(Math.max(4,_)-4):0,u=a._tableData.rowCount*s,f=0
$(e).append($('<table id="'+a._gridElemId+'">')),this._widgetData.tableShowFooterBar&&$(e).append($('<div id="'+a._pagerElemId+'" style="height: '+n+'px"></div>'))
for(var h=a.colModel,b=-1,D=g+t._colAddedWidthPx,w=0;w<h.length;w++)h[w].hidden!==!0&&(h[w].fixed===!0?D+=h[w].width+t._colAddedWidthPx:b=w)
u>c&&(f=18),b!==-1&&(h[b].width=p-(D+f+t._colAddedWidthPx))
var S={}
S.shrinkToFit=!1,S.height=l-4-n-d,S.width=p,S.scrollOffset=f,S.mtype="POST",S.caption=a._widgetData.wLabel||"",S.colModel=h,S.datatype="json",S.hidegrid=!1,S.multiselect=!0,S.rowList=[10,20,30,40,50],S.scroll=a._getVirtualScroll(),S.viewrecords=!0,S.gridview=!0,S.loadonce=!1,S.scrollrows=!1,S.sortname=(a._prefsData.lastSortName||["initialSort"]).slice(-1)[0],S.sortorder=(a._prefsData.lastSortOrder||["asc"]).slice(-1)[0],S.rownumbers=a._widgetData.tableShowRowNumbers,S.postData=a._getPostData(),S.search=!(!S.postData||!S.postData.filters),S.rownumWidth=g,S.rowNum=a._prefsData.rowsPerPage||50,S.url=t._getAppxSession().appxDataCacheUrl,S.pager="#"+a._pagerElemId,S.page=a._getPage(),S.sortable=function(t){a._columnMoved(this,t)},S.resizeStop=function(t,e){a._columnResized(this,t,e)},S.gridComplete=function(){a._gridComplete(this)},S.loadComplete=function(t){a._loadComplete(this,t)},S.onSelectRow=function(t,e,i){a._onSelectRow(this,t,e,i)},S.beforeSelectRow=function(e,i){return!(a._transData.clickDetect&&Date.now()-a._transData.clickDetect<t._DOUBLE_CLICK_TIMER)&&(a._transData.clickDetect=Date.now(),a._beforeSelectRow(this,e,i))},S.ondblClickRow=function(t,e,i,o){a._onDblClickRow(this,t,e,o)},S.loadBeforeSend=function(t,e){a._loadBeforeSend(this,t,e)}
var v=$("#"+a._gridElemId).jqGrid(S),m=v.jqGrid("getGridParam","postData")
m&&(a._prefsData.filters?(m.search=!0,m.filters=a._prefsData.filters):(m.search=!1,m.filters=void 0)),v.jqGrid("hideCol","cb")
for(var w=0;w<a.colModel.length;w++)a.colModel[w].align&&v.jqGrid("setLabel",a.colModel[w].name,"",{"text-align":a.colModel[w].align})
var y={left:"",top:"",drag:!0,multipleSearch:!0,searchOnEnter:!0,closeAfterSearch:!0,closeOnEscape:!0,stringResult:!0,beforeShowSearch:function(){var t=$(".ui-jqdialog"),e=(r-t.width())/2,a=(l-t.height())/2
return t.css("left",e+"px").css("top",a+"px"),!0}}
v.jqGrid("navGrid","#"+a._pagerElemId,{edit:!1,add:!1,del:!1,beforeRefresh:function(){a._clearSelections(),a._prefsData.filters=void 0}},{},{},{},y),t._addButtonsToFooter(a,i),$("#newtablewidget_"+i).closest(".appxbox").hasClass("appx-not-modifiable")&&$("#newtablewidget_"+i).closest(".ui-jqgrid").block({message:null,overlayCSS:{backgroundColor:"#000",opacity:0,cursor:null}})},t.prototype._beforeSelectRow=function(t,e,a){var i=this
if(a.ctrlKey===!1&&a.metaKey===!1&&a.shiftKey===!1)$(t).jqGrid("resetSelection"),i.selectedKeys=[]
else if(a.shiftKey){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()
var o=$(t).jqGrid("getGridParam","selrow"),s=$(t).jqGrid("getInd",o),r=$(t).jqGrid("getInd",e)
if($(t).jqGrid("resetSelection"),i.selectedKeys=[],r>s)var l=o,n=e
else var l=e,n=o
var d=!1
$.each($(t).jqGrid("getDataIDs"),function(a,o){return(d=o==l||d)&&o!=e&&($(t).jqGrid("setSelection",o,!1),i.selectedKeys.push(o)),o!=n})}return!0},t.prototype._onSelectRow=function(e,a,i,o){var s=this
i?s.selectedKeys.push(a):s.selectedKeys=s.selectedKeys.filter(function(t){return t!==a}),void 0==s._transData.clickTimer&&s._widgetData.wCommand&&$(e).closest(".appxbox").hasClass("appx-not-modifiable")===!1&&appxIsLocked()===!1&&(s._transData.clickTimer=setTimeout(function(){s._transData.clickTimer=void 0,appxwidgetcallback(s._widgetData.wCommand)},t._DOUBLE_CLICK_TIMER))},t.prototype._onDblClickRow=function(t,e,a,i){var o=this
o._transData.clickTimer&&(clearTimeout(o._transData.clickTimer),o._transData.clickTimer=void 0),$(t).closest(".appxbox").hasClass("appx-not-modifiable")===!1&&appxIsLocked()===!1&&appxwidgetcallback(o._widgetData.wCommand2)},t.prototype._columnMoved=function(t,e){this._prefsData.colMap=e},t.prototype._columnResized=function(t,e,a){this._prefsData.colModel=$(t).jqGrid("getGridParam","colModel")},t.prototype._gridComplete=function(t){var e=this,a=(e.selectedKeys,$("#"+e._appxElemId).css("font-size")),i=$("#"+e._appxElemId).css("line-height")
$("#"+e._gviewElemId+" div").css({"font-size":a,"line-height":i,"padding-top":"0px","padding-bottom":"0px"})},t.prototype._loadBeforeSend=function(t,e,a){var i=this,o=$("#"+i._gridElemId),s=o.jqGrid("getGridParam","postData")
s?(JSON.stringify(s.filters)!==JSON.stringify(i._prefsData.filters)&&i._clearSelections(),i._prefsData.filters=s.filters):i._prefsData.filters=void 0,i._transData.tableLoaded||(i._transData.pendingXHR++,appxSetStatusStateText(APPX_STATE_BUSY))},t.prototype._loadComplete=function(t,e){var a=this,i=a.selectedKeys
$(t).jqGrid("resetSelection")
for(var o=0;o<i.length;o++)$(t).jqGrid("setSelection",i[o],!1)
if(!a._transData.tableLoaded){if(e.findId2RowNo&&a._tableData.selectedRows)if(e.findId2RowNo===-1)a._clearSelections()
else{a._tableData.selectedRows[0]=e.findId2RowNo
var s=$("#"+a._gridElemId).getGridParam("page")
$("#"+a._gridElemId).jqGrid("getInd",i[0])===!1&&s!==a._getPage()&&($("#"+a._gridElemId).setGridParam({page:a._getPage()}),a._reloadGrid())}$(t).closest(".ui-jqgrid-bdiv").scrollTop(a._getScrollPosition()),setTimeout(function(){a._transData.pendingXHR--,0==a._transData.pendingXHR&&appx_session.pendingTables>0&&(a._transData.tableLoaded=!0,appx_session.pendingTables--),0===appx_session.pendingTables&&0===appx_session.pendingResources.length&&(0!==Math.abs(appx_session.current_show.curraction[0]&M_WAIT)&&appxSetStatusStateText(APPX_STATE_READY),screenflipped||appxshowscreen())},500)}},t.prototype._toggleVirtualScroll=function(){var t=this
return t._setVirtualScroll(1===t._getVirtualScroll()?0:1),t._getVirtualScroll()},t.prototype._getVirtualScroll=function(){var e=this._prefsData.virtualScroll
return void 0==e&&(e=t._getPropVirtualScroll()),e},t.prototype._setVirtualScroll=function(e){void 0===e||null===e?this._prefsData.virtualScroll=void 0:e>0?this._prefsData.virtualScroll=1:this._prefsData.virtualScroll=0,t._getPropVirtualScroll()===this._prefsData.virtualScroll&&(this._prefsData.virtualScroll=void 0)},Object.defineProperty(t.prototype,"colModel",{get:function(){return void 0!==this._prefsData.colModel?this._prefsData.colModel:this._tableData.colModel},set:function(t){this._prefsData.colModel=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedKeys",{get:function(){return void 0!==this._transData.selectedKeys?this._transData.selectedKeys:this._tableData.selectedKeys},set:function(t){this._transData.selectedKeys=t},enumerable:!0,configurable:!0}),t.USE_NEW_CODE=!0,t._initialized=!1,t._colAddedWidthPx=0,t._rowTotalHeightPx=19,t._ELEM_TABLE_PREFIX="newtablewidget",t._ELEM_PAGER_PREFIX="pager",t._ELEM_OPTION_PREFIX="option",t._DOUBLE_CLICK_TIMER=250,t}()
