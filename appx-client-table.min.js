/*********************************************************************
 **
 **   server/appx-client-table.js - Everthing needed for table processing
 **
 **   This module contains code used to process a table object.
 **
 *********************************************************************/
var AppxTablePrefs=function(){function e(){}return e}(),AppxTableTransient=function(){function e(){}return e}(),AppxTable=function(){function e(t){if(this._pulledFromSrv=!1,this._tableHashKey=t,this._init(),this._prefsData&&this._prefsData.colModel){var a=this._prefsData,o=e._prefsSrvSnapColModelCleanup(this,this._prefsData.colModel)
o.length>0?a.colModel=o:(a.colModel=void 0,a.colMap=void 0),this._prefsSrvSnap=JSON.stringify(a)}else this._prefsSrvSnap=JSON.stringify(this._prefsData)}return e.prototype._init=function(){this._prefsData=new AppxTablePrefs,this._transData=new AppxTableTransient,this._transData.pendingXHR=0,this._prefsDataReceived=!1},e.pad=function(e,t){var a=" ".repeat(t)
return(""+e+a).substring(0,t)},e.dlog=function(t,a){var o=e.pad
a?console.log(o(a._appxElemId,20)+" - "+o(t,40)+" - pendingTables="+o(appx_session.pendingTables,2)+", pendingXHRs="+o(a._transData.pendingXHR,2)+", tableLoaded="+o(a._transData.tableLoaded,5)+", changed="+o(a._transData.changed,5)+", screenflipped="+o(screenflipped,5)+", scrollPosition="+o(a._transData.scrollPosition,6)+", lastPage="+o(a._transData.lastPage,4)+", reuse="+o(a._transData.reuse,5)):console.log(t)},e._addButtonsToFooter=function(t,a){void 0!==t._widgetData.tableShowCsvOption&&t._widgetData.tableShowCsvOption!==!0||$("#newtablewidget_"+a).jqGrid("navButtonAdd","#"+t._pagerElemId,{caption:"",buttonicon:"ui-icon-document",onClickButton:function(){t._tableToCsv()},position:"last",title:appx_session.language.tooltips.tableCsv,cursor:"pointer",id:"table_csv_button"}),e._haveOptionsToShow(t)&&$("#newtablewidget_"+a).jqGrid("navButtonAdd","#"+t._pagerElemId,{caption:"",buttonicon:"ui-icon-gear",onClickButton:function(){e._showOptions(t)},position:"last",title:appx_session.language.tooltips.tableOptions,cursor:"pointer",id:t._optionElemId}),t._adjustGridIconColors()},e._haveOptionsToShow=function(e){return void 0===e._widgetData.tableShowPageOption||e._widgetData.tableShowPageOption===!0||(void 0===e._widgetData.tableShowTableReset||e._widgetData.tableShowTableReset===!0||(void 0===e._widgetData.tableShowColChooser||e._widgetData.tableShowColChooser===!0||(void 0===e._widgetData.tableShowLayoutSave||e._widgetData.tableShowLayoutSave===!0)))},e._showOptions=function(e){var t=$("#"+e._appxElemId),a=($("#"+e._gridElemId),30),o=73,l=$("<div id='jqgrid-options-dialog' title='"+appx_session.language.tooltips.tableOptions+"'>")
l.appendTo(t),void 0!==e._widgetData.tableShowPageOption&&e._widgetData.tableShowPageOption!==!0||(a+=o,$("<button id='table-paging' class='table-buttons' title='"+appx_session.language.tooltips.tablePaging+"'>").click(function(){e._scrollSwitch()}).append($("<span class='table-buttons-span ui-icon ui-icon-newwin'>")).appendTo(l)),void 0!==e._widgetData.tableShowTableReset&&e._widgetData.tableShowTableReset!==!0||(a+=o,$("<button id='table-reset' class='table-buttons' title='"+appx_session.language.tooltips.tableReset+"'>").click(function(){e._resetToDefaults()}).append($("<span class='table-buttons-span ui-icon ui-icon-arrowreturn-1-s'>")).appendTo(l)),void 0!==e._widgetData.tableShowColChooser&&e._widgetData.tableShowColChooser!==!0||(a+=o,$("<button id='table-column-chooser' class='table-buttons' title='"+appx_session.language.tooltips.tableColumns+"'>").click(function(){$("#"+e._gridElemId).jqGrid("columnChooser",{close:function(){return!1},closeOnEscape:!0,modal:!0})}).append($("<span class='table-buttons-span ui-icon ui-icon-grid'>")).appendTo(l)),void 0!==e._widgetData.tableShowLayoutSave&&e._widgetData.tableShowLayoutSave!==!0||(a+=o,$("<button id='table-save' class='table-buttons' title='"+appx_session.language.tooltips.tableSave+"'>").click(function(){e._pushTablePref(),$("#table-buttons-message-span").text(appx_session.language.tooltips.tableSaved)}).append($("<span class='table-buttons-span ui-icon ui-icon-disk'>")).appendTo(l)),l.dialog({modal:!0,closeOnEscape:!0,open:function(t,o){var l=$("<div id='table-buttons-message-div'>").append("<span id='table-buttons-message-span'>")
$(".ui-dialog-buttonpane").append(l),e._adjustGridIconColors(),$(this).parent().css({"z-index":19999,width:Math.max(174,a)+"px"}),$(this).css({"z-index":19999,width:"98%"}),$(this).parent().siblings(".ui-widget-overlay").css({"z-index":19998}),$(".ui-dialog :button").blur(),$(this).parent().siblings(".ui-widget-overlay").click(function(){$("#jqgrid-options-dialog").dialog("close")})},close:function(){return $(this).dialog("destroy").remove(),$("#"+e._optionElemId).blur(),!1},buttons:{Finished:function(){$(this).dialog("close")}}})},e._getAppxSession=function(){return appx_session},e._computeTableHashKey=function(e){var t="pcb"+e.wPcbId+"fik"+e.wFrameImageKey+"sig"+e.wHashSig+"r"+e.wPositionY+"c"+e.wPositionX+"h"+e.wSizeH+"w"+e.wSizeW
return t},e._computeTableID=function(e){var t=e.wHashSig+"_"+e.wFrameImageKey+"_"+e.wPositionY+"_"+e.wPositionX
return t},e._getPropVirtualScroll=function(){return e._getAppxSession().getProp("gridVirtualScroll")===!0?1:0},e.getAppxTable=function(t){if(this._initialized===!1){this._initialized=!0
var a=$("<th    id='el1' class='ui-th-column ui-th-ltr ui-state-default' style='width: 40px'>"),o=$("<tr    id='el2' class='ui-jqgrid-labels ui-sortable'>").append(a),l=$("<thead id='el3'>").append(o),i=$("<table id='el4' class='ui-jqgrid-htable ui-common-table'>").append(l),r=$("<div   id='el5' class='ui-jqgrid-hbox'>").append(i),s=$("<div   id='el6' class='ui-jqgrid-hdiv ui-state-default ui-corner-top'>").append(r),n=$("<div   id='el7' class='ui-jqgrid-view'>").append(s),d=$("<div   id='el8' class='ui-jqgrid ui-widget ui-widget-content ui-corner-all' style='visibility: hidden'>").append(n)
$("#main").append(d),e._colAddedWidthPx=0+parseInt($(a).css("border-left-width"))+parseInt($(a).css("border-right-width"))+parseInt($(a).css("padding-left"))+parseInt($(a).css("padding-right")),$(d).remove()}var p=e._getAppxSession(),c=p.appxTableList[t]
return void 0===c&&(c=new e(t),p.appxTableList[t]=c),c},e.updateTableFromWidget=function(t){var a=t.widgetExtraData,o=e._computeTableHashKey(t),l=e._computeTableID(t),i=e.getAppxTable(o)
if(i._widgetData=t,appx_session.pendingTables++,a.widget_extra_reuse===!0)i._transData.reuse=!0,i._transData.changed=!1
else{var r=a.widget_extra_data
i._transData.changed=!1,JSON.stringify(r.selectedKeys)!==JSON.stringify(i._transData.selectedKeys)?i._transData.changed=!0:r.rowCount!=i._tableData.rowCount&&(i._transData.changed=!0),i._tableData=r,i._transData.reuse=!1,i._transData.selectedKeys=void 0,i._tableData.colMap=[]
for(var s=0;s<i._tableData.colModel.length;s++)i._tableData.colMap.push(s),"checkbox"==i._tableData.colModel[s].formatter&&(i._tableData.colModel[s].formatter=e.checkboxFormatter,i._tableData.colModel[s].unformat=e.checkboxUnFormatter)
i._tableID=l,i._pulledFromSrv||(i._pullTablePref(),i._pulledFromSrv=!0)}return o},e.updateTableFromGrid=function(t){var a=$("#"+t)
e.getAppxTable($(a).data("tableHashKey"))._updateTableFromGrid(a)},e.getSelections=function(t){var a=$("#"+t)
return e.getAppxTable($(a).data("tableHashKey"))._getSelections()},e.createGridMongo=function(t){setTimeout(function(){var a=$("#"+t)
e.getAppxTable($(a).data("tableHashKey"))._createGridMongo(a)},0)},e.prototype._reloadGrid=function(){var e=this,t=$("#"+e._appxElemId),a=$("#"+e._gridElemId),o=$("#"+e._pagerElemId)
try{$.jgrid.gridUnload("#"+e._gridElemId)}catch(l){console.log("_reloadGrid() failed to unload old grid: "+l)}o.remove(),a.remove(),e._createGridMongo(t)},e.prototype._resetToDefaults=function(){var e=this
e._init(),e._reloadGrid()},e.prototype._scrollSwitch=function(){var e=this
e._toggleVirtualScroll(),e._reloadGrid()},e.prototype._pullTablePref=function(){var t=this,a=($("#"+t._appxElemId),e._getAppxSession()),o=e._getAppxSession().appxDataCacheUrl.replace(/getGridData$/,"getUserPrefs"),l=new XMLHttpRequest
l.open("POST",o),l.setRequestHeader("Content-type","application/json"),l.onreadystatechange=function(){if(4===l.readyState&&200===l.status){var a=JSON.parse(l.responseText).prefData
null!=a?t._prefsSrvSnap=a:t._prefsSrvSnap="{}",t._adjustGridIconColors(),"{}"!==a&&null!=a&&(t._prefsData=JSON.parse(a),t._prefsData.colModel&&e.updateColModelFormatter(t._prefsData.colModel,t))}t._prefsDataReceived=!0}
var i={prefType:a.user+"_"+a.host+"_tablePrefs",prefKey:t._tableID}
l.send(JSON.stringify(i))},e.prototype._adjustGridIconColors=function(){var e=this
"{}"===e._prefsSrvSnap?($("#"+e._optionElemId).removeClass("jqgrid-options-highlight"),$("#table-save").removeClass("jqgrid-options-highlight")):($("#"+e._optionElemId).addClass("jqgrid-options-highlight"),$("#table-save").addClass("jqgrid-options-highlight")),e._prefsData&&e._prefsData.filters&&""!==e._prefsData.filters?$("#search_"+e._gridElemId).addClass("jqgrid-options-highlight"):$("#search_"+e._gridElemId).removeClass("jqgrid-options-highlight")},e.prototype._pushTablePref=function(){var t=this,a=$("#"+t._appxElemId),o=e._getAppxSession()
t._updateTableFromGrid(a)
var l=e._getAppxSession().appxDataCacheUrl.replace(/getGridData$/,"setUserPrefs"),i=new XMLHttpRequest
if(i.open("POST",l),i.setRequestHeader("Content-type","application/json"),i.onreadystatechange=function(){4===i.readyState&&200===i.status},t._prefsData&&t._prefsData.colModel){var r=t._prefsData,s=e._prefsSrvSnapColModelCleanup(t,t._prefsData.colModel)
s.length>0?r.colModel=s:(r.colModel=void 0,r.colMap=void 0),t._prefsSrvSnap=JSON.stringify(r)}else t._prefsSrvSnap=JSON.stringify(t._prefsData)
t._adjustGridIconColors()
var n={prefType:o.user+"_"+o.host+"_tablePrefs",prefKey:t._tableID,prefData:t._prefsSrvSnap}
i.send(JSON.stringify(n))},e._prefsSrvSnapColModelCleanup=function(e,t){var a=[]
if(t){for(var o=0;o<t.length;o++){var l={name:t[o].name}
t[o].index&&(l.index=t[o].index),e._tableData.colWidget&&e._tableData.colWidget[t[o].name]?l.label=e._tableData.colWidget[t[o].name].oLabel:l.label=t[o].label,void 0!=t[o].widthOrg&&(l.width=t[o].widthOrg,l.widthOrg=t[o].widthOrg),void 0!=t[o].oHidden?t[o].oHidden!=t[o].hidden&&0==t[o].WidetChangedHidden?l.hidden=t[o].hidden:t[o].oHidden!=t[o].hidden&&1==t[o].WidetChangedHidden?l.hidden=t[o].oHidden:l.hidden=t[o].hidden:l.hidden=t[o].hidden,void 0!=t[o].hidedlg&&(l.hidedlg=t[o].hidedlg),t[o].align&&(l.align=t[o].align),void 0!=t[o].fixed&&(l.fixed=t[o].fixed),t[o].datatype&&(l.datatype=t[o].datatype),t[o].searchtype&&(l.searchtype=t[o].searchtype),t[o].formatoption&&(l.formatoption=t[o].formatoption),t[o].editoption&&(l.editoption=t[o].editoption),t[o].formatter&&(l.formatter=t[o].formatter),t[o].key&&1==t[o].key&&(l.key=!0),a.push(l)}if(a.length>0&&e._tableData.colModel){for(var i=!1,o=0;o<e._tableData.colModel.length;o++){if(a[o].name!=e._tableData.colModel[o].name){i=!0
break}if(a[o].index!=e._tableData.colModel[o].index){i=!0
break}if(e._tableData.colWidget&&e._tableData.colWidget[t[o].name]){if(a[o].label!=e._tableData.colWidget[t[o].name].oLabel){i=!0
break}}else if(a[o].label!=e._tableData.colModel[o].label){i=!0
break}if(a[o].width!=e._tableData.colModel[o].width){i=!0
break}if(void 0!=e._tableData.colModel[o].oHidden){if(a[o].hidden!=e._tableData.colModel[o].oHidden){i=!0
break}}else if(a[o].hidden!=e._tableData.colModel[o].hidden){i=!0
break}if(a[o].hidedlg!=e._tableData.colModel[o].hidedlg){i=!0
break}if(a[o].align!=e._tableData.colModel[o].align){i=!0
break}if(a[o].fixed!=e._tableData.colModel[o].fixed){i=!0
break}if(a[o].datatype!=e._tableData.colModel[o].datatype){i=!0
break}if(a[o].searchtype!=e._tableData.colModel[o].searchtype){i=!0
break}if(a[o].formatoption!=e._tableData.colModel[o].formatoption){i=!0
break}if(a[o].editoption!=e._tableData.colModel[o].editoption){i=!0
break}if(a[o].formatter!=e._tableData.colModel[o].formatter){i=!0
break}}0==i&&(a=[])}}return a},e.prototype._tableToCsv=function(){var e=this,t=$("#"+e._gridElemId),a=t.getGridParam("postData")
a.colModel=t.getGridParam("colModel"),void 0!==a.filters&&a.filters.length>0&&(a._search="true")
var o=t.getGridParam("url").replace(/getGridData$/,"getGridCsv"),l=new XMLHttpRequest
l.open("POST",o),l.setRequestHeader("Content-type","application/json"),l.onreadystatechange=function(){if(4===l.readyState&&200===l.status){var e=JSON.parse(l.responseText)
appxUtil_downloadUrl(appx_session.appxCacheUrl+e.url)}},l.send(JSON.stringify(a))},e.prototype._tableGetRangeKeys=function(e,t,a){var o=this,l=$("#"+o._gridElemId),i=l.getGridParam("postData")
void 0!==i.filters&&i.filters.length>0&&(i._search="true"),i.keyBeg=e,i.keyEnd=t
var r=l.getGridParam("url").replace(/getGridData$/,"getRangeKeys"),s=new XMLHttpRequest
s.open("POST",r),s.setRequestHeader("Content-type","application/json"),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var e=JSON.parse(s.responseText)
a(e)}},s.send(JSON.stringify(i))},e.prototype._clearSelections=function(){var e=this
e.selectedKeys=void 0,e._transData.lastPage=1,e._transData.scrollPosition=0},e.prototype._getSelections=function(){return this.selectedKeys},e.prototype._getPostData=function(){var e,t=this
if("BlankTable"!=t._tableData.datalookupid&&(e={collection:t._tableData.collection,datalookupid:t._tableData.datalookupid,collist:t._tableData.collist,lastSortName:t._prefsData.lastSortName||[],lastSortOrder:t._prefsData.lastSortOrder||[],search:!1,caseSort:t._widgetData.tableCaseSort},t._prefsData.filters&&""!==t._prefsData.filters&&(e.filters=t._prefsData.filters,e.search=!0)),t._transData.tableLoaded===!1&&JSON.stringify(t._prefsData.lastSortName)!==JSON.stringify(["initialSort"])){var a=t.selectedKeys
a&&a.length>0&&(e.findId2=a[0])}return e},e.prototype._updateTableFromGrid=function(e){var t=this,a=$("#"+t._gridElemId),o=[],l=a.jqGrid("getGridParam","colModel")
if(l){for(var i=0;i<l.length;i++)"rn"!==l[i].name&&"cb"!==l[i].name&&o.push($.extend(!0,{},l[i]))
if(t._prefsData.colModel=o,t._transData.scrollPosition=$(e).find(".ui-jqgrid-bdiv").scrollTop(),t._transData.lastPage=Math.floor(t._transData.scrollPosition/1050+1),t._prefsData.lastSortName=[a.jqGrid("getGridParam","sortname")],t._prefsData.lastSortOrder=[a.jqGrid("getGridParam","sortorder")],t._prefsData.colMap=a.jqGrid("getGridParam","remapColumns"),JSON.stringify(t._prefsData.lastSortName)===JSON.stringify(["initialSort"])&&(t._prefsData.lastSortName=void 0),JSON.stringify(t._prefsData.lastSortOrder)===JSON.stringify(["asc"])&&(t._prefsData.lastSortOrder=void 0),void 0!==t._prefsData.colMap&&0!==t._prefsData.colMap.length&&JSON.stringify(t._prefsData.colMap)!==JSON.stringify(t._tableData.colMap)||(t._prefsData.colMap=void 0),t._prefsData.colModel&&t._prefsData.colModel.length===t._tableData.colModel.length){var r=t._prefsData.colModel,s=t._tableData.colModel,n=void 0,d=s.length,p=!1
for(n=0;n<d&&p===!1;n++){var c=Object.getOwnPropertyNames(s[n]),g=void 0,_=c.length
for(g=0;g<_&&p===!1;g++){var u=c[g]
JSON.stringify(r[n][u])!==JSON.stringify(s[n][u])&&(p=!0)}}p===!1&&(t._prefsData.colModel=void 0)}}},e.prototype._getPage=function(){var e=1
return this._transData.reuse===!0||void 0!=this._prefsData.filters?this._transData.lastPage&&(e=this._transData.lastPage):this._tableData.selectedRows&&this._tableData.selectedRows.length>0&&(e=parseInt(""+(1+(this._tableData.selectedRows[0]-1)/50))),e},e.prototype._getScrollPosition=function(){var e=0
if(this._transData.reuse===!0||this._transData.changed!==!0&&void 0==this._prefsData.filters)this._transData.scrollPosition&&(e=this._transData.scrollPosition)
else if(this._tableData.selectedRows&&this._tableData.selectedRows.length>0){var t=$("#"+this._gridElemId),a=t.closest(".ui-jqgrid-bdiv").height(),o=void 0===e||0===e?21:$("#"+t.jqGrid("getGridParam","selrow")).height()
e=(this._tableData.selectedRows[0]-1)*o,e-=(a-o)/2,e<0&&(e=0)}return e<0?0:e},e.prototype._createGridMongo=function(t){var a=this,o=$(t).attr("id")
a._transData.tableLoaded=!1,a._appxElemId=o,a._gridElemId=e._ELEM_TABLE_PREFIX+"_"+o,a._pagerElemId=e._ELEM_PAGER_PREFIX+"_"+o,a._optionElemId=e._ELEM_OPTION_PREFIX+"_"+o,a._gviewElemId="gview_"+a._gridElemId
var l=$("#"+a._appxElemId).css("font-size"),i=parseInt(1.76*parseInt(l)+.5+"px"),r=$(t).width(),s=$(t).height(),n=a._widgetData.tableShowFooterBar===!0?28:0,d=a._widgetData.wLabel&&a._widgetData.wLabel.trim().length>0?i+3:0,p=a._widgetData.tableShowHeading===!0?20:0,c=r-2,g=s-4-n+p+d,_=Math.floor(Math.log(a._tableData.rowCount)*Math.LOG10E+1),u=1==a._widgetData.tableShowRowNumbers?30+10*(Math.max(4,_)-4):0,b=a._tableData.rowCount*i,f=0
$(t).append($('<table id="'+a._gridElemId+'">')),this._widgetData.tableShowFooterBar&&$(t).append($('<div id="'+a._pagerElemId+'" style="height: '+n+'px"></div>'))
for(var h=a.colModel,m=-1,w=u>0?u+e._colAddedWidthPx:0,D=a._tableData.colWidget,v=a._tableData.defaultRowWidget,S=0;S<h.length;S++)D&&D[h[S].name]&&D[h[S].name].widget_data?h[S]=e.setupColModelColumn(h[S],D,a._widgetData):(0==a._widgetData.tableColumnResizable?h[S].resizable=!1:h[S].resizable=!0,0==a._widgetData.tableColumnSortable?h[S].sortable=!1:h[S].sortable=!0),h[S].hidden!==!0&&(h[S].fixed===!0?w+=h[S].width+e._colAddedWidthPx:m=S),v&&v[h[S].name]&&v[h[S].name].widget_data&&(v[h[S].name].widget=appxTableRowWidgetHandler(v[h[S].name].widget_data),v[h[S].name].cellAttribute=appxTableCreateCellAttribute(v[h[S].name].widget),v[h[S].name].widget_data=null),h[S].cellattr=function(e,t,o,l,i){var r=null,s=a._tableData.rowWidget
if(s&&s[e]&&s[e][l.name]&&(s[e][l.name].widget_data||s[e][l.name].widget)){s[e][l.name].widget_data&&(s[e][l.name].widget=appxTableRowWidgetHandler(s[e][l.name].widget_data),s[e][l.name].widget_data=null),r=s[e][l.name].widget
var n=!1
a.selectedKeys.indexOf(e)>=0&&(n=!0)
var d=appxTableCreateCellAttribute(r,n)
return d}return null==r&&v&&v[l.name]&&v[l.name].cellAttribute?a.selectedKeys.indexOf(e)>=0&&(v[l.name].widget.wAltColorBg||v[l.name].widget.wAltColorFg)?appxTableCreateCellAttribute(v[l.name].widget,!0):v[l.name].cellAttribute:null}
b>g&&(f=18),m!==-1&&(h[m].width=c-(w+f+e._colAddedWidthPx),h[m].width<=0&&(h[m].width=1))
var y={}
y.shrinkToFit=!1,y.height=s-4-n-p-d,d>0&&(y.height-=1),0==p&&(y.height+=1),y.width=c,y.scrollOffset=f,y.mtype="POST",y.caption=a._widgetData.wLabel||"",y.colModel=h,y.datatype="json",y.hidegrid=!1,y.multiselect=!0,y.rowList=[10,20,30,40,50],y.scroll=a._getVirtualScroll(),y.viewrecords=!0,y.gridview=!0,y.loadonce=!1,y.scrollrows=!1,y.sortname=(a._prefsData.lastSortName||["initialSort"]).slice(-1)[0],y.sortorder=(a._prefsData.lastSortOrder||["asc"]).slice(-1)[0],y.rownumbers=a._widgetData.tableShowRowNumbers,y.postData=a._getPostData(),y.search=!!(y.postData&&y.postData.filters&&y.postData.filters.length>0),y.rownumWidth=u,y.rowNum=a._prefsData.rowsPerPage||50,y.url=e._getAppxSession().appxDataCacheUrl,y.pager="#"+a._pagerElemId,y.page=a._getPage(),a._widgetData&&0==a._widgetData.tableMovableColumn?y.sortable=!1:y.sortable=function(e){a._columnMoved(this,e)},y.resizeStop=function(e,t){a._columnResized(this,e,t)},y.gridComplete=function(){a._gridComplete(this)},y.loadComplete=function(e){a._loadComplete(this,e)},y.onSelectRow=function(e,t,o){a._onSelectRow(this,e,t,o)},y.beforeSelectRow=function(t,o){return!(a._transData.clickDetect&&Date.now()-a._transData.clickDetect<e._DOUBLE_CLICK_TIMER)&&(a._transData.clickDetect=Date.now(),a._beforeSelectRow(this,t,o))},y.ondblClickRow=function(e,t,o,l){a._onDblClickRow(this,e,t,l)},y.loadBeforeSend=function(e,t){a._loadBeforeSend(this,e,t)}
var C=$("#"+a._gridElemId).jqGrid(y),x=C.jqGrid("getGridParam","postData")
x&&(a._prefsData.filters&&a._prefsData.filters.length>0?(x.search=!0,x.filters=a._prefsData.filters):(x.search=!1,x.filters=void 0)),C.jqGrid("hideCol","cb")
for(var S=0;S<a.colModel.length;S++)if(a.colModel[S].align&&C.jqGrid("setLabel",a.colModel[S].name,"",{"text-align":a.colModel[S].align}),D&&D[a.colModel[S].name]&&D[a.colModel[S].name].widget){var T=D[a.colModel[S].name].widget,M=$("#jqgh_"+a._gridElemId+"_"+a.colModel[S].name)
appxTableApplyColumnStyle(T,M)}var E={left:"",top:"",drag:!0,multipleSearch:!0,searchOnEnter:!0,closeAfterSearch:!0,closeOnEscape:!0,stringResult:!0,beforeShowSearch:function(){var e=$(".ui-jqdialog"),t=(r-e.width())/2,a=(s-e.height())/2
return e.css("left",t+"px").css("top",a+"px"),!0}},I=!0
0==a._widgetData.tableShowTableSearch&&(I=!1)
var k=!0
if(0==a._widgetData.tableShowTableRefresh&&(k=!1),C.jqGrid("navGrid","#"+a._pagerElemId,{edit:!1,add:!1,del:!1,refresh:k,search:I,beforeRefresh:function(){a._clearSelections(),a._prefsData.filters=void 0}},{},{},{},E),e._addButtonsToFooter(a,o),d>0&&$("#"+a._gviewElemId+" .ui-jqgrid-titlebar").css("height",d+"px"),0==this._widgetData.tableShowHeading){var P=document.querySelector("#"+a._gviewElemId+" > .ui-jqgrid-hdiv")
null!=P&&(P.style.display="none")}0==this._widgetData.wEnabled&&$("#"+this._gridElemId).addClass("jqgrid-disabled-widget"),$("#newtablewidget_"+o).closest(".appxbox").hasClass("appx-not-modifiable")&&$("#newtablewidget_"+o).closest(".ui-jqgrid").block({message:null,overlayCSS:{backgroundColor:"#000",opacity:0,cursor:null}})},e.prototype._beforeSelectRow=function(t,a,o){var l=this
if(o.ctrlKey===!1&&o.metaKey===!1&&o.shiftKey===!1)$(t).jqGrid("resetSelection"),l.selectedKeys=[]
else if(o.shiftKey){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()
var i=l.selectedKeys&&l.selectedKeys.length>0?l.selectedKeys[l.selectedKeys.length-1]:void 0
return l._tableGetRangeKeys(i,a,function(a){$(t).jqGrid("resetSelection"),l.selectedKeys=[],a.keys.forEach(function(e){$(t).jqGrid("setSelection",e,!1),l.selectedKeys.push(e)}),void 0==l._transData.clickTimer&&null!=l._widgetData.wCommand&&l._widgetData.wCommand>=0&&$(t).closest(".appxbox").hasClass("appx-not-modifiable")===!1&&appxIsLocked()===!1&&(l._transData.clickTimer=setTimeout(function(){l._transData.clickTimer=void 0,appxwidgetcallback(l._widgetData.wCommand)},e._DOUBLE_CLICK_TIMER))}),!1}return!0},e.prototype._onSelectRow=function(t,a,o,l){for(var i,r=this,s=0;s<t.rows[a].cells.length;s++)i=t.rows[a].cells[s],o&&null!=i.getAttribute("altBgColor")?i.style["background-color"]=i.getAttribute("altBgColor"):i.style["background-color"]=i.getAttribute("bgColor"),o&&null!=i.getAttribute("altFgColor")?i.style.color=i.getAttribute("altFgColor"):i.style.color=i.getAttribute("fgColor")
o?r.selectedKeys.push(a):r.selectedKeys=r.selectedKeys.filter(function(e){return e!==a}),void 0==r._transData.clickTimer&&null!=r._widgetData.wCommand&&r._widgetData.wCommand>=0&&$(t).closest(".appxbox").hasClass("appx-not-modifiable")===!1&&appxIsLocked()===!1&&(r._transData.clickTimer=setTimeout(function(){r._transData.clickTimer=void 0,appxwidgetcallback(r._widgetData.wCommand)},e._DOUBLE_CLICK_TIMER))},e.prototype._onDblClickRow=function(e,t,a,o){var l=this
l._transData.clickTimer&&(clearTimeout(l._transData.clickTimer),l._transData.clickTimer=void 0),null!=l._widgetData.wCommand2&&l._widgetData.wCommand2>=0&&$(e).closest(".appxbox").hasClass("appx-not-modifiable")===!1&&appxIsLocked()===!1&&appxwidgetcallback(l._widgetData.wCommand2)},e.prototype._columnMoved=function(e,t){this._prefsData.colMap=t},e.prototype._columnResized=function(e,t,a){this._prefsData.colModel=$(e).jqGrid("getGridParam","colModel"),this._prefsData.colModel[a]&&(this._prefsData.colModel[a].widthOrg=t)},e.prototype._gridComplete=function(e){var t=this,a=(t.selectedKeys,t._widgetData),o=$("#"+t._appxElemId).css("font-size"),l=$("#"+t._appxElemId).css("line-height")
if(t._adjustGridIconColors(),$("#"+t._gviewElemId+" div").not(".appx-fontsize-adjusted").css({"font-size":o,"line-height":l,"padding-top":"0px","padding-bottom":"0px"}),a){var i={}
if(a.wFontStyle){switch(a.wFontStyle){case"bold":i["font-weight"]="bold"
break
case"italic":i["font-style"]="italic"
break
case"bolditalic":i["font-weight"]="bold",i["font-style"]="italic"}$.isEmptyObject(i)||$("#"+t._gridElemId+" td").not(".appx-fontstyle-adjusted").css(i)}var r=null
if(i={},a.wFont){switch(a.wFont){case"helvetica":r="default"
break
case"Courier":r="courier"
break
case"Helvetica":r="arial"
break
case"TimesRoman":r="times-roman"
break
case"Dialog":r="fixed-sys"
break
case"DialogInput":r="terminal"
break
case"ZapfDingbats":r="wingdings"
break
case"SanSerif":r="ms-sans-serif"
break
case"Serif":r="ms-serif"
break
case"Monospaced":r="fixed-sys"}null==r&&(i["font-family"]=a.wFont)}if($.isEmptyObject(i)||$("#"+t._gridElemId+" td").not(".appx-font-adjusted").css(i),null!=r&&$("#"+t._gridElemId+" td").not(".appx-font-adjusted").addClass("appx-font-"+r),a.wColorFg||a.wColorFgNL){var s="."+t._gridElemId+"-fgColorClass {",n=document.head||document.getElementsByTagName("head")[0],d=document.getElementById("appx-dynamic-style")
null==d&&(d=document.createElement("style"),d.type="text/css",d.id="appx-dynamic-style"),a.wColorFg&&(s+=" color:"+a.wColorFg,a.wColorFgNL&&(s+=(255*a.wColorBgNL).toString(16)),s+=";"),s+="}",n.appendChild(d),d.appendChild(document.createTextNode(s)),$("#"+t._gridElemId+" tr").not(".appx-fgcolor-adjusted").addClass(t._gridElemId+"-fgColorClass")}if(a.wColorBgNL||a.wColorBg){i={}
var s="."+t._gridElemId+"-bgClass {",n=document.head||document.getElementsByTagName("head")[0],d=document.getElementById("appx-dynamic-style")
null==d&&(d=document.createElement("style"),d.type="text/css",d.id="appx-dynamic-style"),a.wColorBg&&(s+=" background-color:"+a.wColorBg+";",s+=" background-image: none;",i["background-color"]=a.wColorBg),a.wColorBgNL&&(s+=" opacity:"+a.wColorBgNL+";",i.opacity=a.wColorBgNL),s+="}",n.appendChild(d),d.appendChild(document.createTextNode(s)),$("#"+t._gridElemId+" tr").not(".appx-bgcolor-adjusted").addClass(t._gridElemId+"-bgClass"),$("#"+t._gviewElemId+" .ui-jqgrid-bdiv").css(i)}}},e.prototype._loadBeforeSend=function(e,t,a){var o=this,l=$("#"+o._gridElemId),i=l.jqGrid("getGridParam","postData")
i?(JSON.stringify(i.filters)!==JSON.stringify(o._prefsData.filters)&&o._clearSelections(),o._prefsData.filters=i.filters):o._prefsData.filters=void 0,o._transData.tableLoaded||(o._transData.pendingXHR++,appxSetStatusStateText(APPX_STATE_BUSY))},e.prototype._loadComplete=function(e,t){var a=this,o=a.selectedKeys
$(e).jqGrid("resetSelection")
for(var l=0;l<o.length;l++)$(e).jqGrid("setSelection",o[l],!1)
a._transData.tableLoaded||setTimeout(function(){if(a._transData.pendingXHR--,0==a._transData.pendingXHR&&appx_session.pendingTables>0){if(a._transData.tableLoaded=!0,appx_session.pendingTables--,t.findId2RowNo&&a._tableData.selectedRows)if(t.findId2RowNo===-1)a._clearSelections()
else{a._tableData.selectedRows[0]=t.findId2RowNo
var l=$("#"+a._gridElemId).getGridParam("page")
$("#"+a._gridElemId).jqGrid("getInd",o[0])===!1&&l!==a._getPage()&&($("#"+a._gridElemId).setGridParam({page:a._getPage()}),a._reloadGrid())}$(e).closest(".ui-jqgrid-bdiv").scrollTop(a._getScrollPosition())}0===appx_session.pendingTables&&0===appx_session.pendingResources.length&&(0!==Math.abs(appx_session.current_show.curraction[0]&M_WAIT)&&appxSetStatusStateText(APPX_STATE_READY),screenflipped||appxshowscreen())},500)},e.prototype._toggleVirtualScroll=function(){var e=this
return e._setVirtualScroll(1===e._getVirtualScroll()?0:1),e._getVirtualScroll()},e.prototype._getVirtualScroll=function(){var t=this._prefsData.virtualScroll
return void 0==t&&(t=e._getPropVirtualScroll()),t},e.prototype._setVirtualScroll=function(t){void 0===t||null===t?this._prefsData.virtualScroll=void 0:t>0?this._prefsData.virtualScroll=1:this._prefsData.virtualScroll=0,e._getPropVirtualScroll()===this._prefsData.virtualScroll&&(this._prefsData.virtualScroll=void 0)},Object.defineProperty(e.prototype,"colModel",{get:function(){return void 0!==this._prefsData.colModel?this._prefsData.colModel:this._tableData.colModel},set:function(e){this._prefsData.colModel=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selectedKeys",{get:function(){return void 0!==this._transData.selectedKeys?this._transData.selectedKeys:this._tableData.selectedKeys},set:function(e){this._transData.selectedKeys=e},enumerable:!0,configurable:!0}),e.USE_NEW_CODE=!0,e._initialized=!1,e._colAddedWidthPx=0,e._rowTotalHeightPx=19,e._ELEM_TABLE_PREFIX="newtablewidget",e._ELEM_PAGER_PREFIX="pager",e._ELEM_OPTION_PREFIX="option",e._DOUBLE_CLICK_TIMER=500,e.setupColModelColumn=function(e,t,a){var o=appxTableColumnWidgetHandler(t[e.name].widget_data)
t[e.name].widget=o.widget
var l=o.widget
if(null!=l.wLabel&&""!=l.wLabel?e.label=l.wLabel:e.label=t[e.name].oLabel,null!=l.wTooltip&&""!=l.wTooltip?e.tooltip=l.wTooltip:e.tooltip="",e.oHidden=e.hidden,null!=l.wVisible&&0==l.wVisible?e.hidden=!0:null!=l.wVisible&&1==l.wVisible&&(e.hidden=!1),e.WidetChangedHidden=!(e.hidden==e.oHidden),null!=l.tableColumnSortable&&0==l.tableColumnSortable?e.sortable=!1:null!=l.tableColumnSortable&&1==l.tableColumnSortable?e.sortable=!0:a&&0==a.tableColumnSortable?e.sortable=!1:e.sortable=!0,null!=l.tableColumnSortType&&""!=l.tableColumnSortType&&(e.sorttype=l.tableColumnSortType),null!=l.tableColumnDateFormat&&""!=l.tableColumnDateFormat&&(e.datefmt=l.tableColumnDateFormat,e.editrules={date:!0}),null!=l.tableColumnResizable&&0==l.tableColumnResizable?e.resizable=!1:null!=l.tableColumnResizable&&1==l.tableColumnResizable?e.resizable=!0:a&&0==a.tableColumnResizable?e.resizable=!1:e.resizable=!0,null!=l.tableColumnSearchable&&0==l.tableColumnSearchable?e.search=!1:e.search=!0,null!=l.wClasses&&""!=l.wClasses?e.classes=l.wClasses:e.classes="",o.tag.css("width")){var i=parseInt(o.tag.css("width").split("px")[0])
null!=i&&i>0&&(e.width=i)}return e},e.checkboxFormatter=function(e,t,a){var o="<label class='checkbox-label' onclick='return false;' style='width:unset; top:unset; left:unset; padding-right:8px; margin-right:4px;'>"
return o+="<input type='checkbox' disabled=true value='",o+=e,o+="'","Y"!=e&&"y"!=e&&1!=e||(o+=" checked='checked'"),o+="/><span class='checkbox-custom rectangular' style='top:unset; left:unset;'></span></label>"},e.checkboxUnFormatter=function(e,t,a){return $("input[type=checkbox]",a).val()},e.updateColModelFormatter=function(t,a){for(var o=a._tableData.colModel,l=0;l<t.length;l++)if(t[l].formatter)(t[l].formatter="checkbox")&&(t[l].formatter=e.checkboxFormatter,t[l].unformat=e.checkboxUnFormatter)
else for(var i=0;i<o.length;i++)if(o[i].name==t[l].name){t[l].formatter=o[i].formatter,t[l].unformat=o[i].unformat
break}},e}()
